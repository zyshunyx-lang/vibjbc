<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åå°ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; }
        button { padding: 10px 20px; cursor: pointer; background: #1890ff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #40a9ff; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .section { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        #status { color: green; font-weight: bold; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div id="loginBox" class="card" style="text-align:center; margin-top:50px;">
        <h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
        <input type="password" id="adminPass" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç " style="max-width:300px;">
        <br>
        <button onclick="app.login()">ç™»å½•åå°</button>
    </div>

    <div id="adminPanel" style="display:none;">
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h2>âš™ï¸ æ•°æ®æ§åˆ¶å°</h2>
                <button onclick="location.href='index.html'" style="background:#52c41a">å‰å¾€å‰å°é¢„è§ˆ</button>
            </div>
            <div id="status"></div>

            <div class="section">
                <h3>ğŸ“¢ æ»šåŠ¨å…¬å‘Šè®¾ç½®</h3>
                <input id="noticeInput" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹...">
                <button onclick="app.saveNotice()">å‘å¸ƒå…¬å‘Š</button>
                <button onclick="app.clearNotice()" style="background:#ff4d4f; margin-left:10px;">æ¸…ç©ºå…¬å‘Š</button>
            </div>

            <div class="section">
                <h3>ğŸ“¥ Excel æ’ç­è¡¨å¯¼å…¥</h3>
                <p style="font-size:12px; color:#666">Excel åˆ—åéœ€åŒ…å«ï¼šæ—¥æœŸ, å¸¦ç­é¢†å¯¼, å¥³å€¼ç­å‘˜, ç”·å€¼ç­å‘˜, å¤‡æ³¨</p>
                <input type="file" id="fileInput" accept=".xlsx">
                <button onclick="app.uploadExcel()">å¼€å§‹å¯¼å…¥</button>
            </div>

            <div class="section">
                <h3>ğŸ” ä¿®æ”¹ç³»ç»Ÿå¯†ç </h3>
                <input id="newAdmin" placeholder="æ–°Â·ç®¡ç†å‘˜å¯†ç ">
                <input id="newView" placeholder="æ–°Â·æŸ¥çœ‹å¯†ç ">
                <button onclick="app.changePass()">æ›´æ–°å¯†ç </button>
            </div>
        </div>
    </div>

<script>
window.app = {
    api: '/.netlify/functions/api',
    token: null,
    data: { schedules:{}, personnel:{} },

    async login() {
        const p = document.getElementById('adminPass').value;
        try {
            const res = await fetch(this.api, { method:'POST', body:JSON.stringify({ action:'login', password:p }) });
            const json = await res.json();
            if(json.role === 'admin') {
                this.token = p;
                this.data = json.data || {};
                if(!this.data.schedules) this.data.schedules = {};
                document.getElementById('loginBox').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('noticeInput').value = this.data.notice || '';
            } else { alert("å¯†ç é”™è¯¯æˆ–æƒé™ä¸è¶³"); }
        } catch(e) { alert("ç½‘ç»œè¿æ¥å¤±è´¥"); }
    },

    async save() {
        const res = await fetch(this.api, { method:'POST', body:JSON.stringify({ action:'save', password:this.token, newData:this.data }) });
        const j = await res.json();
        if(j.success) {
            document.getElementById('status').innerText = `âœ… ä¿å­˜æˆåŠŸ (${new Date().toLocaleTimeString()})`;
            setTimeout(()=>document.getElementById('status').innerText='', 3000);
        } else { alert("ä¿å­˜å¤±è´¥"); }
    },

    saveNotice() {
        this.data.notice = document.getElementById('noticeInput').value;
        this.save();
    },
    clearNotice() {
        this.data.notice = "";
        document.getElementById('noticeInput').value = "";
        this.save();
    },

    changePass() {
        const na = document.getElementById('newAdmin').value;
        const nv = document.getElementById('newView').value;
        if(confirm('ç¡®å®šä¿®æ”¹å¯†ç ï¼Ÿ')) {
            fetch(this.api, { method:'POST', body:JSON.stringify({ action:'change_pass', password:this.token, newAdminPass:na, newViewPass:nv }) })
            .then(r=>r.json()).then(j=>{ if(j.success) alert('ä¿®æ”¹æˆåŠŸ'); });
        }
    },

    uploadExcel() {
        const f = document.getElementById('fileInput').files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            let c = 0;
            rows.forEach(row => {
                let date = row['æ—¥æœŸ'] || row['Date'];
                if(typeof date === 'number') date = new Date(Math.round((date - 25569)*86400*1000)).toISOString().split('T')[0];
                if(date) {
                    this.data.schedules[date] = {
                        leader: row['å¸¦ç­é¢†å¯¼']||'', female: row['å¥³å€¼ç­å‘˜']||'', male: row['ç”·å€¼ç­å‘˜']||'', remark: row['å¤‡æ³¨']||''
                    };
                    c++;
                }
            });
            this.save();
            alert(`å·²å¯¼å…¥ ${c} æ¡æ•°æ®`);
        };
        r.readAsArrayBuffer(f);
    }
};
</script>
</body>
</html>
