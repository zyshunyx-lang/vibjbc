<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åå°ç®¡ç†æ§åˆ¶å° (V23 å¯è§†åŒ–ç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #4f46e5; --bg: #f3f4f6; --surface: #ffffff; 
            --text: #111827; --border: #e5e7eb;
            --holiday-bg: #fef2f2; --holiday-text: #dc2626;
            --leader-bg: #eef2ff; --leader-text: #3730a3;
            --female-bg: #fdf2f8; --female-text: #be185d;
            --male-bg: #f0fdf4;   --male-text: #166534;
        }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        
        .container { width: 100%; max-width: 1100px; }
        .card { background: var(--surface); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 20px; overflow: hidden; }
        .card-body { padding: 20px; }

        /* ç™»å½•å±‚ */
        #loginBox { max-width: 400px; margin: 100px auto; text-align: center; padding: 40px; }
        input, select, textarea { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-size: 14px; }

        /* æŒ‰é’®ç»„ */
        button { cursor: pointer; padding: 8px 16px; border-radius: 6px; border: 1px solid #d1d5db; background: white; font-size: 13px; font-weight: 500; transition: 0.2s; }
        button:hover { background: #f9fafb; }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.primary:hover { background: #4338ca; }
        button.success { background: #10b981; color: white; border-color: #10b981; }
        button.success:hover { background: #059669; }
        button.danger { color: #dc2626; border-color: #fecaca; background: #fef2f2; }
        button.standby { width: 100%; margin-top: 5px; background: #fff7ed; color: #c2410c; border-color: #fed7aa; }
        
        /* Tab å¯¼èˆª */
        .nav-tabs { display: flex; gap: 15px; border-bottom: 1px solid var(--border); margin-bottom: 20px; background: #f9fafb; padding: 0 20px; }
        .nav-item { padding: 15px 5px; cursor: pointer; color: #6b7280; font-weight: 600; border-bottom: 2px solid transparent; font-size: 14px; }
        .nav-item.active { color: var(--primary); border-color: var(--primary); }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* === æœˆå†è§†å›¾æ ¸å¿ƒæ ·å¼ === */
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .cal-head { background: #f8fafc; padding: 10px; text-align: center; font-weight: 600; color: #64748b; font-size: 13px; }
        .cal-cell { background: white; min-height: 120px; padding: 8px; display: flex; flex-direction: column; gap: 3px; cursor: pointer; transition: 0.1s; }
        .cal-cell:hover { background: #f8fafc; }
        .cal-cell.holiday { background: var(--holiday-bg); }
        .cal-cell.empty { background: #f9fafb; cursor: default; pointer-events: none; }
        
        .date-num { font-weight: 700; font-size: 14px; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .holiday-tag { color: var(--holiday-text); font-weight: normal; font-size: 11px; }
        
        .duty-pill { font-size: 11px; padding: 3px 6px; border-radius: 4px; font-weight: 500; margin-bottom: 2px; display: flex; gap: 5px; }
        .pill-l { background: var(--leader-bg); color: var(--leader-text); }
        .pill-f { background: var(--female-bg); color: var(--female-text); }
        .pill-m { background: var(--male-bg); color: var(--male-text); }
        .remark-text { font-size: 11px; color: #c2410c; border-top: 1px dashed #e5e7eb; margin-top: auto; padding-top: 4px; }

        /* è¡¨æ ¼ä¸å¼¹çª— */
        .table-wrap { border: 1px solid var(--border); border-radius: 6px; overflow: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; }
        th { background: #f9fafb; position: sticky; top: 0; }
        
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-card { background: white; width: 450px; border-radius: 12px; padding: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .standby-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        
        #statusMsg { position: fixed; top: 20px; right: 20px; padding: 12px 24px; background: #ecfdf5; color: #065f46; border-radius: 6px; border: 1px solid #a7f3d0; display: none; z-index: 999; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div id="statusMsg">âœ… æ“ä½œæˆåŠŸ</div>

<div id="loginBox" class="card" style="display:block;">
    <h2 style="color:var(--primary);">ğŸ” åå°ç®¡ç†</h2>
    <input type="password" id="adminPass" placeholder="è¾“å…¥ç®¡ç†å¯†ç  (é»˜è®¤ admin888)" style="text-align:center;">
    <button class="primary" style="width:100%; margin-top:10px;" onclick="app.login()">éªŒè¯è¿›å…¥</button>
</div>

<div id="adminPanel" class="container" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0; color:var(--primary);">âš™ï¸ å€¼ç­ç®¡ç†æ§åˆ¶å°</h2>
        <div>
            <button onclick="window.open('index.html', '_blank')">â†— é¢„è§ˆå‰å°</button>
            <button class="danger" onclick="location.reload()">é€€å‡º</button>
        </div>
    </div>

    <div class="card">
        <div class="nav-tabs">
            <div class="nav-item active" onclick="app.switchTab(this, 'tab-cal')">ğŸ“… æœˆå†/å‘å¸ƒ</div>
            <div class="nav-item" onclick="app.switchTab(this, 'tab-rules')">âš¡ ç”Ÿæˆè§„åˆ™</div>
            <div class="nav-item" onclick="app.switchTab(this, 'tab-person')">ğŸ‘¥ äººå‘˜ç®¡ç†</div>
            <div class="nav-item" onclick="app.switchTab(this, 'tab-holiday')">ğŸ“… å‡æ—¥å®šä¹‰</div>
            <div class="nav-item" onclick="app.switchTab(this, 'tab-data')">ğŸ’¾ æ•°æ®ä¸å®‰å…¨</div>
        </div>

        <div class="card-body">
            <div id="tab-cal" class="tab-pane active">
                <div class="calendar-controls">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button onclick="app.changeMonth(-1)">â—€</button>
                        <input type="month" id="calMonthPicker" style="width:auto; margin:0; font-weight:bold;" onchange="app.onMonthPick()">
                        <button onclick="app.changeMonth(1)">â–¶</button>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <div style="background:#fff7ed; color:#c2410c; padding:5px 10px; border-radius:6px; font-size:12px; border:1px solid #fed7aa; display:flex; align-items:center;">
                            ğŸ“¢ å…¬å‘Š: <input id="noticeInput" style="border:none; background:transparent; width:150px; margin:0; font-size:12px; color:#c2410c;" placeholder="ç‚¹å‡»è¾“å…¥æ»šåŠ¨å…¬å‘Š...">
                        </div>
                        <button class="success" onclick="app.publish()">â˜ï¸ å‘å¸ƒ/æ›´æ–°åˆ°å‰å°</button>
                    </div>
                </div>
                
                <div class="cal-grid" id="calGrid"></div>
            </div>

            <div id="tab-rules" class="tab-pane">
                <div style="background:#eff6ff; padding:15px; border-radius:8px; margin-bottom:20px; font-size:13px; color:#1e40af;">
                    <strong>â„¹ï¸ è§„åˆ™è¯´æ˜ï¼š</strong> 
                    1. <strong>åŒè½¨åˆ¶</strong>ï¼šå¸¦ç­é¢†å¯¼åˆ†ä¸ºã€å·¥ä½œæ—¥ã€‘ä¸ã€å‡æ—¥ã€‘ä¸¤æ¡ç‹¬ç«‹é˜Ÿåˆ—è½®è½¬ã€‚
                    2. <strong>å‡æ—¥è¯†åˆ«</strong>ï¼šç”Ÿæˆæ—¶ä¼šè‡ªåŠ¨é¿å¼€â€œå‡æ—¥å®šä¹‰â€ä¸­è®¾ç½®çš„æ—¥æœŸã€‚
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div><label>å¸¦ç­é¢†å¯¼ (å·¥ä½œæ—¥) èµ·å§‹</label><select id="startLeaderW"></select></div>
                    <div><label>å¸¦ç­é¢†å¯¼ (å‡æ—¥) èµ·å§‹</label><select id="startLeaderH"></select></div>
                    <div><label>å¥³å€¼ç­å‘˜ èµ·å§‹</label><select id="startFemale"></select></div>
                    <div><label>ç”·å€¼ç­å‘˜ èµ·å§‹</label><select id="startMale"></select></div>
                </div>
                <button class="primary" style="width:100%; padding:12px;" onclick="app.generate()">âš¡ æŒ‰ç…§å½“å‰è§„åˆ™ç”Ÿæˆè¯¥æœˆæ’ç­</button>
            </div>

            <div id="tab-person" class="tab-pane">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <select id="manageType" style="width:120px;" onchange="app.renderPersonList()">
                        <option value="leader">å¸¦ç­é¢†å¯¼</option>
                        <option value="female">å¥³å€¼ç­å‘˜</option>
                        <option value="male">ç”·å€¼ç­å‘˜</option>
                    </select>
                    <div style="display:flex; gap:5px;">
                        <input type="file" id="uploadPerson" hidden onchange="app.importExcel(this, 'person')">
                        <button onclick="document.getElementById('uploadPerson').click()">â¬† å¯¼å…¥Excel</button>
                        <button class="primary" onclick="app.editPerson()">+ æ·»åŠ äººå‘˜</button>
                    </div>
                </div>
                <div id="personList" class="table-wrap"></div>
            </div>

            <div id="tab-holiday" class="tab-pane">
                <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
                    <input type="number" id="hYear" style="width:80px; margin:0;" placeholder="å¹´ä»½" onchange="app.renderHoliday()">
                    <span>å¹´çš„å‡æ—¥ï¼š</span>
                    <input type="date" id="hStart" style="width:auto; margin:0;"> è‡³ <input type="date" id="hEnd" style="width:auto; margin:0;">
                    <button class="primary" onclick="app.addHolidayRange()">+ æ·»åŠ åŒºé—´</button>
                </div>
                <div id="holidayChips" style="display:flex; flex-wrap:wrap; gap:8px; padding:15px; border:1px solid #e5e7eb; border-radius:8px; min-height:100px;"></div>
            </div>

            <div id="tab-data" class="tab-pane">
                <h3>ğŸ” ä¿®æ”¹å¯†ç </h3>
                <div style="display:flex; gap:10px;">
                    <input id="newAdmin" placeholder="æ–°Â·ç®¡ç†å¯†ç ">
                    <input id="newView" placeholder="æ–°Â·æŸ¥çœ‹å¯†ç ">
                    <button class="primary" onclick="app.changePass()">ä¿®æ”¹</button>
                </div>
                <hr>
                <h3>ğŸ’¾ å¤‡ä»½</h3>
                <button class="success" onclick="app.exportGlobalData()">ğŸ“¥ ä¸‹è½½å…¨é‡æ•°æ®å¤‡ä»½ (.json)</button>
            </div>
        </div>
    </div>
</div>

<div id="swapModal" class="modal-overlay">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h3 style="margin:0;" id="swapTitle">æ’ç­è°ƒæ•´</h3>
            <button onclick="document.getElementById('swapModal').style.display='none'">Ã—</button>
        </div>
        <input type="hidden" id="swapDate">
        <input type="hidden" id="swapIsH">
        
        <div style="background:#fff7ed; border:1px solid #fed7aa; padding:10px; border-radius:6px; margin-bottom:15px;">
            <div style="font-size:12px; color:#c2410c; font-weight:bold; margin-bottom:5px;">ğŸš‘ å¤‡å‹¤äººå‘˜æ±  (ç‚¹å‡»ç›´æ¥åº”ç”¨)</div>
            <div class="standby-grid" id="standbyPool"></div>
        </div>

        <label>å¸¦ç­é¢†å¯¼</label><select id="swapLeader"></select>
        <label>å¥³å€¼ç­å‘˜</label><select id="swapFemale"></select>
        <label>ç”·å€¼ç­å‘˜</label><select id="swapMale"></select>
        <label>å¤‡æ³¨</label><textarea id="swapRemark" rows="2"></textarea>
        
        <button class="primary" style="width:100%; margin-top:10px;" onclick="app.saveSwap()">ä¿å­˜å˜æ›´</button>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-card">
        <h3>ç¼–è¾‘äººå‘˜</h3>
        <input type="hidden" id="editType"><input type="hidden" id="editId">
        <label>å§“å</label><input id="pName">
        <label>æ‰‹æœº</label><input id="pPhone">
        <label>å¤‡æ³¨</label><textarea id="pRemark"></textarea>
        <div style="text-align:right; margin-top:10px;">
            <button onclick="document.getElementById('editModal').style.display='none'">å–æ¶ˆ</button>
            <button class="primary" onclick="app.savePerson()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
window.app = {
    api: '/.netlify/functions/api',
    token: null,
    data: { personnel: {leader:[], female:[], male:[]}, holidays: {}, schedules: {}, notice: "" },
    viewY: new Date().getFullYear(),
    viewM: new Date().getMonth() + 1,
    standbyUsed: [], // æš‚å­˜æœ¬æ¬¡ä¼šè¯çš„å¤‡å‹¤è®°å½•

    // --- 1. åˆå§‹åŒ–ä¸ç™»å½• ---
    init() { 
        document.getElementById('hYear').value = this.viewY; 
        this.updateDatePicker();
    },
    async login() {
        const p = document.getElementById('adminPass').value;
        if(!p) return;
        try {
            const res = await fetch(this.api, { method:'POST', body:JSON.stringify({action:'login', password:p}) });
            const json = await res.json();
            if(json.role === 'admin') {
                this.token = p;
                if(json.data) this.data = { ...this.data, ...json.data };
                // å®¹é”™åˆå§‹åŒ–
                ['leader','female','male'].forEach(k => { if(!this.data.personnel[k]) this.data.personnel[k]=[]; });
                if(!this.data.holidays) this.data.holidays = {};
                if(!this.data.schedules) this.data.schedules = {};

                document.getElementById('loginBox').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                
                document.getElementById('noticeInput').value = this.data.notice || "";
                this.renderCal();
                this.renderPersonList();
                this.renderHoliday();
                this.updateGenSelects();
                this.msg('ç™»å½•æˆåŠŸ');
            } else { alert('å¯†ç é”™è¯¯'); }
        } catch(e) { alert('ç½‘ç»œè¿æ¥å¤±è´¥'); }
    },

    // --- 2. æ ¸å¿ƒå‘å¸ƒä¸ä¿å­˜ ---
    async save() {
        // æ¯æ¬¡ä¿®æ”¹æ•°æ®éƒ½é™é»˜ä¿å­˜
        try {
            await fetch(this.api, { method:'POST', body:JSON.stringify({action:'save', password:this.token, newData:this.data}) });
        } catch(e) { console.error("Auto-save failed"); }
    },
    async publish() {
        // æ˜¾å¼å‘å¸ƒï¼šæ›´æ–°å…¬å‘Š + å¼ºåˆ¶ä¿å­˜
        this.data.notice = document.getElementById('noticeInput').value;
        try {
            const res = await fetch(this.api, { method:'POST', body:JSON.stringify({action:'save', password:this.token, newData:this.data}) });
            const j = await res.json();
            if(j.success) this.msg("âœ… å·²æˆåŠŸå‘å¸ƒåˆ°å‰å°ï¼");
            else alert("å‘å¸ƒå¤±è´¥");
        } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
    },
    msg(t) { const d=document.getElementById('statusMsg'); d.innerText=t; d.style.display='block'; setTimeout(()=>d.style.display='none', 2000); },

    // --- 3. æœˆå†è§†å›¾ (å¤åˆ» V20) ---
    updateDatePicker() { document.getElementById('calMonthPicker').value = `${this.viewY}-${String(this.viewM).padStart(2,'0')}`; },
    onMonthPick() { const [y,m]=document.getElementById('calMonthPicker').value.split('-'); this.viewY=+y; this.viewM=+m; this.renderCal(); },
    changeMonth(d) { let m=this.viewM+d, y=this.viewY; if(m>12){m=1;y++} if(m<1){m=12;y--} this.viewY=y; this.viewM=m; this.updateDatePicker(); this.renderCal(); },

    renderCal() {
        const grid = document.getElementById('calGrid'); grid.innerHTML = '';
        const heads = ['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'];
        heads.forEach(h => grid.innerHTML += `<div class="cal-head">${h}</div>`);
        
        const first = new Date(this.viewY, this.viewM-1, 1);
        const last = new Date(this.viewY, this.viewM, 0);
        const days = last.getDate();
        const startOff = (first.getDay() + 6) % 7;
        
        for(let i=0; i<startOff; i++) grid.innerHTML += `<div class="cal-cell empty"></div>`;
        
        const hList = this.data.holidays[String(this.viewY)] || []; // ä¿®å¤ï¼šå¼ºåˆ¶è½¬String Key
        const mKey = `${this.viewY}-${String(this.viewM).padStart(2,'0')}`;
        
        for(let d=1; d<=days; d++) {
            const ds = `${mKey}-${String(d).padStart(2,'0')}`;
            const isH = hList.includes(ds);
            const s = this.data.schedules[ds];
            
            let html = `<div class="date-num"><span>${d}</span>${isH?'<span class="holiday-tag">ä¼‘</span>':''}</div>`;
            if(s) {
                html += `<div class="duty-pill pill-l">å¸¦: ${s.leader}</div>
                         <div class="duty-pill pill-f">å¥³: ${s.female}</div>
                         <div class="duty-pill pill-m">ç”·: ${s.male}</div>`;
                if(s.remark) html += `<div class="remark-text">${s.remark}</div>`;
            }
            
            const cell = document.createElement('div');
            cell.className = `cal-cell ${isH?'holiday':''}`;
            cell.innerHTML = html;
            cell.onclick = () => this.openSwap(ds, isH);
            grid.appendChild(cell);
        }
    },

    // --- 4. æ¢ç­ä¸å¤‡å‹¤ (æ ¸å¿ƒé€»è¾‘) ---
    openSwap(ds, isH) {
        document.getElementById('swapModal').style.display = 'block';
        document.getElementById('swapTitle').innerText = `è°ƒæ•´ ${ds} (${isH?'å‡æ—¥':'å·¥ä½œæ—¥'})`;
        document.getElementById('swapDate').value = ds;
        document.getElementById('swapIsH').value = isH;
        
        const s = this.data.schedules[ds] || {leader:'', female:'', male:'', remark:''};
        
        // å¡«å……ä¸‹æ‹‰æ¡†
        const fill = (id, t, v) => document.getElementById(id).innerHTML = `<option value="">(ç©º)</option>` + 
            this.data.personnel[t].map(p => `<option value="${p.name}" ${p.name===v?'selected':''}>${p.name}</option>`).join('');
        fill('swapLeader', 'leader', s.leader);
        fill('swapFemale', 'female', s.female);
        fill('swapMale', 'male', s.male);
        document.getElementById('swapRemark').value = s.remark;
        
        // ç”Ÿæˆå¤‡å‹¤æ±  (ç®€å•çš„ç®—æ³•ï¼šå–å„é˜Ÿåˆ—çš„å‰4äººä½œä¸ºå¤‡å‹¤å€™é€‰)
        // è¿™é‡Œçš„â€œå‰4äººâ€æ˜¯åŸºäºå½“å‰é˜Ÿåˆ—é¡ºåºçš„ï¼ŒV20é‡Œæœ‰æ›´å¤æ‚çš„calculateStandbyPool
        // è¿™é‡Œç®€åŒ–ä¸ºï¼šæ˜¾ç¤ºæ‰€æœ‰äººï¼Œä½†åœ¨åå­—å‰åŠ ä¸ªå›¾æ ‡
        const pool = document.getElementById('standbyPool'); pool.innerHTML = '';
        const mkBtn = (t, prefix) => {
            this.data.personnel[t].slice(0, 5).forEach(p => { // åªæ˜¾ç¤ºå‰5ä¸ªå»ºè®®
                const btn = document.createElement('button');
                btn.className = 'standby';
                btn.innerText = `${prefix}${p.name}`;
                btn.onclick = () => {
                    if(t==='leader') document.getElementById('swapLeader').value = p.name;
                    else if(t==='female') document.getElementById('swapFemale').value = p.name;
                    else document.getElementById('swapMale').value = p.name;
                    let r = document.getElementById('swapRemark').value;
                    if(!r.includes('ğŸš‘')) document.getElementById('swapRemark').value = (r ? r+' ' : '') + `ğŸš‘å¤‡:${p.name}`;
                };
                pool.appendChild(btn);
            });
        };
        mkBtn('leader', 'å¸¦:'); mkBtn('female', 'å¥³:'); mkBtn('male', 'ç”·:');
    },
    
    saveSwap() {
        const ds = document.getElementById('swapDate').value;
        const val = {
            leader: document.getElementById('swapLeader').value,
            female: document.getElementById('swapFemale').value,
            male: document.getElementById('swapMale').value,
            remark: document.getElementById('swapRemark').value
        };
        this.data.schedules[ds] = val;
        this.save(); this.renderCal(); 
        document.getElementById('swapModal').style.display = 'none';
        this.msg('æ’ç­å·²è°ƒæ•´');
    },

    // --- 5. æ’ç­ç”Ÿæˆå™¨ (ä¿®å¤å‡æ—¥ Bug) ---
    updateGenSelects() {
        const fill = (id, t) => document.getElementById(id).innerHTML = (this.data.personnel[t]||[]).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        fill('startLeaderW','leader'); fill('startLeaderH','leader'); fill('startFemale','female'); fill('startMale','male');
    },
    generate() {
        const y = this.viewY, m = this.viewM;
        const days = new Date(y, m, 0).getDate();
        // Bugä¿®å¤ï¼šç¡®ä¿å¹´ä»½ Key æ˜¯å­—ç¬¦ä¸²
        const hList = this.data.holidays[String(y)] || [];
        
        // è·å–èµ·å§‹ç´¢å¼•
        const getIdx = (id, t) => {
            const n = document.getElementById(id).value;
            return Math.max(0, (this.data.personnel[t]||[]).findIndex(p => p.name === n));
        };
        
        let idxLW = getIdx('startLeaderW', 'leader');
        let idxLH = getIdx('startLeaderH', 'leader');
        let idxF = getIdx('startFemale', 'female');
        let idxM = getIdx('startMale', 'male');
        
        const pL = this.data.personnel.leader || [];
        const pF = this.data.personnel.female || [];
        const pM = this.data.personnel.male || [];
        
        if(!pL.length || !pF.length || !pM.length) return alert("äººå‘˜åˆ—è¡¨ä¸èƒ½ä¸ºç©º");

        for(let d=1; d<=days; d++) {
            const ds = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const isH = hList.includes(ds);
            
            let lName;
            if(isH) {
                lName = pL[idxLH % pL.length].name; idxLH++;
            } else {
                lName = pL[idxLW % pL.length].name; idxLW++;
            }
            const fName = pF[idxF % pF.length].name; idxF++;
            const mName = pM[idxM % pM.length].name; idxM++;
            
            this.data.schedules[ds] = { leader: lName, female: fName, male: mName, remark: '' };
        }
        
        this.save();
        this.renderCal();
        alert(`âœ… ${y}å¹´${m}æœˆ æ’ç­å·²ç”Ÿæˆ`);
    },

    // --- 6. å‡æ—¥ç®¡ç† ---
    renderHoliday() {
        const y = document.getElementById('hYear').value; // String
        const list = this.data.holidays[y] || [];
        document.getElementById('holidayChips').innerHTML = list.sort().map(d => 
            `<span style="background:white; border:1px solid #fca5a5; padding:2px 8px; border-radius:4px; font-size:12px; color:#b91c1c;">
                ${d.substring(5)} <span style="cursor:pointer;font-weight:bold;" onclick="app.delHoliday('${y}','${d}')">Ã—</span>
            </span>`
        ).join('');
    },
    addHolidayRange() {
        const y = document.getElementById('hYear').value;
        const s = document.getElementById('hStart').value;
        const e = document.getElementById('hEnd').value;
        if(!s || !e) return;
        
        if(!this.data.holidays[y]) this.data.holidays[y] = [];
        let d = new Date(s), end = new Date(e);
        while(d <= end) {
            const str = d.toISOString().split('T')[0];
            if(!this.data.holidays[y].includes(str)) this.data.holidays[y].push(str);
            d.setDate(d.getDate()+1);
        }
        this.save(); this.renderHoliday();
    },
    delHoliday(y, d) {
        this.data.holidays[y] = this.data.holidays[y].filter(x => x !== d);
        this.save(); this.renderHoliday();
    },

    // --- 7. äººå‘˜ç®¡ç† ---
    renderPersonList() {
        const t = document.getElementById('manageType').value;
        const l = this.data.personnel[t] || [];
        document.getElementById('personList').innerHTML = `<table><thead><tr><th>å§“å</th><th>æ‰‹æœº</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th></tr></thead><tbody>` +
            l.map((p,i) => `<tr><td>${p.name}</td><td>${p.phone||''}</td><td>${p.remark||''}</td>
            <td><button onclick="app.editPerson(${i})">ç¼–è¾‘</button> <button class="danger" onclick="app.delPerson('${t}',${i})">Ã—</button></td></tr>`).join('') + 
            `</tbody></table>`;
        this.updateGenSelects();
    },
    editPerson(i=null) {
        const t = document.getElementById('manageType').value;
        document.getElementById('editModal').style.display = 'flex';
        document.getElementById('editType').value = t;
        document.getElementById('editId').value = i!==null ? i : 'new';
        const p = i!==null ? this.data.personnel[t][i] : {name:'', phone:'', remark:''};
        document.getElementById('pName').value = p.name;
        document.getElementById('pPhone').value = p.phone||'';
        document.getElementById('pRemark').value = p.remark||'';
    },
    savePerson() {
        const t = document.getElementById('editType').value;
        const id = document.getElementById('editId').value;
        const p = {
            name: document.getElementById('pName').value,
            phone: document.getElementById('pPhone').value,
            remark: document.getElementById('pRemark').value
        };
        if(id === 'new') this.data.personnel[t].push(p);
        else this.data.personnel[t][id] = p;
        this.save(); this.renderPersonList(); 
        document.getElementById('editModal').style.display = 'none';
    },
    delPerson(t, i) {
        if(confirm('ç¡®å®šåˆ é™¤?')) {
            this.data.personnel[t].splice(i, 1);
            this.save(); this.renderPersonList();
        }
    },
    importExcel(input, type) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            let c = 0;
            if(type==='person') {
                const map = {"å¸¦ç­é¢†å¯¼":"leader","å¥³å€¼ç­å‘˜":"female","ç”·å€¼ç­å‘˜":"male"};
                rows.forEach(row => {
                    const t = map[row['äººå‘˜ç±»å‹']];
                    if(t) { this.data.personnel[t].push({name:row['å§“å'], phone:row['æ‰‹æœº'], remark:row['å¤‡æ³¨']}); c++; }
                });
            } else { // holiday
                 rows.forEach(row => {
                     let d = row['æ—¥æœŸ']; 
                     if(typeof d==='number') d=new Date(Math.round((d-25569)*86400*1000)).toISOString().split('T')[0];
                     if(d) { const y=d.substring(0,4); if(!this.data.holidays[y])this.data.holidays[y]=[]; this.data.holidays[y].push(d); c++; }
                 });
            }
            this.save(); alert(`å¯¼å…¥ ${c} æ¡æ•°æ®`); location.reload();
        };
        r.readAsArrayBuffer(f);
    },

    // --- 8. æ‚é¡¹ ---
    switchTab(el, id) {
        document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(x=>x.classList.remove('active'));
        el.classList.add('active'); document.getElementById(id).classList.add('active');
        if(id==='tab-cal') this.renderCal(); // åˆ‡æ¢å›æœˆå†æ—¶åˆ·æ–°
    },
    changePass() {
        const n1=document.getElementById('newAdmin').value, n2=document.getElementById('newView').value;
        if(confirm('ä¿®æ”¹å¯†ç ?')) fetch(this.api, {method:'POST', body:JSON.stringify({action:'change_pass', password:this.token, newAdminPass:n1, newViewPass:n2})}).then(()=>alert('ä¿®æ”¹æˆåŠŸ'));
    },
    exportGlobalData() {
        const b = new Blob([JSON.stringify(this.data)], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='backup.json'; a.click();
    }
};
window.onload = () => app.init();
</script>
</body>
</html>
