<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç†æ§åˆ¶å° (V20 Cloud)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f3f4f6; --surface: #ffffff; --border: #e5e7eb; --text: #111827; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        
        /* å®¹å™¨ä¸å¡ç‰‡ */
        .container { width: 100%; max-width: 1000px; }
        .card { background: var(--surface); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
        .card-header { padding: 15px 25px; background: #f9fafb; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 25px; }

        /* æŒ‰é’®ä¸è¾“å…¥ */
        button { cursor: pointer; padding: 8px 16px; border-radius: 6px; border: 1px solid #d1d5db; background: white; font-size: 13px; transition: 0.2s; }
        button:hover { background: #f3f4f6; }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.primary:hover { background: #4338ca; }
        button.danger { color: #dc2626; border-color: #fecaca; background: #fef2f2; }
        button.success { color: #059669; border-color: #a7f3d0; background: #ecfdf5; }
        
        input, select, textarea { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-size: 14px; }

        /* Tab å¯¼èˆª (å¤åˆ» V20) */
        .nav-tabs { display: flex; gap: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .nav-item { padding: 10px 0; cursor: pointer; color: #6b7280; font-weight: 600; border-bottom: 2px solid transparent; font-size: 14px; }
        .nav-item.active { color: var(--primary); border-color: var(--primary); }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* è¡¨æ ¼ (å¤åˆ» V20) */
        .table-wrap { border: 1px solid var(--border); border-radius: 6px; overflow: auto; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f9fafb; text-align: left; padding: 10px; border-bottom: 1px solid var(--border); position: sticky; top: 0; }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        tr:hover td { background: #f8fafc; }

        /* æ¨¡æ€æ¡† (Edit Modal) */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-card { background: white; width: 500px; border-radius: 12px; padding: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        
        /* çŠ¶æ€æç¤º */
        #statusMsg { position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: #ecfdf5; color: #065f46; border-radius: 6px; border: 1px solid #a7f3d0; display: none; z-index: 999; }
    </style>
</head>
<body>

<div id="statusMsg">âœ… æ“ä½œæˆåŠŸ</div>

<div class="container">
    
    <div id="loginBox" class="card" style="max-width: 400px; margin: 100px auto; text-align: center;">
        <div class="card-header" style="justify-content: center;">ğŸ” ç®¡ç†å‘˜ç™»å½•</div>
        <div class="card-body">
            <input type="password" id="adminPass" placeholder="è¯·è¾“å…¥ç®¡ç†å¯†ç " style="text-align: center; padding: 12px;">
            <button class="primary" style="width: 100%; padding: 12px; margin-top: 10px;" onclick="app.login()">éªŒè¯è¿›å…¥</button>
        </div>
    </div>

    <div id="adminPanel" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin:0; color:var(--primary);">âš™ï¸ å€¼ç­ç®¡ç†æ§åˆ¶å° <span style="font-size:12px; background:#e0e7ff; padding:2px 8px; border-radius:4px;">V20 Cloud</span></h2>
            <div>
                <button class="success" onclick="window.open('index.html', '_blank')">â†— é¢„è§ˆå‰å°</button>
                <button class="danger" onclick="location.reload()">é€€å‡º</button>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="nav-tabs">
                    <div class="nav-item active" onclick="app.switchTab(this, 'tab-publish')">ğŸ“¢ å‘å¸ƒä¸å…¬å‘Š</div>
                    <div class="nav-item" onclick="app.switchTab(this, 'tab-person')">ğŸ‘¥ äººå‘˜ç®¡ç†</div>
                    <div class="nav-item" onclick="app.switchTab(this, 'tab-holiday')">ğŸ“… å‡æ—¥å®šä¹‰</div>
                    <div class="nav-item" onclick="app.switchTab(this, 'tab-rules')">âš¡ æ’ç­ç”Ÿæˆ</div>
                    <div class="nav-item" onclick="app.switchTab(this, 'tab-data')">ğŸ’¾ æ•°æ®ä¸å®‰å…¨</div>
                    <div class="nav-item" onclick="app.switchTab(this, 'tab-logs')">ğŸ“œ å…¨å±€æ—¥å¿—</div>
                </div>

                <div id="tab-publish" class="tab-pane active">
                    <div style="background:#fff7ed; border:1px solid #fed7aa; padding:15px; border-radius:8px; margin-bottom:20px;">
                        <h4 style="margin-top:0; color:#c2410c;">ğŸ“¢ å‰å°æ»šåŠ¨å…¬å‘Š</h4>
                        <div style="display:flex; gap:10px;">
                            <input id="noticeInput" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹...">
                            <button class="primary" onclick="app.saveNotice()">å‘å¸ƒ</button>
                            <button class="danger" onclick="app.clearNotice()">å…³é—­</button>
                        </div>
                    </div>
                </div>

                <div id="tab-person" class="tab-pane">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; background:#f9fafb; padding:10px; border-radius:8px;">
                        <select id="manageType" style="width:120px;" onchange="app.renderPersonList()">
                            <option value="leader">å¸¦ç­é¢†å¯¼</option>
                            <option value="female">å¥³å€¼ç­å‘˜</option>
                            <option value="male">ç”·å€¼ç­å‘˜</option>
                        </select>
                        <div style="display:flex; gap:8px;">
                            <button onclick="app.showRetired()">ğŸ‘» å†å²äººå‘˜</button>
                            <button onclick="app.downloadTemplate('person')">â¬‡ æ¨¡æ¿</button>
                            <input type="file" id="uploadPerson" hidden onchange="app.importExcel(this, 'person')">
                            <button onclick="document.getElementById('uploadPerson').click()">â¬† å¯¼å…¥</button>
                            <button class="primary" onclick="app.editPerson()">+ æ·»åŠ äººå‘˜</button>
                        </div>
                    </div>
                    <div id="personList" class="table-wrap"></div>
                </div>

                <div id="tab-holiday" class="tab-pane">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="number" id="holidayYearConfig" style="width:80px" onchange="app.renderHolidayChips()">
                            <button onclick="app.downloadTemplate('holiday')">â¬‡ æ¨¡æ¿</button>
                            <input type="file" id="uploadHoliday" hidden onchange="app.importExcel(this, 'holiday')">
                            <button onclick="document.getElementById('uploadHoliday').click()">â¬† å¯¼å…¥Excel</button>
                        </div>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <input type="date" id="hStart" style="width:auto"><span style="font-size:12px">è‡³</span><input type="date" id="hEnd" style="width:auto">
                            <button class="primary" onclick="app.addHolidayRange()">+ æ·»åŠ åŒºé—´</button>
                        </div>
                    </div>
                    <div id="holidayChips" style="min-height:150px; border:1px solid var(--border); padding:15px; border-radius:8px; display:flex; flex-wrap:wrap; gap:6px; background:#f9fafb;"></div>
                </div>

                <div id="tab-rules" class="tab-pane">
                    <div style="background:#eef2ff; color:#3730a3; padding:12px; border-radius:6px; margin-bottom:20px; font-size:13px; border:1px solid #c7d2fe;">
                        <strong>â„¹ï¸ è§„åˆ™è¯´æ˜ï¼š</strong> 1. <strong>åŒè½¨åˆ¶</strong>ï¼šå¸¦ç­é¢†å¯¼åˆ†ä¸ºå·¥ä½œæ—¥ä¸å‡æ—¥ä¸¤æ¡ç‹¬ç«‹é˜Ÿåˆ—ã€‚ 2. <strong>å¤‡å‹¤é¡ºå»¶</strong>ï¼š(éœ€åœ¨æ—¥å†ä¸­æ“ä½œ) ä½¿ç”¨å¤‡å‹¤åï¼Œè¯¥äººå‘˜åœ¨ä¸‹æœˆå¯¹åº”é˜Ÿåˆ—ä¸­è·³è¿‡ä¸€è½®ã€‚
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:30px;">
                        <div><label>å¸¦ç­é¢†å¯¼ (å·¥ä½œæ—¥) èµ·å§‹</label><select id="startLeaderW"></select></div>
                        <div><label>å¸¦ç­é¢†å¯¼ (å‡æ—¥) èµ·å§‹</label><select id="startLeaderH"></select></div>
                        <div><label>å¥³å€¼ç­å‘˜ èµ·å§‹</label><select id="startFemale"></select></div>
                        <div><label>ç”·å€¼ç­å‘˜ èµ·å§‹</label><select id="startMale"></select></div>
                    </div>
                    <div style="text-align:center;">
                        <label>ç”Ÿæˆæœˆä»½ï¼š</label><input type="month" id="genMonth" style="width:auto; display:inline-block;">
                        <button class="primary" style="padding:10px 30px;" onclick="app.generate()">âš¡ ç”Ÿæˆæ’ç­</button>
                    </div>
                </div>

                <div id="tab-data" class="tab-pane">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                        <div>
                            <h3>ğŸ” ä¿®æ”¹ç³»ç»Ÿå¯†ç </h3>
                            <input id="newAdmin" placeholder="æ–°Â·ç®¡ç†å‘˜å¯†ç  (æ‹¥æœ‰æ‰€æœ‰æƒé™)">
                            <input id="newView" placeholder="æ–°Â·æŸ¥çœ‹å¯†ç  (ä»…å‰å°æŸ¥çœ‹)">
                            <button class="primary" onclick="app.changePass()">æ›´æ–°å¯†ç </button>
                        </div>
                        <div style="border-left:1px solid #eee; padding-left:30px;">
                            <h3>ğŸ’¾ æ•°æ®ç»´æŠ¤</h3>
                            <button class="success" onclick="app.exportGlobalData()">ğŸ“¥ å¤‡ä»½å…¨ç«™æ•°æ® (.json)</button>
                            <div style="margin-top:10px;">
                                <input type="file" id="uploadGlobal" hidden onchange="app.importGlobalData(this)">
                                <button onclick="document.getElementById('uploadGlobal').click()">ğŸ“¤ æ¢å¤å¤‡ä»½</button>
                            </div>
                            <div style="margin-top:20px; padding-top:20px; border-top:1px dashed #eee;">
                                <button class="danger" onclick="app.confirmClear()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-logs" class="tab-pane">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>æ“ä½œæµæ°´ (æœ€è¿‘100æ¡)</span>
                        <button class="danger" onclick="app.confirmClearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                    </div>
                    <div class="table-wrap">
                        <table id="logTable"><thead><tr><th width="160">æ—¶é—´</th><th width="120">ç±»å‹</th><th>è¯¦æƒ…</th></tr></thead><tbody id="logBody"></tbody></table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="margin-top:0;">ğŸ‘¤ ç¼–è¾‘äººå‘˜ä¿¡æ¯</h3>
        <input type="hidden" id="editId"><input type="hidden" id="editType">
        
        <label>å§“å</label><input type="text" id="pName">
        
        <div id="leaderFields" style="display:none; gap:10px;">
            <div style="flex:1"><label>èŒåŠ¡</label><input type="text" id="pJob"></div>
            <div style="flex:1"><label>åº§æœº</label><input type="text" id="pLandline"></div>
        </div>
        
        <label>æ‰‹æœº</label><input type="text" id="pPhone">
        <label>å¤‡æ³¨</label><textarea id="pRemark" rows="2"></textarea>
        
        <div style="background:#fef2f2; padding:10px; border-radius:6px; border:1px solid #fecaca; margin-top:10px;">
            <label style="color:#dc2626; font-size:12px;">â›” è½®ç©º/è·³è¿‡è®¾ç½® (å¦‚: ä¼‘äº§å‡)</label>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="date" id="skipStart" style="width:auto"> <span style="align-self:center">è‡³</span> 
                <input type="date" id="skipEnd" style="width:auto">
                <button class="danger" onclick="app.addSkip()">+</button>
            </div>
            <div id="skipList" style="margin-top:5px; font-size:12px;"></div>
        </div>

        <div style="margin-top:20px; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="document.getElementById('editModal').style.display='none'">å–æ¶ˆ</button>
            <button class="primary" onclick="app.savePerson()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="retiredModal" class="modal-overlay">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">ğŸ‘» å†å²äººå‘˜åº“</h3>
            <button onclick="document.getElementById('retiredModal').style.display='none'">Ã—</button>
        </div>
        <div class="table-wrap" style="margin-top:15px;">
            <table id="retiredTable"><thead><tr><th>å§“å</th><th>çŠ¶æ€</th></tr></thead><tbody></tbody></table>
        </div>
    </div>
</div>

<script>
/* V20 Cloud Edition - Integrated Logic */
window.app = {
    api: '/.netlify/functions/api',
    token: null,
    data: {
        personnel: { leader: [], female: [], male: [] },
        holidays: {}, schedules: {}, logs: [], standbyUsed: [],
        notice: "",
        tempSkips: []
    },

    // --- 1. åˆå§‹åŒ–ä¸ç™»å½• ---
    init() { document.getElementById('holidayYearConfig').value = new Date().getFullYear(); document.getElementById('genMonth').value = new Date().toISOString().substring(0,7); },
    
    async login() {
        const p = document.getElementById('adminPass').value;
        if(!p) return;
        try {
            const res = await fetch(this.api, { method: 'POST', body: JSON.stringify({ action: 'login', password: p }) });
            const json = await res.json();
            if(json.role === 'admin') {
                this.token = p;
                // åˆå¹¶æ•°æ®ï¼Œç¡®ä¿å­—æ®µå®Œæ•´
                if(json.data) {
                    this.data = { ...this.data, ...json.data };
                    // å®¹é”™å¤„ç†
                    if(!this.data.personnel) this.data.personnel = {leader:[],female:[],male:[]};
                    if(!this.data.holidays) this.data.holidays = {};
                    if(!this.data.schedules) this.data.schedules = {};
                    if(!this.data.logs) this.data.logs = [];
                }
                document.getElementById('loginBox').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                
                // åˆå§‹åŒ– UI
                this.renderPersonList();
                this.renderHolidayChips();
                this.renderLogs();
                this.updateGenOptions();
                document.getElementById('noticeInput').value = this.data.notice || "";
                this.msg('ç™»å½•æˆåŠŸï¼Œæ•°æ®å·²åŒæ­¥');
            } else { alert('å¯†ç é”™è¯¯'); }
        } catch(e) { alert('ç½‘ç»œè¿æ¥å¤±è´¥'); }
    },

    // --- 2. æ ¸å¿ƒä¿å­˜ (äº‘åŒæ­¥) ---
    async save() {
        try {
            const res = await fetch(this.api, { method: 'POST', body: JSON.stringify({ action: 'save', password: this.token, newData: this.data }) });
            const j = await res.json();
            if(j.success) this.msg('âœ… äº‘ç«¯åŒæ­¥æˆåŠŸ');
            else alert('ä¿å­˜å¤±è´¥');
        } catch(e) { alert('ç½‘ç»œé”™è¯¯'); }
    },
    msg(t) { const m=document.getElementById('statusMsg'); m.innerText=t; m.style.display='block'; setTimeout(()=>m.style.display='none', 3000); },

    // --- 3. æ—¥å¿—ç³»ç»Ÿ (V20) ---
    log(type, detail, meta=null) {
        this.data.logs.unshift({time: new Date().toLocaleString(), type, detail, meta});
        if(this.data.logs.length > 500) this.data.logs.pop();
        this.save(); this.renderLogs();
    },
    renderLogs() {
        document.getElementById('logBody').innerHTML = this.data.logs.map((l,i)=>
            `<tr><td>${l.time}</td><td>${l.type}</td><td>${l.detail} ${l.meta&&l.meta.act==='restore'?`<button class="success" style="padding:2px 6px;font-size:10px;" onclick="app.restoreLog(${i})">æ¢å¤</button>`:''}</td></tr>`
        ).join('');
    },
    restoreLog(i) {
        const l = this.data.logs[i];
        if(l.meta && l.meta.act === 'restore') {
            this.data.personnel[l.meta.t].push(l.meta.p);
            this.log('æ¢å¤äººå‘˜', `æ’¤é”€åˆ é™¤: ${l.meta.p.name}`);
            this.save(); this.renderPersonList(); alert('äººå‘˜å·²æ¢å¤');
        }
    },
    confirmClearLogs() { if(confirm('æ¸…ç©ºæ—¥å¿—ï¼Ÿ')) { this.data.logs=[]; this.save(); this.renderLogs(); } },

    // --- 4. äººå‘˜ç®¡ç† (V20 å®Œæ•´é€»è¾‘) ---
    renderPersonList() {
        const t = document.getElementById('manageType').value;
        const l = this.data.personnel[t] || [];
        document.getElementById('personList').innerHTML = `<table><thead><tr><th>å§“å</th><th>è¯¦æƒ…</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th></tr></thead><tbody>` +
            l.map((p,i) => `<tr><td><b>${p.name}</b>${p.skipRanges&&p.skipRanges.length?' <span style="color:red;font-size:10px">[è½®ç©º]</span>':''}</td>
            <td>${t==='leader'?`${p.job||''} ${p.landline||''} `:''}${p.phone||''}</td>
            <td>${p.remark||''}</td>
            <td><button onclick="app.movePerson('${t}',${i},-1)">â†‘</button> <button onclick="app.movePerson('${t}',${i},1)">â†“</button> 
            <button onclick="app.editPerson(${i})">ç¼–è¾‘</button> <button class="danger" onclick="app.delPerson('${t}',${i})">Ã—</button></td></tr>`).join('') + 
            `</tbody></table>`;
        this.updateGenSelects();
    },
    movePerson(t, i, d) {
        const l = this.data.personnel[t];
        if(i+d>=0 && i+d<l.length) { [l[i], l[i+d]] = [l[i+d], l[i]]; this.save(); this.renderPersonList(); }
    },
    editPerson(i=null) {
        const t = document.getElementById('manageType').value;
        document.getElementById('editModal').style.display='flex';
        document.getElementById('editType').value = t;
        document.getElementById('editId').value = i!==null?i:'new';
        document.getElementById('leaderFields').style.display = t==='leader'?'flex':'none';
        
        const p = i!==null ? this.data.personnel[t][i] : {name:'', skipRanges:[]};
        document.getElementById('pName').value = p.name;
        document.getElementById('pPhone').value = p.phone||'';
        document.getElementById('pRemark').value = p.remark||'';
        if(t==='leader') {
            document.getElementById('pJob').value = p.job||'';
            document.getElementById('pLandline').value = p.landline||'';
        }
        this.data.tempSkips = [...(p.skipRanges||[])];
        this.renderSkips();
    },
    addSkip() { 
        const s=document.getElementById('skipStart').value, e=document.getElementById('skipEnd').value; 
        if(s&&e) { this.data.tempSkips.push({start:s, end:e}); this.renderSkips(); } 
    },
    renderSkips() { 
        document.getElementById('skipList').innerHTML = this.data.tempSkips.map((r,i)=>
            `${r.start}~${r.end} <span style="cursor:pointer;color:red" onclick="app.data.tempSkips.splice(${i},1);app.renderSkips()">Ã—</span>`
        ).join('; '); 
    },
    savePerson() {
        const t=document.getElementById('editType').value, id=document.getElementById('editId').value, n=document.getElementById('pName').value;
        if(!n) return;
        const p = { name:n, phone:document.getElementById('pPhone').value, remark:document.getElementById('pRemark').value, skipRanges:this.data.tempSkips };
        if(t==='leader') { p.job=document.getElementById('pJob').value; p.landline=document.getElementById('pLandline').value; }
        
        if(id==='new') { this.data.personnel[t].push(p); this.log('æ·»åŠ äººå‘˜', `${t}:${n}`); }
        else { this.data.personnel[t][parseInt(id)] = p; this.log('ä¿®æ”¹äººå‘˜', `${t}:${n}`); }
        
        this.save(); this.renderPersonList(); document.getElementById('editModal').style.display='none';
    },
    delPerson(t, i) {
        const p = this.data.personnel[t][i];
        if(confirm(`åˆ é™¤ ${p.name}ï¼Ÿ`)) {
            this.data.personnel[t].splice(i,1);
            this.log('åˆ é™¤äººå‘˜', `${t}:${p.name}`, {act:'restore', t:t, p:p});
            this.save(); this.renderPersonList();
        }
    },
    showRetired() {
        const b = document.querySelector('#retiredTable tbody'); b.innerHTML='';
        const current = new Set();
        ['leader','female','male'].forEach(t => this.data.personnel[t].forEach(p=>current.add(p.name)));
        // éå†æ’ç­è¡¨æ‰¾ä¸åœ¨ç°å½¹åå•é‡Œçš„äºº
        const history = new Set();
        Object.values(this.data.schedules).forEach(m => Object.values(m).forEach(v => {
            [v.leader, v.female, v.male].forEach(n => { if(n && !current.has(n)) history.add(n); });
        }));
        history.forEach(n => b.innerHTML += `<tr><td>${n}</td><td><span style="background:#eee;padding:2px 6px;border-radius:4px;">å†å²è®°å½•</span></td></tr>`);
        document.getElementById('retiredModal').style.display='flex';
    },

    // --- 5. å‡æ—¥ç®¡ç† ---
    renderHolidayChips() {
        const y = document.getElementById('holidayYearConfig').value;
        const list = this.data.holidays[y] || [];
        document.getElementById('holidayChips').innerHTML = list.sort().map(d => 
            `<span style="background:white; border:1px solid #fca5a5; padding:4px 8px; border-radius:4px; font-size:12px; color:#b91c1c;">
                ${d.substring(5)} <span style="cursor:pointer;font-weight:bold;margin-left:4px;" onclick="app.delHoliday('${y}','${d}')">Ã—</span>
            </span>`
        ).join('');
    },
    addHolidayRange() {
        const y=document.getElementById('holidayYearConfig').value, s=document.getElementById('hStart').value, e=document.getElementById('hEnd').value;
        if(!s||!e) return;
        let d=new Date(s), en=new Date(e), c=0;
        if(!this.data.holidays[y]) this.data.holidays[y]=[];
        while(d<=en) {
            const str = d.toISOString().split('T')[0];
            if(!this.data.holidays[y].includes(str)) { this.data.holidays[y].push(str); c++; }
            d.setDate(d.getDate()+1);
        }
        this.log('æ·»åŠ å‡æ—¥', `${s}è‡³${e} (${c}å¤©)`); this.save(); this.renderHolidayChips();
    },
    delHoliday(y,d) { this.data.holidays[y]=this.data.holidays[y].filter(x=>x!==d); this.save(); this.renderHolidayChips(); },

    // --- 6. æ’ç­ç”Ÿæˆ (V20 é€»è¾‘ç§»æ¤) ---
    updateGenSelects() {
        const fill = (id, t) => document.getElementById(id).innerHTML = (this.data.personnel[t]||[]).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        fill('startLeaderW','leader'); fill('startLeaderH','leader'); fill('startFemale','female'); fill('startMale','male');
    },
    getIdx(t, id) { return (this.data.personnel[t]||[]).findIndex(p => p.name === document.getElementById(id).value); },
    generate() {
        const ms = document.getElementById('genMonth').value; if(!ms) return alert('è¯·é€‰æ‹©æœˆä»½');
        const [y, m] = ms.split('-').map(Number);
        
        // 1. è·å–èµ·å§‹ç´¢å¼•
        let idxLW = this.getIdx('leader', 'startLeaderW');
        let idxLH = this.getIdx('leader', 'startLeaderH');
        let idxF = this.getIdx('female', 'startFemale');
        let idxM = this.getIdx('male', 'startMale');
        if(idxLW<0 || idxLH<0 || idxF<0 || idxM<0) return alert('è¯·ç¡®ä¿äººå‘˜åˆ—è¡¨ä¸ä¸ºç©º');

        // 2. è¿è¡Œ V20 ç®—æ³•
        const days = new Date(y, m, 0).getDate();
        const hList = this.data.holidays[y] || [];
        const pL = this.data.personnel.leader, pF = this.data.personnel.female, pM = this.data.personnel.male;
        
        // æ ¸å¿ƒé€‰å–å‡½æ•° (å«è½®ç©ºåˆ¤æ–­)
        const pick = (list, startIdx, dateStr) => {
            let cnt = 0, curr = startIdx;
            while(cnt < list.length) {
                const p = list[curr % list.length];
                // æ£€æŸ¥è½®ç©º
                const skip = (p.skipRanges||[]).some(r => dateStr >= r.start && dateStr <= r.end);
                if(!skip) return { name: p.name, nextIdx: (curr + 1) % list.length };
                curr++; cnt++;
            }
            return { name: "(æ— äººå¯ç”¨)", nextIdx: curr % list.length };
        };

        for(let d=1; d<=days; d++) {
            const ds = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const isH = hList.includes(ds);
            
            let lRes, fRes, mRes;
            
            if(isH) { lRes = pick(pL, idxLH, ds); idxLH = lRes.nextIdx; } 
            else    { lRes = pick(pL, idxLW, ds); idxLW = lRes.nextIdx; }
            
            fRes = pick(pF, idxF, ds); idxF = fRes.nextIdx;
            mRes = pick(pM, idxM, ds); idxM = mRes.nextIdx;
            
            this.data.schedules[ds] = { leader: lRes.name, female: fRes.name, male: mRes.name, remark: '' };
        }
        
        this.log('ç”Ÿæˆæ’ç­', ms);
        this.save();
        alert(`âœ… ${ms} æ’ç­ç”Ÿæˆå®Œæ¯•ï¼`);
    },

    // --- 7. å·¥å…·: å¯¼å…¥å¯¼å‡º/å…¬å‘Š/å¯†ç  ---
    saveNotice() { this.data.notice = document.getElementById('noticeInput').value; this.save(); },
    clearNotice() { this.data.notice = ""; document.getElementById('noticeInput').value=""; this.save(); },
    
    changePass() {
        const na=document.getElementById('newAdmin').value, nv=document.getElementById('newView').value;
        if(confirm('ä¿®æ”¹å¯†ç ï¼Ÿ')) {
            fetch(this.api, { method:'POST', body:JSON.stringify({ action:'change_pass', password:this.token, newAdminPass:na, newViewPass:nv }) })
            .then(r=>r.json()).then(j=>{ if(j.success) alert('å¯†ç å·²ä¿®æ”¹'); });
        }
    },
    
    downloadTemplate(type) {
        let data, name;
        if(type==='person') { data=[{"äººå‘˜ç±»å‹":"å¸¦ç­é¢†å¯¼","å§“å":"å¼ ä¸‰","æ‰‹æœº":"138","èŒåŠ¡":"å¤„é•¿"},{"äººå‘˜ç±»å‹":"å¥³å€¼ç­å‘˜","å§“å":"æå››","æ‰‹æœº":""}]; name="äººå‘˜æ¨¡æ¿.xlsx"; }
        else { data=[{"æ—¥æœŸ":"2025-01-01"}]; name="å‡æ—¥æ¨¡æ¿.xlsx"; }
        XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.json_to_sheet(data)), name);
    },
    
    importExcel(input, type) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            if(type === 'person') {
                const map = {"å¸¦ç­é¢†å¯¼":"leader","å¥³å€¼ç­å‘˜":"female","ç”·å€¼ç­å‘˜":"male"};
                let c = 0;
                rows.forEach(row => {
                    const t = map[row['äººå‘˜ç±»å‹']];
                    const n = row['å§“å'];
                    if(t && n) {
                        this.data.personnel[t].push({ name:n, phone:row['æ‰‹æœº'], job:row['èŒåŠ¡'], landline:row['åº§æœº'], remark:row['å¤‡æ³¨'], skipRanges:[] });
                        c++;
                    }
                });
                this.log('å¯¼å…¥äººå‘˜', `${c}æ¡`);
                this.renderPersonList();
            } else if(type === 'holiday') {
                let c = 0;
                rows.forEach(row => {
                    let d = row['æ—¥æœŸ'];
                    if(typeof d==='number') d=new Date(Math.round((d-25569)*86400*1000)).toISOString().split('T')[0];
                    if(d) {
                        const y = d.substring(0,4);
                        if(!this.data.holidays[y]) this.data.holidays[y]=[];
                        if(!this.data.holidays[y].includes(d)) { this.data.holidays[y].push(d); c++; }
                    }
                });
                this.log('å¯¼å…¥å‡æ—¥', `${c}æ¡`);
                this.renderHolidayChips();
            }
            this.save(); input.value=''; alert('å¯¼å…¥å®Œæˆ');
        };
        r.readAsArrayBuffer(f);
    },
    
    exportGlobalData() {
        const b = new Blob([JSON.stringify(this.data)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
    },
    importGlobalData(input) {
        const f = input.files[0];
        const r = new FileReader();
        r.onload = e => {
            try {
                this.data = JSON.parse(e.target.result);
                this.save(); alert('æ¢å¤æˆåŠŸï¼Œå³å°†åˆ·æ–°'); location.reload();
            } catch(err) { alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); }
        };
        r.readAsText(f);
    },
    confirmClear() { if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆäººå‘˜ã€æ’ç­ã€å‡æ—¥ï¼‰ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) { this.data={personnel:{leader:[],female:[],male:[]},holidays:{},schedules:{},logs:[]}; this.save(); location.reload(); } },
    switchTab(el, id) {
        document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(x=>x.classList.remove('active'));
        el.classList.add('active'); document.getElementById(id).classList.add('active');
    }
};
</script>
</body>
</html>
