<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åå°ç®¡ç†ç³»ç»Ÿ (V29 Pro Fixed)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #2563eb; --bg: #f1f5f9; --surface: #ffffff; --border: #e2e8f0;
            --text: #0f172a; 
            --leader-bg: #e0e7ff; --leader-text: #3730a3;
            --female-bg: #fce7f3; --female-text: #9d174d;
            --male-bg: #dcfce7;   --male-text: #166534;
            --holiday-bg: #fef2f2; --holiday-text: #dc2626;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .top-bar { height: 50px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; }
        .app-title { font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .layout { display: flex; flex: 1; overflow: hidden; }
        .left-panel { flex: 1; display: flex; flex-direction: column; padding: 15px; overflow: hidden; border-right: 1px solid var(--border); background: #f8fafc; }
        .right-panel { width: 420px; background: white; display: flex; flex-direction: column; border-left: 1px solid var(--border); box-shadow: -4px 0 15px rgba(0,0,0,0.03); z-index: 10; }
        
        button { cursor: pointer; padding: 6px 12px; border-radius: 6px; border: 1px solid #cbd5e1; background: white; font-size: 13px; transition: 0.1s; white-space: nowrap; }
        button:hover { background: #f1f5f9; border-color: #94a3b8; }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.primary:hover { background: #1d4ed8; }
        button.success { background: #10b981; color: white; border-color: #10b981; }
        button.success:hover { background: #059669; }
        button.danger { color: #ef4444; border-color: #fecaca; background: #fef2f2; }
        button.danger:hover { background: #fee2e2; border-color: #fca5a5; }
        
        /* æ’åºæŒ‰é’® */
        button.sort-btn { padding: 4px 8px; color: #64748b; }
        button.sort-btn:hover { color: var(--primary); border-color: var(--primary); }

        input, select, textarea { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 8px; font-size: 13px; }

        .cal-controls { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; background: white; padding: 10px; border-radius: 8px; border: 1px solid var(--border); gap: 10px; }
        .date-ctrl { display: flex; gap: 5px; align-items: center; }
        .action-btns { display: flex; gap: 8px; }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; flex: 1; }
        .cal-head { background: #f1f5f9; padding: 8px; text-align: center; font-size: 12px; font-weight: 600; color: #64748b; }
        .cal-cell { background: white; padding: 6px; min-height: 80px; display: flex; flex-direction: column; gap: 3px; cursor: pointer; }
        .cal-cell:hover { background: #f8fafc; }
        .cal-cell.holiday { background: var(--holiday-bg); }
        .cal-cell.empty { background: #f9fafb; pointer-events: none; }
        
        .date-num { font-weight: 700; font-size: 14px; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .pill { font-size: 11px; padding: 2px 5px; border-radius: 4px; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pill.l { background: var(--leader-bg); color: var(--leader-text); }
        .pill.f { background: var(--female-bg); color: var(--female-text); }
        .pill.m { background: var(--male-bg); color: var(--male-text); }
        .remark-text { font-size: 10px; color: #c2410c; border-top: 1px dashed #e2e8f0; margin-top: auto; white-space: pre-wrap; word-break: break-all; }

        .tabs { display: flex; border-bottom: 1px solid var(--border); background: #f8fafc; }
        .tab { flex: 1; text-align: center; padding: 12px 0; font-size: 13px; font-weight: 600; color: #64748b; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); background: white; }
        .tab-content { flex: 1; overflow-y: auto; padding: 20px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        .table-container { border: 1px solid var(--border); border-radius: 6px; overflow: hidden; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; text-align: left; padding: 8px; border-bottom: 1px solid var(--border); position: sticky; top: 0; }
        td { padding: 8px; border-bottom: 1px solid var(--border); }
        
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; padding: 20px; border-radius: 12px; width: 400px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #064e3b; color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; font-weight: 500; display: none; z-index: 2000; }
        
        .suspended-row { color: #94a3b8; background: #f8fafc; text-decoration: line-through; }
    </style>
</head>
<body>

<div id="toast">æ“ä½œæˆåŠŸ</div>

<div id="loginLayer" style="position:fixed; inset:0; background:#f1f5f9; z-index:9999; display:flex; justify-content:center; align-items:center;">
    <div style="background:white; padding:40px; border-radius:12px; text-align:center; box-shadow:0 10px 15px rgba(0,0,0,0.05);">
        <h2 style="color:var(--primary); margin-top:0;">ğŸ” åå°ç®¡ç†</h2>
        <input type="password" id="adminPass" placeholder="è¾“å…¥ç®¡ç†å¯†ç  (é»˜è®¤ admin888)" style="text-align:center; padding:10px;">
        <button class="primary" style="width:100%; margin-top:10px; padding:10px;" onclick="app.login()">ç™»å½•</button>
    </div>
</div>

<div class="top-bar">
    <div class="app-title">âš™ï¸ å€¼ç­ç®¡ç†æ§åˆ¶å° <span style="font-size:11px; background:#e0e7ff; padding:2px 6px; border-radius:4px;">V29 Ops</span></div>
    <button class="danger" onclick="location.reload()">ğŸ”’ å®‰å…¨é€€å‡º</button>
</div>

<div class="layout">
    <div class="left-panel">
        <div class="cal-controls">
            <div class="date-ctrl">
                <button onclick="app.changeMonth(-1)">â—€</button>
                <input type="month" id="calMonthPicker" style="width:auto; margin:0; font-weight:bold;" onchange="app.onMonthPick()">
                <button onclick="app.changeMonth(1)">â–¶</button>
            </div>
            <div class="action-btns">
                <button class="danger" onclick="app.deleteCurrentMonth()">ğŸ—‘ï¸ åˆ é™¤æœ¬æœˆ</button>
                <button class="primary" onclick="app.downloadMonth()">ğŸ“¥ ä¸‹è½½æœ¬æœˆ</button>
                <button class="success" onclick="app.publishSchedule()">â˜ï¸ å‘å¸ƒæ’ç­</button>
            </div>
        </div>
        <div id="calGrid" class="cal-grid"></div>
    </div>

    <div class="right-panel">
        <div class="tabs">
            <div class="tab active" onclick="app.tab('t-rules')">âš¡ è§„åˆ™</div>
            <div class="tab" onclick="app.tab('t-person')">ğŸ‘¥ äººå‘˜</div>
            <div class="tab" onclick="app.tab('t-holiday')">ğŸ“… å‡æ—¥</div>
            <div class="tab" onclick="app.tab('t-data')">ğŸ’¾ æ•°æ®</div>
            <div class="tab" onclick="app.tab('t-logs')">ğŸ“œ æ—¥å¿—</div>
        </div>

        <div class="tab-content">
            <div id="t-rules" class="tab-pane active">
                <div style="background:#fff7ed; border:1px solid #fed7aa; padding:12px; border-radius:6px; margin-bottom:20px;">
                    <label style="color:#c2410c; font-size:12px; font-weight:bold;">ğŸ“¢ æ»šåŠ¨å…¬å‘Šè®¾ç½®</label>
                    <textarea id="noticeInput" rows="2" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹..."></textarea>
                    <div style="display:flex; gap:5px;">
                        <button class="primary" style="flex:1" onclick="app.saveNotice()">æ›´æ–°å…¬å‘Š</button>
                        <button onclick="app.clearNotice()">æ¸…ç©º</button>
                    </div>
                </div>
                <h4 style="margin-top:0;">âš¡ è‡ªåŠ¨æ’ç­</h4>
                <label>å¸¦ç­ (å·¥ä½œæ—¥) èµ·å§‹</label><select id="slW"></select>
                <label>å¸¦ç­ (å‡æ—¥) èµ·å§‹</label><select id="slH"></select>
                <label>å¥³å€¼ç­å‘˜ èµ·å§‹</label><select id="sf"></select>
                <label>ç”·å€¼ç­å‘˜ èµ·å§‹</label><select id="sm"></select>
                <div style="margin-top:15px;">
                    <label>ç”Ÿæˆæœˆä»½</label>
                    <div style="display:flex; gap:5px;">
                        <input type="month" id="genMonth" style="margin:0">
                        <button class="primary" onclick="app.generate()">ç”Ÿæˆ</button>
                    </div>
                </div>
            </div>

            <div id="t-person" class="tab-pane">
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <select id="manageType" onchange="app.renderPersonList()" style="margin:0; flex:1;">
                        <option value="leader">å¸¦ç­é¢†å¯¼</option>
                        <option value="female">å¥³å€¼ç­å‘˜</option>
                        <option value="male">ç”·å€¼ç­å‘˜</option>
                    </select>
                    <button class="primary" onclick="app.editPerson()">+ æ·»åŠ </button>
                </div>
                <div id="personList"></div>
                <div style="margin-top:10px; display:flex; gap:5px;">
                    <button onclick="app.downloadTemplate('person')">â¬‡ æ¨¡æ¿</button>
                    <input type="file" id="upPer" hidden onchange="app.importExcel(this,'person')">
                    <button onclick="document.getElementById('upPer').click()">â¬† å¯¼å…¥</button>
                </div>
            </div>

            <div id="t-holiday" class="tab-pane">
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="number" id="hYear" style="width:70px" onchange="app.renderHoliday()">
                    <input type="date" id="hStart" style="flex:1">
                    <input type="date" id="hEnd" style="flex:1">
                </div>
                <button class="primary" style="width:100%; margin-bottom:15px;" onclick="app.addHolidayRange()">+ æ·»åŠ å‡æ—¥åŒºé—´</button>
                <div id="holidayChips" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
            </div>

            <div id="t-data" class="tab-pane">
                <h4>ğŸ” ç³»ç»Ÿå¯†ç </h4>
                <input id="newAdmin" placeholder="æ–°Â·ç®¡ç†å¯†ç ">
                <input id="newView" placeholder="æ–°Â·æŸ¥çœ‹å¯†ç ">
                <button class="primary" style="width:100%; margin-bottom:20px;" onclick="app.changePass()">ä¿®æ”¹å¯†ç </button>
                
                <h4>ğŸ’¾ æ•°æ®ç»´æŠ¤</h4>
                <button class="success" style="width:100%; margin-bottom:5px;" onclick="app.exportData()">â¬‡ å¤‡ä»½å…¨é‡æ•°æ® (.json)</button>
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <input type="file" id="upJson" hidden onchange="app.importGlobalData(this)">
                    <button style="width:100%" onclick="document.getElementById('upJson').click()">ğŸ“¤ æ¢å¤å¤‡ä»½</button>
                </div>

                <div style="border-top:1px dashed #ccc; margin:15px 0; padding-top:15px;">
                    <label>ğŸ“… å¯¼å…¥å†å²å€¼ç­è¡¨</label>
                    <input type="file" id="upHist" hidden onchange="app.importHistory(this)">
                    <button style="width:100%" onclick="document.getElementById('upHist').click()">â¬† ä¸Šä¼ å†å² Excel</button>
                </div>
            </div>

            <div id="t-logs" class="tab-pane">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <strong>æ“ä½œå®¡è®¡ (æœ€è¿‘300æ¡)</strong>
                    <button class="danger" style="padding:2px 8px;" onclick="app.clearLogs()">æ¸…ç©º</button>
                </div>
                <div class="table-container" style="max-height:500px; overflow-y:auto;">
                    <table id="logTable"><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="swapModal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-top:0;" id="swapTitle">æ¢ç­è°ƒæ•´</h3>
        <input type="hidden" id="swapDate">
        <input type="hidden" id="swapIsHoliday">
        <div style="background:#fff7ed; padding:10px; border-radius:6px; margin-bottom:10px;">
            <div style="font-size:11px; color:#c2410c; font-weight:bold; margin-bottom:5px;">ğŸš‘ å¤‡å‹¤æ¨è (ç‚¹å‡»åº”ç”¨)</div>
            <div id="standbyPool" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:5px;"></div>
        </div>
        <label>å¸¦ç­</label><select id="swL"></select>
        <label>å¥³å€¼</label><select id="swF"></select>
        <label>ç”·å€¼</label><select id="swM"></select>
        <label>å¤‡æ³¨</label><textarea id="swR" rows="2"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button style="flex:1" onclick="document.getElementById('swapModal').style.display='none'">å–æ¶ˆ</button>
            <button class="primary" style="flex:1" onclick="app.saveSwap()">ç¡®å®š</button>
        </div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-top:0;">ç¼–è¾‘äººå‘˜</h3>
        <input type="hidden" id="edId"><input type="hidden" id="edType">
        <div style="background:#f1f5f9; padding:10px; border-radius:6px; margin-bottom:15px; display:flex; align-items:center; justify-content:space-between; border:1px solid #cbd5e1;">
            <label style="margin:0; cursor:pointer;" for="edSuspend">â¸ï¸ æš‚åœæ’ç­ (æ‚¬åœ)</label>
            <input type="checkbox" id="edSuspend" style="width:auto; margin:0;">
        </div>
        <label>å§“å</label><input id="edName">
        <div id="leaderFields" style="display:none; gap:10px;">
            <div style="flex:1"><label>èŒåŠ¡</label><input id="edJob"></div>
            <div style="flex:1"><label>åº§æœº</label><input id="edLand"></div>
        </div>
        <label>æ‰‹æœº</label><input id="edPhone">
        <label>å¤‡æ³¨</label><textarea id="edRem" rows="2"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button style="flex:1" onclick="document.getElementById('editModal').style.display='none'">å–æ¶ˆ</button>
            <button class="primary" style="flex:1" onclick="app.savePerson()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
window.app = {
    api: '/api',
    token: null,
    data: { personnel: {leader:[], female:[], male:[]}, holidays:{}, schedules:{}, logs:[], notice:"" },
    vy: new Date().getFullYear(), vm: new Date().getMonth()+1,
    currentOrigin: {},

    // --- Init ---
    init() { document.getElementById('hYear').value = this.vy; document.getElementById('genMonth').value = new Date().toISOString().slice(0,7); },
    async login() {
        const p = document.getElementById('adminPass').value;
        if(!p) return;
        try {
            const res = await fetch(this.api, {method:'POST', body:JSON.stringify({action:'login', password:p})});
            const j = await res.json();
            if(j.role==='admin') {
                this.token = p;
                if(j.data) this.data = {...this.data, ...j.data};
                this.initDataSafe();
                document.getElementById('loginLayer').style.display='none';
                this.renderCal(); this.renderPersonList(); this.renderHoliday(); this.renderLogs(); this.fillSelects();
                document.getElementById('noticeInput').value = this.data.notice || '';
            } else alert('å¯†ç é”™è¯¯');
        } catch(e) { alert('ç½‘ç»œè¿æ¥å¤±è´¥'); }
    },
    initDataSafe() {
        ['leader','female','male'].forEach(k=>{if(!this.data.personnel[k])this.data.personnel[k]=[]});
        if(!this.data.holidays) this.data.holidays={};
        if(!this.data.schedules) this.data.schedules={};
        if(!this.data.logs) this.data.logs=[];
    },

    // --- Core & Logger ---
    async save() { try { await fetch(this.api, {method:'POST', body:JSON.stringify({action:'save', password:this.token, newData:this.data})}); } catch(e){} },
    toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); },
    
    // å¢å¼ºç‰ˆæ—¥å¿—è®°å½•
    log(type, detail) { 
        this.data.logs.unshift({t:new Date().toLocaleString(), a:type, d:detail}); 
        if(this.data.logs.length>300)this.data.logs.pop(); 
        this.save(); this.renderLogs(); 
    },
    
    async publishSchedule() { await this.save(); this.log('å‘å¸ƒæ’ç­', `å‘å¸ƒäº† ${this.vy}å¹´${this.vm}æœˆ`); this.toast("âœ… æ’ç­å·²å‘å¸ƒ"); },
    async saveNotice() { this.data.notice = document.getElementById('noticeInput').value; await this.save(); this.log('å‘å¸ƒå…¬å‘Š', this.data.notice); this.toast("âœ… å…¬å‘Šå·²æ›´æ–°"); },
    clearNotice() { document.getElementById('noticeInput').value=""; this.saveNotice(); },

    // --- Month Operations ---
    deleteCurrentMonth() {
        if(!confirm(`âš ï¸ ç¡®å®šè¦å½»åº•åˆ é™¤ [${this.vy}å¹´${this.vm}æœˆ] çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ`)) return;
        const prefix = `${this.vy}-${String(this.vm).padStart(2,'0')}`;
        let count = 0;
        Object.keys(this.data.schedules).forEach(k => { if(k.startsWith(prefix)){ delete this.data.schedules[k]; count++; } });
        this.log('åˆ é™¤æœˆåº¦', `${prefix} å…±${count}æ¡`);
        this.save(); this.renderCal(); this.toast(`å·²åˆ é™¤ ${count} æ¡è®°å½•`);
    },
    downloadMonth() {
        const mKey = `${this.vy}-${String(this.vm).padStart(2,'0')}`;
        const s = this.data.schedules, pl = this.data.personnel.leader;
        const findL = (n) => pl.find(p => p.name === n) || {};
        const rows = [];
        const days = new Date(this.vy, this.vm, 0).getDate();
        for(let d=1; d<=days; d++) {
            const ds = `${mKey}-${String(d).padStart(2,'0')}`;
            const val = s[ds];
            if(val) {
                const lInfo = findL(val.leader);
                rows.push({ "æ—¥æœŸ": ds, "å¸¦ç­é¢†å¯¼": val.leader, "èŒåŠ¡": lInfo.job||'', "åº§æœº": lInfo.landline||'', "æ‰‹æœº": lInfo.phone||'', "å¥³å€¼ç­å‘˜": val.female, "ç”·å€¼ç­å‘˜": val.male, "å¤‡æ³¨": val.remark });
            }
        }
        if(!rows.length) return alert("è¯¥æœˆæ— æ•°æ®");
        this.log('ä¸‹è½½æœˆè¡¨', mKey);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), "å€¼ç­è¡¨");
        XLSX.writeFile(wb, `å€¼ç­è¡¨_${mKey}.xlsx`);
    },

    // --- Calendar ---
    updateDate() { document.getElementById('calMonthPicker').value = `${this.vy}-${String(this.vm).padStart(2,'0')}`; },
    changeMonth(d) { let m=this.vm+d, y=this.vy; if(m>12){m=1;y++}if(m<1){m=12;y--} this.vy=y;this.vm=m; this.updateDate(); this.renderCal(); },
    onMonthPick() { const [y,m]=document.getElementById('calMonthPicker').value.split('-'); this.vy=+y; this.vm=+m; this.renderCal(); },
    renderCal() {
        const g=document.getElementById('calGrid'); g.innerHTML='';
        ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].forEach(h=>g.innerHTML+=`<div class="cal-head">å‘¨${h}</div>`);
        const fd=new Date(this.vy,this.vm-1,1), ld=new Date(this.vy,this.vm,0), off=(fd.getDay()+6)%7;
        for(let i=0;i<off;i++) g.innerHTML+=`<div class="cal-cell empty"></div>`;
        const hl=this.data.holidays[String(this.vy)]||[];
        for(let d=1; d<=ld.getDate(); d++) {
            const ds=`${this.vy}-${String(this.vm).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const isH=hl.includes(ds), s=this.data.schedules[ds];
            let h=`<div class="date-num"><span>${d}</span>${isH?'<span class="holiday-tag">ä¼‘</span>':''}</div>`;
            if(s) h+=`<div class="pill l">${s.leader}</div><div class="pill f">${s.female}</div><div class="pill m">${s.male}</div>${s.remark?`<div class="remark-text">${s.remark}</div>`:''}`;
            const c=document.createElement('div'); c.className=`cal-cell ${isH?'holiday':''}`; c.innerHTML=h;
            c.onclick=()=>this.openSwap(ds, isH); g.appendChild(c);
        }
    },

    // --- Swap & Standby ---
    openSwap(ds, isH) {
        document.getElementById('swapModal').style.display='flex';
        document.getElementById('swapTitle').innerText=`è°ƒæ•´ ${ds}`; document.getElementById('swapDate').value=ds;
        document.getElementById('swapIsHoliday').value = isH;
        const s = this.data.schedules[ds] || {leader:'', female:'', male:'', remark:''};
        this.currentOrigin = {...s};

        const fill = (id, t, v) => {
            const list = this.data.personnel[t].filter(p => !p.isSuspended);
            let html = `<option value="">(ç©º)</option>`;
            if(v && !list.find(p=>p.name===v)) html += `<option value="${v}" selected>${v} (ç¦»èŒ/å†å²)</option>`;
            html += list.map(p => `<option value="${p.name}" ${p.name===v?'selected':''}>${p.name}</option>`).join('');
            document.getElementById(id).innerHTML = html;
        };
        fill('swL','leader',s.leader); fill('swF','female',s.female); fill('swM','male',s.male);
        document.getElementById('swR').value = s.remark;
        this.renderSmartStandby(this.vy, this.vm, isH);
    },

    renderSmartStandby(y, m, isTargetHoliday) {
        const pool = document.getElementById('standbyPool'); pool.innerHTML='';
        const prefix = `${y}-${String(m).padStart(2,'0')}`;
        const dates = Object.keys(this.data.schedules).filter(k => k.startsWith(prefix)).sort();
        const hlKey = String(y); const hList = this.data.holidays[hlKey] || [];

        let lastL_W = null, lastL_H = null, lastF = null, lastM = null;
        dates.forEach(d => {
            const s = this.data.schedules[d];
            const isH = hList.includes(d);
            if(isH) lastL_H = s.leader; else lastL_W = s.leader;
            lastF = s.female; lastM = s.male;
        });

        const targetLastLeader = isTargetHoliday ? lastL_H : lastL_W;

        const getNext4 = (type, lastVal) => {
            const list = this.data.personnel[type].filter(p => !p.isSuspended);
            if(!list.length) return [];
            let startIdx = 0;
            if(lastVal) {
                const idx = list.findIndex(p => p.name === lastVal);
                if(idx !== -1) startIdx = (idx + 1) % list.length;
            }
            const res = []; for(let i=0; i<4; i++) res.push(list[(startIdx + i) % list.length]);
            return res;
        };

        const lList = getNext4('leader', targetLastLeader);
        const fList = getNext4('female', lastF);
        const mList = getNext4('male', lastM);

        const addB=(p, t, pf)=>{
            const b=document.createElement('button'); b.innerText=pf+p.name; b.className='success'; b.style.padding='4px'; b.style.fontSize='11px';
            b.onclick=()=>{ 
                if(t==='l')document.getElementById('swL').value=p.name; 
                if(t==='f')document.getElementById('swF').value=p.name; 
                if(t==='m')document.getElementById('swM').value=p.name;
                const oldName = t==='l'?this.currentOrigin.leader : (t==='f'?this.currentOrigin.female:this.currentOrigin.male);
                if(oldName && oldName !== p.name) {
                    const tag = `ã€å¤‡ã€‘${oldName}â†’${p.name}`;
                    let r = document.getElementById('swR').value;
                    if(!r.includes(tag)) r = r ? (r+' '+tag) : tag;
                    document.getElementById('swR').value = r;
                }
            }; pool.appendChild(b);
        };
        lList.forEach(p=>addB(p,'l','å¸¦:')); fList.forEach(p=>addB(p,'f','å¥³:')); mList.forEach(p=>addB(p,'m','ç”·:'));
    },

    saveSwap() {
        const ds=document.getElementById('swapDate').value;
        const nL=document.getElementById('swL').value, nF=document.getElementById('swF').value, nM=document.getElementById('swM').value;
        let r=document.getElementById('swR').value;
        const old=this.currentOrigin;
        
        const changes=[];
        const check = (oldV, newV) => {
            if(oldV && oldV !== newV) {
                const pattern = `${oldV}â†’${newV}`;
                if(!r.includes(pattern)) changes.push(`${oldV}â†’${newV}`);
            }
        };
        check(old.leader, nL); check(old.female, nF); check(old.male, nM);
        
        if(changes.length>0) {
            const tag = `ã€æ¢ã€‘${changes.join(' ')}`;
            r = r ? (r+' '+tag) : tag;
        }

        this.data.schedules[ds]={leader:nL, female:nF, male:nM, remark:r};
        this.log('æ¢ç­', `${ds} ${changes.join(',')}`);
        this.save(); this.renderCal(); document.getElementById('swapModal').style.display='none';
    },

    // --- Person & Sort ---
    renderPersonList() {
        const t=document.getElementById('manageType').value, l=this.data.personnel[t];
        let h=`<div class="table-container"><table><thead><tr><th>å§“å</th>${t==='leader'?'<th>èŒåŠ¡</th><th>åº§æœº</th>':''}<th>æ‰‹æœº</th><th>æ“ä½œ</th></tr></thead><tbody>`;
        l.forEach((p,i)=>{
            h+=`<tr class="${p.isSuspended?'suspended-row':''}">
                <td>${p.name}${p.isSuspended?' (åœ)':''}</td>
                ${t==='leader'?`<td>${p.job||'-'}</td><td>${p.landline||'-'}</td>`:''}
                <td>${p.phone||'-'}</td>
                <td>
                    <button class="sort-btn" onclick="app.movePerson('${t}',${i},-1)">â†‘</button>
                    <button class="sort-btn" onclick="app.movePerson('${t}',${i},1)">â†“</button>
                    <button onclick="app.editPerson(${i})">âœ</button> 
                    <button class="danger" style="padding:4px 8px;" onclick="app.delPerson('${t}',${i})">Ã—</button>
                </td></tr>`;
        });
        document.getElementById('personList').innerHTML=h+`</tbody></table></div>`;
        this.fillSelects();
    },
    movePerson(t, i, d) {
        const l = this.data.personnel[t];
        const dest = i + d;
        if (dest >= 0 && dest < l.length) {
            [l[i], l[dest]] = [l[dest], l[i]]; // Swap
            this.log('äººå‘˜æ’åº', `è°ƒæ•´ ${t}: ${l[dest].name} â†” ${l[i].name}`);
            this.save();
            this.renderPersonList();
        }
    },
    editPerson(i=null) {
        const t=document.getElementById('manageType').value;
        document.getElementById('editModal').style.display='flex';
        document.getElementById('edType').value=t; document.getElementById('edId').value=i!==null?i:'new';
        document.getElementById('leaderFields').style.display=t==='leader'?'flex':'none';
        const p=i!==null?this.data.personnel[t][i]:{name:'',phone:'',job:'',landline:'',remark:'',isSuspended:false};
        document.getElementById('edName').value=p.name; document.getElementById('edPhone').value=p.phone;
        document.getElementById('edJob').value=p.job||''; document.getElementById('edLand').value=p.landline||'';
        document.getElementById('edRem').value=p.remark||'';
        document.getElementById('edSuspend').checked=!!p.isSuspended;
    },
    savePerson() {
        const t=document.getElementById('edType').value, id=document.getElementById('edId').value, n=document.getElementById('edName').value;
        if(!n)return;
        const p={name:n, phone:document.getElementById('edPhone').value, remark:document.getElementById('edRem').value, isSuspended:document.getElementById('edSuspend').checked};
        if(t==='leader'){ p.job=document.getElementById('edJob').value; p.landline=document.getElementById('edLand').value; }
        
        let act = 'æ–°å¢äººå‘˜';
        if(id==='new') { this.data.personnel[t].push(p); }
        else { this.data.personnel[t][id]=p; act='ä¿®æ”¹äººå‘˜'; }
        
        this.log(act, `${t}: ${n}`);
        this.save(); this.renderPersonList(); document.getElementById('editModal').style.display='none';
    },
    delPerson(t,i) { 
        if(confirm('åˆ é™¤?')) { 
            const n=this.data.personnel[t][i].name; 
            this.data.personnel[t].splice(i,1); 
            this.log('åˆ é™¤äººå‘˜',`${t}:${n}`); 
            this.save(); this.renderPersonList(); 
        } 
    },

    // --- Rules ---
    fillSelects() { 
        const f=(id,t)=>document.getElementById(id).innerHTML=this.data.personnel[t].map(p=>`<option value="${p.name}" ${p.isSuspended?'disabled':''}>${p.name}${p.isSuspended?' (åœ)':''}</option>`).join(''); 
        f('slW','leader');f('slH','leader');f('sf','female');f('sm','male'); 
    },
    generate() {
        const ms=document.getElementById('genMonth').value; if(!ms)return alert('é€‰æœˆä»½');
        const [y,m]=ms.split('-').map(Number), days=new Date(y,m,0).getDate(), hl=this.data.holidays[String(y)]||[];
        const getI=(id,t)=>{const n=document.getElementById(id).value; return Math.max(0,(this.data.personnel[t]||[]).findIndex(p=>p.name===n))};
        let iw=getI('slW','leader'), ih=getI('slH','leader'), ife=getI('sf','female'), ima=getI('sm','male');
        const pL=this.data.personnel.leader, pF=this.data.personnel.female, pM=this.data.personnel.male;
        
        const pick=(list, start)=>{
            let c=start, cnt=0; while(cnt<list.length){ const p=list[c%list.length]; if(!p.isSuspended) return {name:p.name, next:(c+1)%list.length}; c++; cnt++; } return {name:'æ— ', next:c};
        };
        if(!pL.length||!pF.length||!pM.length) return alert('äººå‘˜ä¸è¶³');
        for(let d=1;d<=days;d++) {
            const ds=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`, isH=hl.includes(ds);
            let l; if(isH){ const r=pick(pL,ih); l=r.name; ih=r.next; } else { const r=pick(pL,iw); l=r.name; iw=r.next; }
            const f=pick(pF,ife); ife=f.next; const ma=pick(pM,ima); ima=ma.next;
            this.data.schedules[ds]={leader:l, female:f.name, male:ma.name, remark:''};
        }
        this.log('ç”Ÿæˆæ’ç­', ms); this.save(); this.renderCal(); this.toast('âš¡ ç”Ÿæˆå®Œæ¯•');
    },

    // --- Holiday ---
    renderHoliday() { const y=document.getElementById('hYear').value, l=this.data.holidays[y]||[]; document.getElementById('holidayChips').innerHTML=l.sort().map(d=>`<div style="background:white;border:1px solid #f87171;padding:2px 6px;border-radius:4px;font-size:11px;color:#dc2626;">${d.substring(5)} <span onclick="app.delHoliday('${y}','${d}')" style="cursor:pointer;font-weight:bold">&times;</span></div>`).join(''); },
    addHolidayRange() { 
        const y=document.getElementById('hYear').value, s=document.getElementById('hStart').value, e=document.getElementById('hEnd').value; 
        if(!s||!e)return; 
        let d=new Date(s), en=new Date(e), c=0; 
        if(!this.data.holidays[y])this.data.holidays[y]=[]; 
        while(d<=en){ const k=d.toISOString().slice(0,10); if(!this.data.holidays[y].includes(k)){this.data.holidays[y].push(k);c++} d.setDate(d.getDate()+1); } 
        this.log('æ·»åŠ å‡æ—¥', `${s}è‡³${e} (${c}å¤©)`); 
        this.save(); this.renderHoliday(); 
    },
    delHoliday(y,d) { 
        this.data.holidays[y]=this.data.holidays[y].filter(x=>x!==d); 
        this.log('åˆ é™¤å‡æ—¥', d);
        this.save(); this.renderHoliday(); 
    },
    
    // --- Utils ---
    importExcel(inp, type) {
        const f=inp.files[0]; if(!f)return;
        const r=new FileReader();
        r.onload=e=>{
            const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}), rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            let c=0;
            if(type==='person') {
                const map={'å¸¦ç­é¢†å¯¼':'leader','å¥³å€¼ç­å‘˜':'female','ç”·å€¼ç­å‘˜':'male'};
                rows.forEach(r=>{ const t=map[r['äººå‘˜ç±»å‹']]; if(t){this.data.personnel[t].push({name:r['å§“å'],phone:r['æ‰‹æœº'],job:r['èŒåŠ¡'],landline:r['åº§æœº'],remark:r['å¤‡æ³¨'],isSuspended:false});c++} });
            }
            this.log('å¯¼å…¥äººå‘˜', c+'æ¡'); this.save(); this.renderPersonList(); inp.value=''; this.toast(`å¯¼å…¥ ${c} æ¡`);
        }; r.readAsArrayBuffer(f);
    },
    importHistory(inp) {
        const f=inp.files[0]; if(!f)return;
        const r=new FileReader();
        r.onload=e=>{
            const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}), rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            let c=0;
            rows.forEach(row => {
                let d=row['æ—¥æœŸ']; if(typeof d==='number')d=new Date(Math.round((d-25569)*86400*1000)).toISOString().slice(0,10);
                if(d && d.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    this.data.schedules[d]={leader:row['å¸¦ç­é¢†å¯¼']||'', female:row['å¥³å€¼ç­å‘˜']||'', male:row['ç”·å€¼ç­å‘˜']||'', remark:row['å¤‡æ³¨']||''};
                    c++;
                }
            });
            this.log('å¯¼å…¥å†å²', c+'æ¡'); this.save(); this.renderCal(); inp.value=''; this.toast(`å¯¼å…¥å†å² ${c} æ¡`);
        }; r.readAsArrayBuffer(f);
    },
    
    // --- Global Data Ops ---
    exportData() { 
        const b=new Blob([JSON.stringify(this.data)],{type:'application/json'}), a=document.createElement('a'); 
        a.href=URL.createObjectURL(b); a.download='backup.json'; a.click(); 
        this.log('æ•°æ®å¤‡ä»½', 'ä¸‹è½½å…¨é‡æ•°æ®');
    },
    importGlobalData(inp) {
        const f = inp.files[0];
        const r = new FileReader();
        r.onload = e => {
            try {
                this.data = JSON.parse(e.target.result);
                this.save(); 
                this.log('æ•°æ®æ¢å¤', 'ä» backup.json æ¢å¤');
                alert('æ¢å¤æˆåŠŸï¼Œå³å°†åˆ·æ–°'); location.reload();
            } catch(err) { alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); }
        };
        r.readAsText(f);
    },

    renderLogs() { const b=document.querySelector('#logTable tbody'); b.innerHTML=this.data.logs.map(l=>`<tr><td style="color:#666;font-size:11px;">${l.t}</td><td><strong>${l.a}</strong></td><td>${l.d}</td></tr>`).join(''); },
    clearLogs() { this.data.logs=[]; this.save(); this.renderLogs(); },
    tab(id) { document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); event.currentTarget.classList.add('active'); document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); },
    downloadTemplate(t) { const d = t==='person' ? [{"äººå‘˜ç±»å‹":"å¸¦ç­é¢†å¯¼","å§“å":"å¼ ä¸‰","èŒåŠ¡":"å¤„é•¿","åº§æœº":"8001","æ‰‹æœº":"139"}] : [{"æ—¥æœŸ":"2025-01-01"}]; XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.json_to_sheet(d)), "æ¨¡æ¿.xlsx"); },
    changePass() { if(confirm('ä¿®æ”¹å¯†ç ï¼Ÿ')) fetch(this.api, {method:'POST', body:JSON.stringify({action:'change_pass', password:this.token, newAdminPass:document.getElementById('newAdmin').value, newViewPass:document.getElementById('newView').value})}).then(()=>{alert('æˆåŠŸ'); this.log('å®‰å…¨è®¾ç½®', 'ä¿®æ”¹å¯†ç ');}); }
};
window.onload=()=>app.init();
</script>
</body>
</html>
