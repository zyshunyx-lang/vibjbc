<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åå°ç®¡ç†ç³»ç»Ÿ (V37 ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #2563eb; --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0;
            --text: #0f172a; 
            --leader-bg: #e0e7ff; --leader-text: #3730a3;
            --female-bg: #fce7f3; --female-text: #9d174d;
            --male-bg: #dcfce7;   --male-text: #166534;
            --holiday-bg: #fef2f2; --holiday-text: #dc2626;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .top-bar { height: 50px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; }
        .app-title { font-weight: 700; color: var(--primary); font-size: 16px; }
        
        .layout { display: flex; flex: 1; overflow: hidden; }
        .left-panel { flex: 1; display: flex; flex-direction: column; padding: 15px; overflow: hidden; border-right: 1px solid var(--border); background: #f1f5f9; }
        .right-panel { width: 600px; background: white; display: flex; flex-direction: column; border-left: 1px solid var(--border); box-shadow: -4px 0 15px rgba(0,0,0,0.03); z-index: 10; }
        
        button { cursor: pointer; padding: 6px 12px; border-radius: 4px; border: 1px solid #cbd5e1; background: white; font-size: 13px; transition: 0.1s; white-space: nowrap; }
        button:hover { background: #f1f5f9; border-color: #94a3b8; }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.primary:hover { background: #1d4ed8; }
        button.success { background: #10b981; color: white; border-color: #10b981; }
        button.success:hover { background: #059669; }
        button.danger { color: #ef4444; border-color: #fecaca; background: #fef2f2; }
        button.danger:hover { background: #fee2e2; border-color: #fca5a5; }
        
        input, select, textarea { padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 8px; font-size: 13px; }

        .cal-controls { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; background: white; padding: 10px; border-radius: 6px; border: 1px solid var(--border); gap: 10px; }
        .date-ctrl { display: flex; gap: 5px; align-items: center; }
        .action-btns { display: flex; gap: 8px; }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; flex: 1; }
        .cal-head { background: #f8fafc; padding: 8px; text-align: center; font-size: 12px; font-weight: 600; color: #64748b; }
        .cal-cell { background: white; padding: 6px; min-height: 80px; display: flex; flex-direction: column; gap: 3px; cursor: pointer; }
        .cal-cell:hover { background: #f8fafc; }
        .cal-cell.holiday { background: var(--holiday-bg); }
        .cal-cell.empty { background: #f9fafb; pointer-events: none; }
        
        .date-num { font-weight: 700; font-size: 14px; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .pill { font-size: 11px; padding: 2px 5px; border-radius: 3px; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pill.l { background: var(--leader-bg); color: var(--leader-text); }
        .pill.f { background: var(--female-bg); color: var(--female-text); }
        .pill.m { background: var(--male-bg); color: var(--male-text); }
        .remark-text { font-size: 10px; color: #c2410c; border-top: 1px dashed #e2e8f0; margin-top: auto; white-space: pre-wrap; word-break: break-all; }

        .tabs { display: flex; border-bottom: 1px solid var(--border); background: #f8fafc; }
        .tab { flex: 1; text-align: center; padding: 12px 0; font-size: 13px; font-weight: 600; color: #64748b; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); background: white; }
        .tab-content { flex: 1; overflow-y: auto; padding: 20px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        .table-container { border: 1px solid var(--border); border-radius: 6px; overflow: hidden; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; text-align: left; padding: 8px; border-bottom: 1px solid var(--border); position: sticky; top: 0; }
        td { padding: 8px; border-bottom: 1px solid var(--border); }
        
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; padding: 20px; border-radius: 8px; width: 450px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #064e3b; color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; font-weight: 500; display: none; z-index: 2000; }
        
        .suspended-row { color: #94a3b8; background: #f8fafc; text-decoration: line-through; }
        .lab-switch-item { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        
        h4 { margin-top: 0; margin-bottom: 15px; color: #334155; font-size: 14px; border-left: 4px solid var(--primary); padding-left: 10px; }
        .icon-btn { border: none; background: none; padding: 2px 6px; font-size: 14px; color: #64748b; cursor: pointer; }
        .icon-btn:hover { color: var(--primary); background: #f1f5f9; border-radius: 3px; }
    </style>
</head>
<body>

<div id="toast">æ“ä½œæˆåŠŸ</div>

<div id="loginLayer" style="position:fixed; inset:0; background:#f1f5f9; z-index:9999; display:flex; justify-content:center; align-items:center;">
    <div style="background:white; padding:40px; border-radius:8px; text-align:center; box-shadow:0 10px 15px rgba(0,0,0,0.05);">
        <h2 style="color:var(--primary); margin-top:0;">åå°ç®¡ç†</h2>
        <input type="password" id="adminPass" placeholder="è¾“å…¥ç®¡ç†å¯†ç " style="text-align:center; padding:10px;">
        <button class="primary" style="width:100%; margin-top:10px; padding:10px;" onclick="app.login()">ç™»å½•</button>
        <div id="loadError" style="color:red; font-size:12px; margin-top:10px;"></div>
    </div>
</div>

<div class="top-bar">
    <div class="app-title">å€¼ç­ç®¡ç†æ§åˆ¶å°</div>
    <button class="danger" onclick="location.reload()">é€€å‡º</button>
</div>

<div class="layout">
    <div class="left-panel">
        <div class="cal-controls">
            <div class="date-ctrl">
                <button onclick="app.changeMonth(-1)">ä¸Šæœˆ</button>
                <input type="month" id="calMonthPicker" style="width:auto; margin:0; font-weight:bold; cursor:pointer;" onchange="app.onMonthPick()">
                <button onclick="app.changeMonth(1)">ä¸‹æœˆ</button>
            </div>
            <div class="action-btns">
                <button class="danger" onclick="app.deleteCurrentMonth()">åˆ é™¤æœ¬æœˆ</button>
                <button class="primary" onclick="app.downloadMonth()">ä¸‹è½½æœ¬æœˆ</button>
                <button class="success" onclick="app.publishSchedule()">å‘å¸ƒæ’ç­</button>
            </div>
        </div>
        <div id="calGrid" class="cal-grid"></div>
    </div>

    <div class="right-panel">
        <div class="tabs">
            <div class="tab active" onclick="app.tab('t-rules')">è§„åˆ™</div>
            <div class="tab" onclick="app.tab('t-person')">äººå‘˜</div>
            <div class="tab" onclick="app.tab('t-holiday')">å‡æ—¥</div>
            <div class="tab" onclick="app.tab('t-lab')">å®éªŒå®¤</div>
            <div class="tab" onclick="app.tab('t-data')">æ•°æ®</div>
            <div class="tab" onclick="app.tab('t-logs')">æ—¥å¿—</div>
        </div>

        <div class="tab-content">
            <div id="t-rules" class="tab-pane active">
                <div style="background:#fff7ed; border:1px solid #fed7aa; padding:12px; border-radius:6px; margin-bottom:20px;">
                    <label style="color:#c2410c;">æ»šåŠ¨å…¬å‘Šè®¾ç½®</label>
                    <textarea id="noticeInput" rows="2" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹..."></textarea>
                    <div style="display:flex; gap:5px;">
                        <button class="primary" style="flex:1" onclick="app.saveNotice()">æ›´æ–°å…¬å‘Š</button>
                        <button onclick="app.clearNotice()">æ¸…ç©º</button>
                    </div>
                </div>
                <h4>è‡ªåŠ¨æ’ç­ (å«è½®ç©ºè¿‡æ»¤)</h4>
                <label>å¸¦ç­ (å·¥ä½œæ—¥) èµ·å§‹</label><select id="slW"></select>
                <label>å¸¦ç­ (å‡æ—¥) èµ·å§‹</label><select id="slH"></select>
                <label>å¥³å€¼ç­å‘˜ èµ·å§‹</label><select id="sf"></select>
                <label>ç”·å€¼ç­å‘˜ èµ·å§‹</label><select id="sm"></select>
                <div style="margin-top:15px;">
                    <label>ç”Ÿæˆæœˆä»½</label>
                    <div style="display:flex; gap:5px;">
                        <input type="month" id="genMonth" style="margin:0">
                        <button class="primary" onclick="app.generate()">ç”Ÿæˆé¢„è§ˆ (éœ€ç‚¹å‡»å‘å¸ƒç”Ÿæ•ˆ)</button>
                    </div>
                </div>
            </div>

            <div id="t-person" class="tab-pane">
                <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
                    <select id="manageType" onchange="app.renderPersonList()" style="margin:0; flex:1;">
                        <option value="leader">å¸¦ç­é¢†å¯¼</option>
                        <option value="female">å¥³å€¼ç­å‘˜</option>
                        <option value="male">ç”·å€¼ç­å‘˜</option>
                    </select>
                    <button class="primary" onclick="app.editPerson()">æ·»åŠ </button>
                </div>
                <div id="personList"></div>
                <div style="margin-top:15px; display:flex; gap:5px; border-top:1px dashed #eee; padding-top:15px;">
                    <button onclick="app.downloadTemplate('person')">ä¸‹è½½æ¨¡æ¿</button>
                    <input type="file" id="upPer" hidden onchange="app.importExcel(this,'person')">
                    <button onclick="document.getElementById('upPer').click()">å¯¼å…¥äººå‘˜ Excel</button>
                </div>
            </div>

            <div id="t-holiday" class="tab-pane">
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="number" id="hYear" style="width:70px" onchange="app.renderHoliday()">
                    <input type="date" id="hStart" style="flex:1">
                    <input type="date" id="hEnd" style="flex:1">
                </div>
                <button class="primary" style="width:100%; margin-bottom:15px;" onclick="app.addHolidayRange()">æ·»åŠ å‡æ—¥åŒºé—´</button>
                <div id="holidayChips" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
            </div>

            <div id="t-lab" class="tab-pane">
                <h4>å®éªŒå®¤åŠŸèƒ½å¼€å…³</h4>
                <div class="lab-switch-item"><span>å€¼ç­æŸ¥è¯¢</span><input type="checkbox" id="sw_query" onchange="app.saveLabSwitch()"></div>
                <div class="lab-switch-item"><span>æ¯æ—¥èœè°±</span><input type="checkbox" id="sw_menu" onchange="app.saveLabSwitch()"></div>
                <div class="lab-switch-item"><span>å€¼ç­é¢„ä¼°</span><input type="checkbox" id="sw_predict" onchange="app.saveLabSwitch()"></div>
                <hr style="border:0; border-top:1px dashed #eee; margin:20px 0;">
                
                <h4>æ¯æ—¥èœè°±ç®¡ç†</h4>
                <div style="background:#f8fafc; padding:15px; border-radius:6px; border:1px solid #e2e8f0;">
                    <label>é€‰æ‹©æ—¥æœŸ</label>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="date" id="menuDate" onchange="app.loadMenuForDate()">
                        <button class="danger" style="width:auto;" onclick="app.deleteMenu()">åˆ é™¤</button>
                    </div>
                    <label>èœè°±å†…å®¹</label>
                    <textarea id="menuContent" rows="4" placeholder="ä¾‹å¦‚ï¼š
æ—©é¤ï¼šç‰›å¥¶ã€é¸¡è›‹
åˆé¤ï¼šçº¢çƒ§è‚‰ã€é’èœ
æ™šé¤ï¼šé¢æ¡"></textarea>
                    <button class="primary" style="width:100%; margin-top:5px;" onclick="app.saveMenu()">ä¿å­˜è¯¥æ—¥èœè°±</button>
                </div>
            </div>

            <div id="t-data" class="tab-pane">
                <h4>ä¿®æ”¹å¯†ç </h4>
                <div style="display:flex; gap:5px;">
                    <input id="newAdmin" placeholder="æ–°Â·ç®¡ç†å¯†ç "><button class="primary" onclick="app.changePass('admin')">æ”¹</button>
                </div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input id="newView" placeholder="æ–°Â·æŸ¥çœ‹å¯†ç "><button class="primary" onclick="app.changePass('view')">æ”¹</button>
                </div>
                
                <h4 style="margin-top:20px;">æ•°æ®å¤‡ä»½ä¸æ¢å¤</h4>
                <button class="success" style="width:100%; margin-bottom:5px;" onclick="app.exportData()">å¤‡ä»½å…¨é‡æ•°æ® (.json)</button>
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <input type="file" id="upJson" hidden onchange="app.importGlobalData(this)">
                    <button style="width:100%" onclick="document.getElementById('upJson').click()">æ¢å¤å¤‡ä»½æ–‡ä»¶</button>
                </div>

                <div style="border-top:1px dashed #ccc; margin:15px 0; padding-top:15px;">
                    <label style="font-size:12px; color:#666;">å¯¼å…¥å†å²å€¼ç­è¡¨</label>
                    <input type="file" id="upHist" hidden onchange="app.importHistory(this)">
                    <button style="width:100%" onclick="document.getElementById('upHist').click()">ä¸Šä¼ å†å² Excel</button>
                </div>
            </div>
            
            <div id="t-logs" class="tab-pane">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <strong>æ“ä½œæ—¥å¿—</strong><button class="danger" style="padding:2px 8px;" onclick="app.clearLogs()">æ¸…ç©º</button>
                </div>
                <div class="table-container" style="max-height:500px; overflow-y:auto;">
                    <table id="logTable"><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="swapModal" class="modal-overlay"><div class="modal-box"><h3 style="margin-top:0;">æ¢ç­è°ƒæ•´</h3><input type="hidden" id="swapDate"><input type="hidden" id="swapIsHoliday"><div style="background:#fff7ed; padding:10px; border-radius:6px; margin-bottom:10px;"><div style="font-size:11px; color:#c2410c; font-weight:bold; margin-bottom:5px;">å¤‡å‹¤æ¨è</div><div id="standbyPool" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:5px;"></div></div><label>å¸¦ç­</label><select id="swL"></select><label>å¥³å€¼</label><select id="swF"></select><label>ç”·å€¼</label><select id="swM"></select><label>å¤‡æ³¨</label><textarea id="swR" rows="2"></textarea><div style="display:flex; gap:10px; margin-top:10px;"><button style="flex:1" onclick="document.getElementById('swapModal').style.display='none'">å–æ¶ˆ</button><button class="primary" style="flex:1" onclick="app.saveSwap()">ç¡®å®š</button></div></div></div>
<div id="editModal" class="modal-overlay"><div class="modal-box"><h3 style="margin-top:0;">ç¼–è¾‘äººå‘˜</h3><input type="hidden" id="edId"><input type="hidden" id="edType"><label>å§“å</label><input id="edName"><div id="leaderFields" style="display:none; gap:10px;"><div style="flex:1"><label>èŒåŠ¡</label><input id="edJob"></div><div style="flex:1"><label>åº§æœº</label><input id="edLand"></div></div><label>æ‰‹æœº</label><input id="edPhone"><div style="background:#f1f5f9; padding:10px; border-radius:6px; margin:10px 0;"><label style="color:#dc2626; font-size:12px;">è½®ç©ºæœŸ (åœ¨æ­¤æœŸé—´ä¸æ’ç­)</label><div id="skipList" style="margin-bottom:5px;"></div><div style="display:flex; gap:5px;"><input type="date" id="skipStart" style="margin:0;"><input type="date" id="skipEnd" style="margin:0;"><button class="danger" style="padding:4px 8px;" onclick="app.addSkip()">+</button></div></div><div style="display:flex; gap:10px; margin-top:10px;"><button style="flex:1" onclick="document.getElementById('editModal').style.display='none'">å–æ¶ˆ</button><button class="primary" style="flex:1" onclick="app.savePerson()">ä¿å­˜</button></div></div></div>

<script>
window.onerror = function(msg) { document.getElementById('loadError').innerText = "ç³»ç»ŸåŠ è½½å¤±è´¥: " + msg; };

window.app = {
    api: '/api', token: null,
    data: { personnel:{leader:[],female:[],male:[]}, holidays:{}, schedules:{}, labConfig:{}, logs:[] },
    vy: new Date().getFullYear(), vm: new Date().getMonth()+1,
    tempSkips: [], currentOrigin: {},

    init() { 
        document.getElementById('hYear').value = this.vy; 
        document.getElementById('genMonth').value = new Date().toISOString().slice(0,7);
        const today = new Date().toISOString().slice(0,10);
        document.getElementById('menuDate').value = today;
    },
    
    async login() {
        const p = document.getElementById('adminPass').value;
        if(!p) return;
        try {
            const res = await fetch(this.api, {method:'POST', body:JSON.stringify({action:'login', password:p})});
            const j = await res.json();
            if(j.role==='admin') {
                this.token = p;
                if(j.data) this.data = {...this.data, ...j.data};
                this.sanitizeData(); 
                this.initDataSafe();
                document.getElementById('loginLayer').style.display='none';
                this.renderCal(); this.renderPersonList(); this.renderHoliday(); this.fillSelects(); this.renderLogs();
                document.getElementById('noticeInput').value = this.data.notice || '';
                this.initLabConfig();
            } else alert('å¯†ç é”™è¯¯');
        } catch(e) { alert('ç½‘ç»œè¿æ¥å¤±è´¥: ' + e.message); }
    },
    
    sanitizeData() {
        ['leader', 'female', 'male'].forEach(type => {
            if (this.data.personnel[type]) {
                this.data.personnel[type].forEach(p => {
                    p.skips = p.skips ? JSON.parse(JSON.stringify(p.skips)) : [];
                });
            }
        });
    },

    initDataSafe() {
        ['leader','female','male'].forEach(k=>{if(!this.data.personnel[k])this.data.personnel[k]=[]});
        if(!this.data.holidays) this.data.holidays={};
        if(!this.data.schedules) this.data.schedules={};
        if(!this.data.logs) this.data.logs=[];
        // å‡çº§ï¼šå¢åŠ  dailyMenus
        if(!this.data.labConfig) this.data.labConfig={switches:{query:true,menu:true,predict:true}};
        if(!this.data.labConfig.dailyMenus) this.data.labConfig.dailyMenus = {};
        if(!this.data.labConfig.switches) this.data.labConfig.switches = {query:true,menu:true,predict:true};
    },

    async save() { try { await fetch(this.api, {method:'POST', body:JSON.stringify({action:'save', password:this.token, newData:this.data})}); } catch(e){} },
    toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); },
    log(act, det) { this.data.logs.unshift({t:new Date().toLocaleString(), a:act, d:det}); if(this.data.logs.length>300)this.data.logs.pop(); this.save(); this.renderLogs(); },
    
    // --- Lab Config (ä¿®å¤åçš„èœè°±é€»è¾‘) ---
    initLabConfig() {
        const c = this.data.labConfig || {};
        const s = c.switches || {query:true, menu:true, predict:true};
        document.getElementById('sw_query').checked = s.query;
        document.getElementById('sw_menu').checked = s.menu;
        document.getElementById('sw_predict').checked = s.predict;
        this.loadMenuForDate();
    },
    async saveLabSwitch() {
        const switches = { 
            query: document.getElementById('sw_query').checked, 
            menu: document.getElementById('sw_menu').checked, 
            predict: document.getElementById('sw_predict').checked 
        };
        this.data.labConfig.switches = switches;
        await this.save(); 
        this.toast("å¼€å…³é…ç½®å·²ä¿å­˜");
    },
    loadMenuForDate() {
        const d = document.getElementById('menuDate').value;
        const menus = this.data.labConfig.dailyMenus || {};
        document.getElementById('menuContent').value = menus[d] || '';
    },
    async saveMenu() {
        const d = document.getElementById('menuDate').value;
        const content = document.getElementById('menuContent').value.trim();
        if(!d) return alert('è¯·é€‰æ‹©æ—¥æœŸ');
        
        if(!this.data.labConfig.dailyMenus) this.data.labConfig.dailyMenus = {};
        
        if(content) {
            this.data.labConfig.dailyMenus[d] = content;
            this.log('ä¿å­˜èœè°±', d);
        } else {
            delete this.data.labConfig.dailyMenus[d];
            this.log('æ¸…é™¤èœè°±', d);
        }
        
        await this.save();
        this.toast("èœè°±å·²ä¿å­˜");
    },
    async deleteMenu() {
        const d = document.getElementById('menuDate').value;
        if(!d) return;
        if(confirm('ç¡®å®šåˆ é™¤ '+d+' çš„èœè°±å—ï¼Ÿ')) {
            document.getElementById('menuContent').value = '';
            this.saveMenu();
        }
    },

    // --- Actions ---
    async publishSchedule() { 
        if(!confirm("ç¡®è®¤å‘å¸ƒæ’ç­è¡¨åˆ°å‰å°å—ï¼Ÿ")) return;
        await this.save(); 
        this.log('å‘å¸ƒæ’ç­', this.vy+'-'+this.vm); 
        this.toast("âœ… æ’ç­å·²å‘å¸ƒ"); 
    },
    async saveNotice() { this.data.notice = document.getElementById('noticeInput').value; await this.save(); this.log('æ›´æ–°å…¬å‘Š', this.data.notice); this.toast("âœ… å…¬å‘Šå·²æ›´æ–°"); },
    clearNotice() { document.getElementById('noticeInput').value=""; this.saveNotice(); },
    deleteCurrentMonth() { if(!confirm('åˆ é™¤æœ¬æœˆæ•°æ®ï¼Ÿ')) return; const p=this.vy+'-'+String(this.vm).padStart(2,'0'); Object.keys(this.data.schedules).forEach(k=>{if(k.startsWith(p))delete this.data.schedules[k]}); this.save(); this.renderCal(); this.log('åˆ é™¤æœˆåº¦', p); },
    
    downloadMonth() {
        const mKey=this.vy+'-'+String(this.vm).padStart(2,'0'), rows=[];
        const days=new Date(this.vy, this.vm, 0).getDate();
        const pl = this.data.personnel.leader;
        const findL = (n) => pl.find(p => p.name === n) || {};

        for(let d=1;d<=days;d++){
            const ds=mKey+'-'+String(d).padStart(2,'0'), v=this.data.schedules[ds];
            if(v) {
                const lInfo = findL(v.leader);
                rows.push({
                    "æ—¥æœŸ":ds,
                    "å¸¦ç­é¢†å¯¼":v.leader,
                    "èŒåŠ¡": lInfo.job || '',
                    "åº§æœº": lInfo.landline || '',
                    "æ‰‹æœº": lInfo.phone || '',
                    "å¥³å€¼ç­å‘˜":v.female,
                    "ç”·å€¼ç­å‘˜":v.male,
                    "å¤‡æ³¨":v.remark
                });
            }
        }
        if(!rows.length)return alert('æ— æ•°æ®');
        XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.json_to_sheet(rows)), 'å€¼ç­è¡¨_'+mKey+'.xlsx');
    },

    // --- Calendar ---
    updateDate() { document.getElementById('calMonthPicker').value = this.vy+'-'+String(this.vm).padStart(2,'0'); },
    changeMonth(d) { let m=this.vm+d, y=this.vy; if(m>12){m=1;y++}if(m<1){m=12;y--} this.vy=y;this.vm=m; this.updateDate(); this.renderCal(); },
    onMonthPick() { const [y,m]=document.getElementById('calMonthPicker').value.split('-'); this.vy=+y; this.vm=+m; this.renderCal(); },
    renderCal() {
        const g=document.getElementById('calGrid'); g.innerHTML='';
        ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].forEach(h=>g.innerHTML+='<div class="cal-head">å‘¨'+h+'</div>');
        const fd=new Date(this.vy,this.vm-1,1), ld=new Date(this.vy,this.vm,0), off=(fd.getDay()+6)%7;
        for(let i=0;i<off;i++) g.innerHTML+='<div class="cal-cell empty"></div>';
        const hl=this.data.holidays[String(this.vy)]||[];
        for(let d=1; d<=ld.getDate(); d++) {
            const ds=this.vy+'-'+String(this.vm).padStart(2,'0')+'-'+String(d).padStart(2,'0');
            const isH=hl.includes(ds), s=this.data.schedules[ds];
            let h='<div class="date-num"><span>'+d+'</span>'+(isH?'<span style="color:red">å‡</span>':'')+'</div>';
            if(s) h+='<div class="pill l">'+s.leader+'</div><div class="pill f">'+s.female+'</div><div class="pill m">'+s.male+'</div>'+(s.remark?'<div class="remark-text">'+s.remark+'</div>':'');
            const c=document.createElement('div'); c.className='cal-cell '+(isH?'holiday':''); c.innerHTML=h;
            c.onclick=()=>this.openSwap(ds, isH); g.appendChild(c);
        }
    },

    // --- Swap ---
    openSwap(ds, isH) {
        document.getElementById('swapModal').style.display='flex';
        document.getElementById('swapDate').value=ds; document.getElementById('swapIsHoliday').value=isH;
        const s = this.data.schedules[ds] || {leader:'', female:'', male:'', remark:''};
        this.currentOrigin = {...s};
        const fill = (id, t, v) => {
            const list = this.data.personnel[t];
            let html = '<option value="">(ç©º)</option>';
            if(v && !list.find(p=>p.name===v)) html += '<option value="'+v+'" selected>'+v+' (å†å²)</option>';
            html += list.map(p => '<option value="'+p.name+'" '+(p.name===v?'selected':'')+'>'+p.name+'</option>').join('');
            document.getElementById(id).innerHTML = html;
        };
        fill('swL','leader',s.leader); fill('swF','female',s.female); fill('swM','male',s.male);
        document.getElementById('swR').value = s.remark;
        this.renderSmartStandby(this.vy, this.vm, isH);
    },
    renderSmartStandby(y, m, isTargetHoliday) {
        const pool = document.getElementById('standbyPool'); pool.innerHTML='';
        const prefix = y+'-'+String(m).padStart(2,'0');
        const dates = Object.keys(this.data.schedules).filter(k => k.startsWith(prefix)).sort();
        const hlKey = String(y); const hList = this.data.holidays[hlKey] || [];
        let lastL_W=null, lastL_H=null, lastF=null, lastM=null;
        dates.forEach(d => {
            const s = this.data.schedules[d], isH = hList.includes(d);
            if(isH) lastL_H = s.leader; else lastL_W = s.leader;
            lastF = s.female; lastM = s.male;
        });
        const targetLastLeader = isTargetHoliday ? lastL_H : lastL_W;
        const getNext4 = (type, lastVal) => {
            const list = this.data.personnel[type]; if(!list.length) return [];
            let startIdx = 0;
            if(lastVal) { const idx = list.findIndex(p => p.name === lastVal); if(idx !== -1) startIdx = (idx + 1) % list.length; }
            const res = []; for(let i=0; i<4; i++) res.push(list[(startIdx + i) % list.length]); return res;
        };
        const lList = getNext4('leader', targetLastLeader);
        const fList = getNext4('female', lastF);
        const mList = getNext4('male', lastM);
        const addB=(p, t, pf)=>{
            const b=document.createElement('button'); b.innerText=pf+p.name; b.className='success'; b.style.padding='4px'; b.style.fontSize='11px';
            b.onclick=()=>{ 
                if(t==='l')document.getElementById('swL').value=p.name; if(t==='f')document.getElementById('swF').value=p.name; if(t==='m')document.getElementById('swM').value=p.name;
                const oldName = t==='l'?this.currentOrigin.leader : (t==='f'?this.currentOrigin.female:this.currentOrigin.male);
                if(oldName && oldName !== p.name) {
                    const tag = 'ã€å¤‡ã€‘'+oldName+'â†’'+p.name; let r = document.getElementById('swR').value;
                    if(!r.includes(tag)) r = r ? (r+' '+tag) : tag; document.getElementById('swR').value = r;
                }
            }; pool.appendChild(b);
        };
        lList.forEach(p=>addB(p,'l','å¸¦:')); fList.forEach(p=>addB(p,'f','å¥³:')); mList.forEach(p=>addB(p,'m','ç”·:'));
    },
    saveSwap() {
        if(!confirm("ç¡®è®¤è°ƒæ•´æ’ç­ï¼Ÿ")) return;
        const ds=document.getElementById('swapDate').value;
        const nL=document.getElementById('swL').value, nF=document.getElementById('swF').value, nM=document.getElementById('swM').value;
        let r=document.getElementById('swR').value;
        const old=this.currentOrigin;
        const changes=[];
        const check = (oldV, newV) => { if(oldV && oldV !== newV) { const p = oldV+'â†’'+newV; if(!r.includes(p)) changes.push(p); } };
        check(old.leader, nL); check(old.female, nF); check(old.male, nM);
        if(changes.length>0) { const tag = 'ã€æ¢ã€‘'+changes.join(' '); r = r ? (r+' '+tag) : tag; }
        this.data.schedules[ds]={leader:nL, female:nF, male:nM, remark:r};
        this.log('æ¢ç­', ds); this.save(); this.renderCal(); document.getElementById('swapModal').style.display='none';
    },

    // --- Person ---
    renderPersonList() {
        const t=document.getElementById('manageType').value, l=this.data.personnel[t];
        let h='<div class="table-container"><table><thead><tr><th>å§“å</th>'+(t==='leader'?'<th>èŒåŠ¡</th><th>åº§æœº</th>':'')+'<th>æ‰‹æœº</th><th>æ“ä½œ</th></tr></thead><tbody>';
        l.forEach((p,i)=>{
            const hasActiveSkip = (p.skips||[]).some(s => { const now = new Date().toISOString().split('T')[0]; return s.end >= now; });
            const skipRange = (p.skips||[]).map(s=>s.start+'~'+s.end).join(' ');
            h+='<tr class="'+(hasActiveSkip?'suspended-row':'')+'">' +
                '<td>'+p.name+(hasActiveSkip?'<br><small style="color:red">ğŸš«'+skipRange+'</small>':'')+'</td>' +
                (t==='leader'?'<td>'+(p.job||'-')+'</td><td>'+(p.landline||'-')+'</td>':'') +
                '<td>'+(p.phone||'-')+'</td>' +
                '<td>' +
                    '<button class="icon-btn" title="ä¸Šç§»" onclick="app.movePerson(\''+t+'\','+i+',-1)">â–²</button>' +
                    '<button class="icon-btn" title="ä¸‹ç§»" onclick="app.movePerson(\''+t+'\','+i+',1)">â–¼</button>' +
                    '<button class="icon-btn" onclick="app.editPerson('+i+')">âœ</button>' +
                    '<button class="icon-btn" style="color:red" onclick="app.delPerson(\''+t+'\','+i+')">Ã—</button>' +
                '</td></tr>';
        });
        document.getElementById('personList').innerHTML=h+'</tbody></table></div>';
        this.fillSelects();
    },
    movePerson(t, i, d) { 
        if(!confirm("ç¡®è®¤è°ƒæ•´é¡ºåºï¼Ÿ")) return;
        const l=this.data.personnel[t], dest=i+d; 
        if(dest>=0 && dest<l.length){ [l[i],l[dest]]=[l[dest],l[i]]; this.save(); this.renderPersonList(); } 
    },
    editPerson(i) {
        if(i===undefined) i = null;
        const t=document.getElementById('manageType').value;
        document.getElementById('editModal').style.display='flex';
        document.getElementById('edType').value=t; document.getElementById('edId').value=i!==null?i:'new';
        document.getElementById('leaderFields').style.display=t==='leader'?'flex':'none';
        const p=i!==null?this.data.personnel[t][i]:{name:'',phone:'',job:'',landline:'',remark:'',skips:[]};
        document.getElementById('edName').value=p.name; document.getElementById('edPhone').value=p.phone||'';
        document.getElementById('edJob').value=p.job||''; document.getElementById('edLand').value=p.landline||'';
        this.tempSkips = JSON.parse(JSON.stringify(p.skips || []));
        this.renderSkips();
    },
    addSkip() { const s=document.getElementById('skipStart').value, e=document.getElementById('skipEnd').value; if(s&&e) { this.tempSkips.push({start:s, end:e}); this.renderSkips(); } },
    renderSkips() { document.getElementById('skipList').innerHTML = this.tempSkips.map((s,i) => '<span style="background:#fee2e2; padding:2px 5px; border-radius:4px; font-size:11px; margin-right:5px;">'+s.start+'~'+s.end+' <b style="cursor:pointer" onclick="app.removeSkip('+i+')">Ã—</b></span>').join(''); },
    removeSkip(i) { this.tempSkips.splice(i,1); this.renderSkips(); },
    savePerson() {
        if(!confirm("ç¡®è®¤ä¿å­˜äººå‘˜ä¿¡æ¯å˜æ›´ï¼Ÿ")) return;
        const t=document.getElementById('edType').value, id=document.getElementById('edId').value, n=document.getElementById('edName').value;
        if(!n)return;
        const p={
            name:n, 
            phone:document.getElementById('edPhone').value, 
            remark:'',
            skips: JSON.parse(JSON.stringify(this.tempSkips))
        };
        if(t==='leader'){ p.job=document.getElementById('edJob').value; p.landline=document.getElementById('edLand').value; }
        if(id==='new') this.data.personnel[t].push(p); else this.data.personnel[t][id]=p;
        this.log('ç¼–è¾‘äººå‘˜', t+':'+n); this.save(); this.renderPersonList(); document.getElementById('editModal').style.display='none';
    },
    delPerson(t,i) { if(confirm('ç¡®è®¤åˆ é™¤è¯¥äººå‘˜ï¼Ÿ')) { this.data.personnel[t].splice(i,1); this.log('åˆ é™¤äººå‘˜', t); this.save(); this.renderPersonList(); } },
    
    // --- Gen ---
    fillSelects() { const f=(id,t)=>document.getElementById(id).innerHTML=this.data.personnel[t].map(p=>'<option value="'+p.name+'">'+p.name+'</option>').join(''); f('slW','leader');f('slH','leader');f('sf','female');f('sm','male'); },

    generate() {
        const ms=document.getElementById('genMonth').value; if(!ms)return alert('é€‰æœˆä»½');
        const [y,m]=ms.split('-').map(Number), days=new Date(y,m,0).getDate(), hl=this.data.holidays[String(y)]||[];
        const getI=(id,t)=>{const n=document.getElementById(id).value; return Math.max(0,(this.data.personnel[t]||[]).findIndex(p=>p.name===n))};
        let iw=getI('slW','leader'), ih=getI('slH','leader'), ife=getI('sf','female'), ima=getI('sm','male');
        const pL=this.data.personnel.leader, pF=this.data.personnel.female, pM=this.data.personnel.male;
        
        const isSkipped = (p, dateStr) => {
            if (!p || !p.skips || !Array.isArray(p.skips)) return false;
            return pã€‚skipsã€‚some(s => dateStr >= s.start && dateStr <= sã€‚end);
        };
        
        const pick=(listï¼Œ start, dateStr)=>{
            let c=startï¼Œ cnt=0; 
            while(cnt<list.length){ 
                const p=list[c%list.length]; 
                if(!isSkipped(pï¼Œ dateStr)) return {name:p.nameï¼Œ ä¸‹ä¸€å¤„:(c+1)%list.length}; 
                thisã€‚log('ç”Ÿæˆè¿‡æ»¤'ï¼Œ dateStr+' è·³è¿‡ '+pã€‚name+' (å¤„äºè½®ç©ºæœŸ)');
                c++; cnt++; 
            } 
            return {name:'æ— å¯ç”¨', next:c};
        };

        if(!pLã€‚length) return alert('äººå‘˜ä¸è¶³');
        
        for(let d=1;d<=days;d++) {
            const ds=y+'-'+String(m)ã€‚padStart(2ï¼Œ'0')+'-'+String(d)ã€‚padStart(2ï¼Œ'0')ï¼Œ isH=hlã€‚includes(ds);
            let l; 
            if(isH){ const r=pick(pLï¼Œihï¼Œds); l=rã€‚name; ih=rã€‚ä¸‹ä¸€å¤„; } 
            else { const r=pick(pLï¼Œiwï¼Œds); l=rã€‚name; iw=rã€‚ä¸‹ä¸€å¤„; }
            const f=pick(pFï¼Œifeï¼Œds); ife=fã€‚ä¸‹ä¸€å¤„; 
            const ma=pick(pM,ima,ds); ima=ma.next;

            const finalCheck = (nameï¼Œ list) => {
                 const p = listã€‚find(x => x.name === name);
                 if(p && isSkipped(pï¼Œ ds)) {
                     this.log('ä¸¥é‡è­¦å‘Š'ï¼Œ ds+' å¼‚å¸¸æ’å…¥è½®ç©ºäººå‘˜ '+name+'ï¼Œè¯·æ£€æŸ¥æ•°æ®');
                     return name+'(è½®ç©ºå¼‚å¸¸)';
                 }
                 return name;
            };

            const lFinal = finalCheck(l, pL);
            const fFinal = finalCheck(fã€‚nameï¼Œ pF);
            const mFinal = finalCheck(maã€‚nameï¼Œ pM);

            this.data.schedules[ds]={leader:lFinal, female:fFinal, male:mFinal, remark:''};
        }
        thisã€‚renderCal(); 
        thisã€‚toast('âš¡ é¢„è§ˆå·²ç”Ÿæˆ');
    }ï¼Œ

    // --- Holiday ---
    renderHoliday() { const y=document.getElementById('hYear').value, l=this.data.holidays[y]||[]; document.getElementById('holidayChips').innerHTML=l.sort().map(d=>'<div style="background:white;border:1px solid #f87171;padding:2px 6px;border-radius:4px;font-size:11px;color:#dc2626;">'+d.substring(5)+' <span onclick="app.delHoliday(\''+y+'\',\''+d+'\')" style="cursor:pointer;font-weight:bold">&times;</span></div>').join(''); },
    addHolidayRange() { const y=documentã€‚getElementById('hYear')ã€‚valueï¼Œ s=documentã€‚getElementById('hStart')ã€‚valueï¼Œ e=documentã€‚getElementById('hEnd')ã€‚value; if(!s||!e)return; let d=new Date(s)ï¼Œ en=new Date(e)ï¼Œ c=0; if(!thisã€‚dataã€‚holidays[y])thisã€‚dataã€‚holidays[y]=[]; while(d<=en){ const k=dã€‚toISOString()ã€‚slice(0ï¼Œ10); if(!thisã€‚dataã€‚holidays[y]ã€‚includes(k)){thisã€‚dataã€‚holidays[y]ã€‚push(k);c++} dã€‚setDate(dã€‚getDate()+1); } thisã€‚log('æ·»åŠ å‡æ—¥'ï¼Œ s); thisã€‚save(); this.renderHoliday(); }ï¼Œ
    delHoliday(yï¼Œd) { thisã€‚dataã€‚holidays[y]=this.dataã€‚holidays[y]ã€‚filter(x=>x!==d); thisã€‚log('åˆ é™¤å‡æ—¥'ï¼Œ d); thisã€‚save(); thisã€‚renderHoliday(); }ï¼Œ
    importGlobalData(inp) { const f=inp.æ–‡ä»¶[0]; const r=new FileReader(); r.onload=e=>{ try{this.data=JSON.parse(e.target.result);this.save();this.log('æ•°æ®æ¢å¤','full backup');alert('æ¢å¤æˆåŠŸï¼Œå³å°†åˆ·æ–°');location.reload();}catch(err){alert('æ ¼å¼é”™è¯¯');}}; r.readAsText(f); },
    importHistory(inp) { const f=inp.æ–‡ä»¶[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}), rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); let c=0; rows.forEach(row => { let d=row['æ—¥æœŸ']; if(typeof d==='number')d=new Date(Math.round((d-25569)*86400*1000)).toISOString().slice(0,10); if(d && d.match(/^\d{4}-\d{2}-\d{2}$/)) { this.data.schedules[d]={leader:row['å¸¦ç­é¢†å¯¼']||'', female:row['å¥³å€¼ç­å‘˜']||'', male:row['ç”·å€¼ç­å‘˜']||'', remark:row['å¤‡æ³¨']||''}; c++; } }); this.log('å†å²å¯¼å…¥', c); this.save(); this.renderCal(); inp.value=''; }; r.readAsArrayBuffer(f); },
    exportData() { const b=new Blob([JSONã€‚stringify(thisã€‚data)]ï¼Œ{è¾“å…¥:'application/json'})ï¼Œ a=document.createElement('a'); aã€‚href=URLã€‚createObjectURL(b); aã€‚download='backup.json'; a.click(); }ï¼Œ
    renderLogs() { const b=documentã€‚querySelector('#logTable tbody'); bã€‚innerHTML=thisã€‚dataã€‚logsã€‚map(l=>'<tr><td style="color:#666;font-size:11px;">'+lã€‚t+'</td><td><strong>'+lã€‚a+'</strong></td><td>'+lã€‚d+'</td></tr>')ã€‚join(''); }ï¼Œ
    clearLogs() { this.data.logs=[]; this.save(); this.renderLogs(); },
    tab(id) { documentã€‚querySelectorAll('.tab')ã€‚forEach(t=>t.classListã€‚remove('active')); event.currentTarget.classListã€‚add('active'); documentã€‚querySelectorAll('.tab-pane')ã€‚forEach(p=>p.classListã€‚remove('active')); document.getElementById(id)ã€‚classListã€‚add('active'); }ï¼Œ
    downloadTemplate(t) { const d = t==='person' ? [{"äººå‘˜ç±»å‹":"å¸¦ç­é¢†å¯¼","å§“å":"å¼ ä¸‰"ï¼Œ"èŒåŠ¡":"å¤„é•¿","åº§æœº":"8001"ï¼Œ"æ‰‹æœº":"139"}] : [{"æ—¥æœŸ":"2025-01-01"}]; XLSXã€‚writeFile(XLSXã€‚utilsã€‚book_new(XLSXã€‚utilsã€‚json_to_sheet(d))ï¼Œ "æ¨¡æ¿.xlsx"); },
    importExcel(inpï¼Œ è¾“å…¥) {
        const f=inpã€‚æ–‡ä»¶[0]; if(!f)return;
        const r=new FileReader();
        r.onload=e=>{
            const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}), rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            let c=0;
            if(type==='person') {
                const map={'å¸¦ç­é¢†å¯¼':'leader'ï¼Œ'å¥³å€¼ç­å‘˜':'female'ï¼Œ'ç”·å€¼ç­å‘˜':'male'};
                rowsã€‚forEach(r=>{ const t=map[r['äººå‘˜ç±»å‹']]; if(t){thisã€‚dataã€‚personnel[t]ã€‚push({name:r['å§“å']ï¼Œphone:r['æ‰‹æœº']ï¼Œjob:r['èŒåŠ¡']ï¼Œlandline:r['åº§æœº']ï¼Œremark:r['å¤‡æ³¨']ï¼Œskips:[]});c++} });
            }
            thisã€‚log('å¯¼å…¥äººå‘˜'ï¼Œ c+'æ¡'); thisã€‚save(); thisã€‚renderPersonList(); inpã€‚value=''; alert('å¯¼å…¥ '+c+' æ¡');
        }; rã€‚readAsArrayBuffer(f);
    },
    changePass(type) { const v = è¾“å…¥==='admin'?documentã€‚getElementById('newAdmin')ã€‚value : documentã€‚getElementById('newView')ã€‚value; if(!v) return; if(confirm('ä¿®æ”¹'+(type==='admin'?'ç®¡ç†':'æŸ¥çœ‹')+'å¯†ç ï¼Ÿ')) fetch(thisã€‚api, {method:'POST'ï¼Œ body:JSONã€‚stringify({action:'change_pass'ï¼Œ password:thisã€‚tokenï¼Œ [type==='admin'?'newAdminPass':'newViewPass']:v})})ã€‚é”®ï¼Œç„¶å(()=>{alert('æˆåŠŸ');}); }
};
windowã€‚onload=()=>appã€‚init();
</script>
</body>
</html>
