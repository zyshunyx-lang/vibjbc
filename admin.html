<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åå°ç®¡ç†æ§åˆ¶å° V20 Cloud</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1890ff; --bg: #f0f2f5; --card: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 20px; max-width: 1000px; margin: 0 auto; color: #333; }
        
        /* å¡ç‰‡å¸ƒå±€ */
        .card { background: var(--card); padding: 24px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2, h3 { margin-top: 0; color: #001529; }
        
        /* æŒ‰é’®ä¸è¾“å…¥æ¡† */
        button { cursor: pointer; padding: 8px 16px; border-radius: 4px; border: 1px solid #d9d9d9; background: #fff; transition: 0.2s; }
        button:hover { color: var(--primary); border-color: var(--primary); }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.primary:hover { background: #40a9ff; }
        button.danger { color: #ff4d4f; border-color: #ff4d4f; }
        
        input, select, textarea { padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        
        /* Tab å¯¼èˆª */
        .tabs { display: flex; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px; }
        .tab-item { padding: 12px 24px; cursor: pointer; font-weight: 500; border-bottom: 2px solid transparent; }
        .tab-item.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; background: #fafafa; padding: 10px; border-bottom: 1px solid #f0f0f0; }
        td { padding: 10px; border-bottom: 1px solid #f0f0f0; }
        
        /* çŠ¶æ€æ  */
        #statusMsg { position: fixed; top: 20px; right: 20px; background: #fff; padding: 10px 20px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; z-index: 999; }
    </style>
</head>
<body>

<div id="loginBox" class="card" style="text-align:center; margin-top:100px; max-width:400px; margin-left:auto; margin-right:auto;">
    <h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
    <input type="password" id="adminPass" placeholder="è¾“å…¥ç®¡ç†å¯†ç  (é»˜è®¤ admin888)" style="text-align:center;">
    <button class="primary" onclick="app.login()" style="width:100%; margin-top:10px;">ç™»å½•åå°</button>
</div>

<div id="adminPanel" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">âš™ï¸ å€¼ç­ç®¡ç†æ§åˆ¶å° <span style="font-size:14px; font-weight:normal; background:#e6f7ff; color:#1890ff; padding:2px 8px; border-radius:4px;">V20 Cloud</span></h2>
        <div>
            <button onclick="location.href='index.html'">é¢„è§ˆå‰å°</button>
            <button onclick="location.reload()">é€€å‡º</button>
        </div>
    </div>

    <div class="card">
        <div class="tabs">
            <div class="tab-item active" onclick="app.switchTab(this, 't-publish')">ğŸš€ å‘å¸ƒä¸å…¬å‘Š</div>
            <div class="tab-item" onclick="app.switchTab(this, 't-person')">ğŸ‘¥ äººå‘˜ç®¡ç†</div>
            <div class="tab-item" onclick="app.switchTab(this, 't-holiday')">ğŸ“… å‡æ—¥ç®¡ç†</div>
            <div class="tab-item" onclick="app.switchTab(this, 't-rules')">âš¡ æ’ç­ç”Ÿæˆ</div>
            <div class="tab-item" onclick="app.switchTab(this, 't-data')">ğŸ’¾ æ•°æ®ä¸å®‰å…¨</div>
        </div>

        <div id="t-publish" class="tab-pane active">
            <div style="background:#fffbe6; border:1px solid #ffe58f; padding:15px; border-radius:4px; margin-bottom:20px;">
                <h3>ğŸ“¢ æ»šåŠ¨å…¬å‘Š</h3>
                <input id="noticeInput" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹ï¼Œå°†æ˜¾ç¤ºåœ¨å‰å°é¡¶éƒ¨...">
                <button class="primary" onclick="app.saveNotice()">å‘å¸ƒå…¬å‘Š</button>
                <button class="danger" onclick="app.clearNotice()">æ¸…ç©º</button>
            </div>
            
            <div style="border:1px dashed #d9d9d9; padding:20px; border-radius:4px;">
                <h3>ğŸ“¥ Excel æ’ç­è¡¨å¯¼å…¥</h3>
                <p style="color:#666; font-size:12px;">æ”¯æŒåˆ—åï¼šæ—¥æœŸ, å¸¦ç­é¢†å¯¼, å¥³å€¼ç­å‘˜, ç”·å€¼ç­å‘˜, å¤‡æ³¨ (å¦‚æœæ²¡æœ‰åˆ—åï¼Œç³»ç»Ÿä¼šå°è¯•è‡ªåŠ¨è¯†åˆ«)</p>
                <div style="display:flex; gap:10px;">
                    <input type="file" id="uploadExcel" accept=".xlsx, .xls" style="border:none;">
                    <button class="primary" onclick="app.importExcel()">å¼€å§‹å¯¼å…¥</button>
                </div>
            </div>
        </div>

        <div id="t-person" class="tab-pane">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <select id="manageType" style="width:150px;" onchange="app.renderPerson()">
                    <option value="leader">å¸¦ç­é¢†å¯¼</option>
                    <option value="female">å¥³å€¼ç­å‘˜</option>
                    <option value="male">ç”·å€¼ç­å‘˜</option>
                </select>
                <button class="primary" onclick="app.editPerson()">+ æ·»åŠ äººå‘˜</button>
            </div>
            <div id="personList" style="max-height:400px; overflow-y:auto; border:1px solid #f0f0f0;"></div>
            
            <div id="editBox" style="display:none; background:#fafafa; padding:15px; margin-top:15px; border:1px solid #eee;">
                <h4>ç¼–è¾‘äººå‘˜ä¿¡æ¯</h4>
                <input type="hidden" id="editIdx">
                <div style="display:flex; gap:10px;">
                    <input id="pName" placeholder="å§“å">
                    <input id="pPhone" placeholder="æ‰‹æœºå·">
                </div>
                <input id="pRemark" placeholder="å¤‡æ³¨">
                <div style="text-align:right;">
                    <button onclick="document.getElementById('editBox').style.display='none'">å–æ¶ˆ</button>
                    <button class="primary" onclick="app.savePerson()">ä¿å­˜åˆ°äº‘ç«¯</button>
                </div>
            </div>
        </div>

        <div id="t-holiday" class="tab-pane">
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                <input type="number" id="hYear" value="2025" style="width:80px;" onchange="app.renderHoliday()">
                <span>å¹´çš„å‡æ—¥ï¼š</span>
                <input type="date" id="hStart" style="width:auto;"> è‡³ <input type="date" id="hEnd" style="width:auto;">
                <button class="primary" onclick="app.addHolidayRange()">+ æ·»åŠ åŒºé—´</button>
            </div>
            <div id="holidayChips" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
        </div>

        <div id="t-rules" class="tab-pane">
            <div style="background:#e6f7ff; padding:15px; border-radius:4px; margin-bottom:20px;">
                <strong>âš¡ è‡ªåŠ¨ç”Ÿæˆè¯´æ˜ï¼š</strong> ç³»ç»Ÿä¼šæ ¹æ®äººå‘˜åˆ—è¡¨é¡ºåºè¿›è¡Œè½®è½¬ã€‚ç”Ÿæˆåä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ã€‚
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <div><label>å¸¦ç­ (å·¥ä½œæ—¥) èµ·å§‹</label><select id="slW"></select></div>
                <div><label>å¸¦ç­ (èŠ‚å‡æ—¥) èµ·å§‹</label><select id="slH"></select></div>
                <div><label>å¥³å€¼ç­å‘˜ èµ·å§‹</label><select id="sf"></select></div>
                <div><label>ç”·å€¼ç­å‘˜ èµ·å§‹</label><select id="sm"></select></div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <label>ç”Ÿæˆæœˆä»½ï¼š</label>
                <input type="month" id="genMonth" style="width:auto;">
                <button class="primary" onclick="app.generate()">ğŸš€ ç”Ÿæˆè¯¥æœˆæ’ç­</button>
            </div>
        </div>

        <div id="t-data" class="tab-pane">
            <h3>ğŸ” ä¿®æ”¹å¯†ç </h3>
            <div style="max-width:300px; margin-bottom:20px;">
                <input id="newAdmin" placeholder="æ–°ç®¡ç†å¯†ç ">
                <input id="newView" placeholder="æ–°æŸ¥çœ‹å¯†ç ">
                <button class="primary" onclick="app.changePass()">æ›´æ–°ç³»ç»Ÿå¯†ç </button>
            </div>
            <hr>
            <h3>ğŸ“¤ æ•°æ®å¤‡ä»½</h3>
            <button onclick="app.downloadJSON()">ä¸‹è½½å…¨é‡æ•°æ® (.json)</button>
        </div>
    </div>
</div>

<div id="statusMsg"></div>

<script>
window.app = {
    api: '/.netlify/functions/api',
    token: null,
    // æ ¸å¿ƒæ•°æ®ç»“æ„ (ä¿æŒä¸V20ä¸€è‡´)
    data: {
        personnel: { leader:[], female:[], male:[] },
        schedules: {}, // key: YYYY-MM-DD
        holidays: {},  // key: YYYY -> array
        notice: ""
    },

    // --- 1. åŸºç¡€é€šä¿¡ ---
    async login() {
        const p = document.getElementById('adminPass').value;
        if(!p) return;
        try {
            const res = await fetch(this.api, { method:'POST', body:JSON.stringify({ action:'login', password:p }) });
            const json = await res.json();
            if(json.role === 'admin') {
                this.token = p;
                // åˆå¹¶æ•°æ®ï¼Œé˜²æ­¢äº‘ç«¯æ•°æ®å­—æ®µç¼ºå¤±
                if(json.data) {
                    this.data = { ...this.data, ...json.data };
                    if(!this.data.personnel) this.data.personnel = {leader:[],female:[],male:[]};
                }
                
                document.getElementById('loginBox').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                
                // åˆå§‹åŒ–å„é¢æ¿
                document.getElementById('noticeInput').value = this.data.notice || '';
                document.getElementById('genMonth').value = new Date().toISOString().slice(0,7);
                this.renderPerson();
                this.renderHoliday();
                this.updateGenSelects();
                this.msg("ç™»å½•æˆåŠŸï¼Œæ•°æ®å·²åŒæ­¥");
            } else { alert("å¯†ç é”™è¯¯"); }
        } catch(e) { alert("ç½‘ç»œè¿æ¥å¤±è´¥"); console.error(e); }
    },

    async save() {
        // æ¯æ¬¡æ“ä½œåè°ƒç”¨ï¼Œä¿å­˜åˆ° Neon æ•°æ®åº“
        try {
            const res = await fetch(this.api, { 
                method:'POST', 
                body:JSON.stringify({ action:'save', password:this.token, newData:this.data }) 
            });
            const j = await res.json();
            if(j.success) this.msg("âœ… æ•°æ®å·²è‡ªåŠ¨ä¿å­˜åˆ°äº‘ç«¯");
            else this.msg("âŒ ä¿å­˜å¤±è´¥");
        } catch(e) { this.msg("âŒ ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥"); }
    },

    msg(t) {
        const d = document.getElementById('statusMsg');
        d.innerText = t; d.style.display='block';
        setTimeout(()=>d.style.display='none', 3000);
    },

    switchTab(el, id) {
        document.querySelectorAll('.tab-item').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(x=>x.classList.remove('active'));
        el.classList.add('active'); document.getElementById(id).classList.add('active');
    },

    // --- 2. å…¬å‘Š & å¯¼å…¥ ---
    saveNotice() { this.data.notice = document.getElementById('noticeInput').value; this.save(); },
    clearNotice() { this.data.notice = ""; document.getElementById('noticeInput').value=""; this.save(); },
    
    importExcel() {
        const f = document.getElementById('uploadExcel').files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            let cnt = 0;
            rows.forEach(row => {
                // æ¨¡ç³ŠåŒ¹é…åˆ—å
                let date = row['æ—¥æœŸ']||row['Date']||row['date'];
                if(typeof date==='number') date=new Date(Math.round((date-25569)*86400*1000)).toISOString().split('T')[0];
                if(date && date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    this.data.schedules[date] = {
                        leader: row['å¸¦ç­é¢†å¯¼']||row['å¸¦ç­']||row['Leader']||'',
                        female: row['å¥³å€¼ç­å‘˜']||row['å¥³å€¼']||row['Female']||'',
                        male: row['ç”·å€¼ç­å‘˜']||row['ç”·å€¼']||row['Male']||'',
                        remark: row['å¤‡æ³¨']||row['Remark']||''
                    };
                    cnt++;
                }
            });
            this.save();
            alert(`æˆåŠŸå¯¼å…¥ ${cnt} æ¡æ’ç­è®°å½•`);
        };
        r.readAsArrayBuffer(f);
    },

    // --- 3. äººå‘˜ç®¡ç† ---
    renderPerson() {
        const t = document.getElementById('manageType').value;
        const list = this.data.personnel[t] || [];
        const div = document.getElementById('personList');
        div.innerHTML = `<table><thead><tr><th>å§“å</th><th>æ‰‹æœº</th><th>æ“ä½œ</th></tr></thead><tbody>` +
            list.map((p,i) => `<tr><td>${p.name}</td><td>${p.phone||''}</td>
            <td><button onclick="app.editPerson(${i})">ç¼–è¾‘</button> 
            <button class="danger" onclick="app.delPerson(${i})">åˆ é™¤</button></td></tr>`).join('') + 
            `</tbody></table>`;
        this.updateGenSelects();
    },
    editPerson(i=null) {
        const t = document.getElementById('manageType').value;
        document.getElementById('editBox').style.display='block';
        document.getElementById('editIdx').value = i!==null?i:'new';
        const p = i!==null?this.data.personnel[t][i]:{name:'',phone:'',remark:''};
        document.getElementById('pName').value = p.name;
        document.getElementById('pPhone').value = p.phone||'';
        document.getElementById('pRemark').value = p.remark||'';
    },
    savePerson() {
        const t = document.getElementById('manageType').value;
        const idx = document.getElementById('editIdx').value;
        const n = document.getElementById('pName').value.trim();
        if(!n) return;
        const p = { name:n, phone:document.getElementById('pPhone').value, remark:document.getElementById('pRemark').value };
        
        if(idx==='new') this.data.personnel[t].push(p);
        else this.data.personnel[t][parseInt(idx)] = p;
        
        this.save();
        this.renderPerson();
        document.getElementById('editBox').style.display='none';
    },
    delPerson(i) {
        if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
            const t = document.getElementById('manageType').value;
            this.data.personnel[t].splice(i,1);
            this.save();
            this.renderPerson();
        }
    },

    // --- 4. å‡æ—¥ç®¡ç† ---
    renderHoliday() {
        const y = document.getElementById('hYear').value;
        const list = this.data.holidays[y] || [];
        document.getElementById('holidayChips').innerHTML = list.sort().map(d => 
            `<span style="background:#fff1f0; border:1px solid #ffa39e; padding:2px 8px; border-radius:4px; font-size:12px;">
                ${d.substring(5)} <span style="cursor:pointer;color:red;font-weight:bold" onclick="app.delHoliday('${y}','${d}')">Ã—</span>
            </span>`
        ).join('');
    },
    addHolidayRange() {
        const y = document.getElementById('hYear').value;
        const s = document.getElementById('hStart').value;
        const e = document.getElementById('hEnd').value;
        if(!s || !e) return;
        
        if(!this.data.holidays[y]) this.data.holidays[y] = [];
        let curr = new Date(s); const end = new Date(e);
        while(curr <= end) {
            const str = curr.toISOString().split('T')[0];
            if(!this.data.holidays[y].includes(str)) this.data.holidays[y].push(str);
            curr.setDate(curr.getDate()+1);
        }
        this.save();
        this.renderHoliday();
    },
    delHoliday(y, d) {
        this.data.holidays[y] = this.data.holidays[y].filter(x => x !== d);
        this.save();
        this.renderHoliday();
    },

    // --- 5. è‡ªåŠ¨ç”Ÿæˆ ---
    updateGenSelects() {
        const fill = (id, t) => document.getElementById(id).innerHTML = 
            (this.data.personnel[t]||[]).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        fill('slW', 'leader'); fill('slH', 'leader');
        fill('sf', 'female'); fill('sm', 'male');
    },
    generate() {
        const mStr = document.getElementById('genMonth').value;
        if(!mStr) return alert("è¯·é€‰æ‹©æœˆä»½");
        const [y, m] = mStr.split('-').map(Number);
        
        // ç®€å•é˜Ÿåˆ—ç”Ÿæˆç®—æ³• (ä¸æ¶‰åŠæ•°æ®åº“å¤æ‚å›æº¯ï¼Œä»…åšå½“å‰æœˆä»½ç”Ÿæˆ)
        // è·å–èµ·å§‹äººå‘˜ç´¢å¼•
        const getIdx = (id, type) => {
            const name = document.getElementById(id).value;
            return (this.data.personnel[type]||[]).findIndex(p => p.name === name);
        };
        
        let idxLW = getIdx('slW', 'leader'), idxLH = getIdx('slH', 'leader');
        let idxF = getIdx('sf', 'female'), idxM = getIdx('sm', 'male');
        
        if(idxLW<0 || idxLH<0 || idxF<0 || idxM<0) return alert("è¯·å…ˆåœ¨äººå‘˜ç®¡ç†ä¸­æ·»åŠ è¶³å¤Ÿçš„äººå‘˜");
        
        const days = new Date(y, m, 0).getDate();
        const hList = this.data.holidays[y] || [];
        
        const listL = this.data.personnel.leader;
        const listF = this.data.personnel.female;
        const listM = this.data.personnel.male;

        for(let d=1; d<=days; d++) {
            const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const isH = hList.includes(dateStr);
            
            let lName, fName, mName;
            
            // å¸¦ç­é¢†å¯¼ï¼šåˆ†å¹³æ—¥/å‡æ—¥é˜Ÿåˆ—
            if(isH) {
                lName = listL[idxLH % listL.length].name;
                idxLH++;
            } else {
                lName = listL[idxLW % listL.length].name;
                idxLW++;
            }
            
            // é˜Ÿå‘˜ï¼šå•ä¸€é˜Ÿåˆ—
            fName = listF[idxF % listF.length].name; idxF++;
            mName = listM[idxM % listM.length].name; idxM++;
            
            this.data.schedules[dateStr] = { leader: lName, female: fName, male: mName, remark: '' };
        }
        
        this.save();
        alert(`å·²ç”Ÿæˆ ${mStr} çš„æ’ç­è¡¨ï¼`);
    },

    // --- 6. å¯†ç ä¸å¤‡ä»½ ---
    changePass() {
        const na = document.getElementById('newAdmin').value;
        const nv = document.getElementById('newView').value;
        if(confirm('ç¡®å®šä¿®æ”¹å¯†ç ï¼Ÿ')) {
            fetch(this.api, { method:'POST', body:JSON.stringify({ action:'change_pass', password:this.token, newAdminPass:na, newViewPass:nv }) })
            .then(r=>r.json()).then(j=>{ if(j.success) alert('ä¿®æ”¹æˆåŠŸ'); });
        }
    },
    downloadJSON() {
        const b = new Blob([JSON.stringify(this.data)],{type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = 'duty_backup.json';
        a.click();
    }
};
</script>
</body>
</html>
