<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>å€¼ç­è¡¨æŸ¥çœ‹å™¨</title>
    <style>
        :root {
            --primary: #2563eb; 
            --primary-soft: #eff6ff;
            --bg: #f8fafc; 
            --surface: #ffffff; 
            --border: #e2e8f0;
            --text-main: #0f172a; 
            --text-sub: #64748b;
            --accent-red: #ef4444; 
            --accent-orange: #f97316;
            --today-dot: #2563eb;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- é¡¶éƒ¨æ ‡é¢˜æ  --- */
        ã€‚app-header {
            text-align: center;
            padding: 15px;
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
            background: white;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            letter-spacing: 1px;
        }
        ã€‚clickable-title { cursor: pointer; transition: opacity 0.2s; }
        .clickable-title:active { opacity: 0.6; }

        /* --- å¸ƒå±€å®¹å™¨ --- */
        .main-container {
            display: flex;
            flex: 1;
            padding: 24px;
            gap: 24px;
            max-width: 1280px;
            margin: 0 auto;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* --- å·¦ä¾§ä¿¡æ¯é¢æ¿ (Sidebar) --- */
        .info-panel {
            width: 340px;
            background: var(--surface);
            border-radius: 24px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid white;
            flex-shrink: 0;
        }

        .date-header {
            background: var(--surface);
            padding: 30px 24px 10px 24px;
            text-align: center;
        }
        .date-big { font-size: 80px; font-weight: 700; line-height: 1; color: var(--primary); letter-spacing: -2px; margin-bottom: 5px; }
        .date-full-box { display: flex; flex-direction: column; gap: 4px; }
        .week-day { font-size: 20px; font-weight: 600; color: var(--text-main); }
        .date-full { font-size: 14px; color: var(--text-sub); font-weight: 500; opacity: 0.8; }

        .info-content { 
            padding: 20px 24px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            flex: 1; 
            overflow-y: auto; 
        }
        
        .info-card {
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border);
        }
        .info-card:last-child { border-bottom: none; }
        
        .card-title {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        
        .duty-list { display: flex; flex-direction: column; gap: 8px; }
        .duty-row { display: flex; align-items: baseline; justify-content: space-between; font-size: 15px; }
        .duty-label { color: var(--text-sub); font-size: 14px; min-width: 60px; }
        .duty-name { font-weight: 600; color: var(--text-main); font-size: 16px; text-align: right; }

        .menu-text { font-size: 15px; color: var(--text-main); line-height: 1.6; font-weight: 500; white-space: pre-wrap; }
        .remark-text { font-size: 14px; color: var(--accent-orange); line-height: 1.5; white-space: pre-wrap; background: #fff7ed; padding: 10px; border-radius: 8px; }

        /* --- å³ä¾§æ—¥å†é¢æ¿ (Calendar) --- */
        .calendar-panel {
            flex: 1;
            background: var(--surface);
            border-radius: 24px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            border: 1px solid white;
            overflow: hidden;
        }

        .cal-toolbar {
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .month-selector { font-size: 20px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 15px; letter-spacing: -0.5px; }
        
        .cal-grid-wrapper { flex: 1; overflow-y: auto; padding: 0 20px 20px 20px; display: flex; flex-direction: column; }
        .cal-head { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 10px; }
        .cal-head div { text-align: center; font-size: 13px; font-weight: 600; color: #94a3b8; padding: 10px 0; }
        .cal-body { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; flex: 1; align-content: start; }
        
        .cal-cell {
            background: #f8fafc;
            border-radius: 12px;
            aspect-ratio: 1/0.8; 
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid transparent;
        }
        
        .cal-cell:hover { background: #f1f5f9; transform: scale(1.02); }
        .cal-cell.selected { border-color: var(--primary); background: var(--primary-soft); color: var(--primary); }
        
        .cal-cell.today-cell::after { 
            content: ''; position: absolute; top: 8px; right: 8px; 
            width: 6px; height: 6px; background: var(--today-dot); border-radius: 50%; 
        }
        
        .cal-cell.holiday { background: #fef2f2; }
        .cal-cell.holiday .date-num { color: var(--accent-red); }
        
        .date-num { font-size: 24px; font-weight: 700; color: var(--text-main); pointer-events: none; }
        .cal-cell.selected .date-num { color: var(--primary); }
        
        /* --- åº•éƒ¨åŠŸèƒ½æ  --- */
        .func-bar {
            padding: 16px 30px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .func-btn {
            flex: 1;
            max-width: 160px;
            padding: 12px 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-main);
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .func-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-soft); }
        .func-btn::before { font-size: 16px; font-weight: normal; }
        .btn-query::before { content: 'ğŸ”'; }
        .btn-predict::before { content: 'ğŸ”®'; }
        .btn-month::before { content: 'ğŸ“…'; }

        button.icon-btn { border: none; background: #f1f5f9; border-radius: 10px; width: 36px; height: 36px; cursor: pointer; color: var(--text-main); transition:0.2s; display: flex; align-items: center; justify-content: center; font-weight:bold; }
        button.icon-btn:hover { background: #e2e8f0; }

        /* --- æ¨¡æ€æ¡† --- */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(5px); padding: 20px; }
        .modal-card { background: white; width: 100%; max-width: 420px; max-height: 80vh; border-radius: 20px; padding: 24px; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); overflow-y: auto; }
        
        .modal-card.full-screen { max-width: 1200px; height: 90vh; max-height: 90vh; }

        /* æ•´æœˆè§†å›¾æ ·å¼ (Desktop) */
        .month-view-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; flex: 1; }
        .month-head { background: #f8fafc; padding: 10px; text-align: center; font-weight: bold; color: #64748b; font-size: 14px; display: grid; grid-template-columns: repeat(7, 1fr); }
        .month-head div { text-align: center; }
        .month-cell { background: white; min-height: 100px; padding: 8px; display: flex; flex-direction: column; gap: 4px; overflow: hidden; }
        .month-cell.holiday { background: #fef2f2; }
        .m-date-row { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 4px; font-size: 14px; }
        .m-name { font-size: 12px; padding: 2px 4px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 1px; }
        .m-name.l { background: #e0e7ff; color: #3730a3; }
        .m-name.f { background: #fce7f3; color: #9d174d; }
        .m-name.m { background: #dcfce7; color: #166534; }
        .m-remark { font-size: 10px; color: #c2410c; border-top: 1px dashed #e2e8f0; margin-top: auto; padding-top: 2px; }

        /* --- ç§»åŠ¨ç«¯é€‚é… (é‡ç‚¹ä¿®å¤) --- */
        @media (max-width: 768px) {
            body { height: auto; overflow-y: auto; }
            .app-header { font-size: 18px; padding: 12px; position: sticky; top: 0; z-index: 100; }
            .main-container { flex-direction: column; padding: 10px; gap: 15px; height: auto; overflow: visible; display: block; }
            .info-panel { width: 100%; max-height: none; height: auto; border-radius: 16px; padding: 0; margin-bottom: 15px; }
            .date-header { padding: 15px; border-right: none; border-bottom: 1px dashed var(--border); display: flex; flex-direction: row; justify-content: center; align-items: baseline; gap: 10px; }
            .date-big { font-size: 36px; margin: 0; }
            .week-day { font-size: 16px; }
            .date-full { display: inline-block; font-size: 13px; margin-left: 5px; } 
            .info-content { padding: 15px; height: auto; }
            .calendar-panel { width: 100%; border-radius: 16px; flex: none; height: auto; overflow: visible; }
            .cal-toolbar { padding: 10px 12px; }
            .cal-grid-wrapper { padding: 0 8px 8px 8px; overflow: visible; height: auto; }
            .month-selector { font-size: 15px; gap: 8px; }
            .cal-body { gap: 4px; } 
            .cal-cell { aspect-ratio: unset; height: 34px; border-radius: 6px; }
            .date-num { font-size: 16px; }
            .cal-cell.today-cell::after { top: 3px; right: 3px; width: 4px; height: 4px; }
            .cal-head { margin-bottom: 5px; }
            .cal-head div { padding: 5px 0; font-size: 11px; }
            .func-bar { padding: 10px; gap: 10px; }
            .func-btn { font-size: 13px; padding: 10px 0; }

            /* --- æ•´æœˆè§†å›¾ç§»åŠ¨ç«¯é€‚é… (å¼ºåˆ¶ç½‘æ ¼ + å°å­—ä½“) --- */
            .modal-card.full-screen { 
                padding: 10px; /* å‡å°‘æ¨¡æ€æ¡†å†…è¾¹è· */
                max-width: 100vw;
                height: 90vh;
                border-radius: 12px;
            }
            .month-head {
                font-size: 12px;
                padding: 5px 0;
            }
            .month-view-grid { 
                /* å¼ºåˆ¶ç»´æŒ 7 åˆ—ç½‘æ ¼å¸ƒå±€ */
                grid-template-columns: repeat(7, 1fr); 
                gap: 1px; 
                background: #cbd5e1; /* ç½‘æ ¼çº¿é¢œè‰²åŠ æ·±ä¸€ç‚¹ */
                border: 1px solid #cbd5e1;
            }
            .month-cell { 
                min-height: 55px; /* å‡å°å•å…ƒæ ¼é«˜åº¦ */
                padding: 2px;     /* æçª„å†…è¾¹è· */
                border-radius: 0; 
                border: none;
                gap: 1px;
            }
            .m-date-row { 
                font-size: 10px; /* æ—¥æœŸå°å­— */
                margin-bottom: 2px;
                border-bottom: none;
                padding-bottom: 0;
            }
            .m-name { 
                font-size: 9px;   /* å§“åè¶…å°å­— */
                padding: 1px 2px; /* ç´§å‡‘å†…è¾¹è· */
                line-height: 1.1;
                margin-bottom: 1px;
                border-radius: 2px;
            }
            .m-remark {
                font-size: 8px;   /* å¤‡æ³¨æå°å­— */
                line-height: 1.1;
                padding-top: 1px;
                white-space: nowrap; /* å¤‡æ³¨ä¸æ¢è¡Œï¼Œè¶…é•¿æˆªæ–­ */
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }

        /* ç™»å½•å±‚ */
        #loginOverlay { position: fixed; inset: 0; background: #f8fafc; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center; width: 320px; border: 1px solid var(--border); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="margin-top:0; color:var(--primary); font-size:20px; margin-bottom:20px;">å€¼ç­è¡¨æŸ¥çœ‹å™¨</h2>
        <input type="password" id="loginPass" placeholder="è¾“å…¥æŸ¥çœ‹å¯†ç " style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:10px; margin-bottom:15px; text-align:center; font-size:16px; outline:none;" onkeydown="if(event.key==='Enter') app.login()">
        <button onclick="app.login()" style="width:100%; background:var(--primary); color:white; border:none; padding:12px; border-radius:10px; font-weight:600; cursor:pointer; font-size:16px;">è¿›å…¥ç³»ç»Ÿ</button>
        <div id="loginMsg" style="color:#ef4444; font-size:12px; margin-top:15px; min-height:16px;"></div>
    </div>
</div>

<div class="app-header">
    <span class="clickable-title" onclick="app.openAbout()">å€¼ç­è¡¨æŸ¥çœ‹å™¨ (V2.38)</span>
</div>

<div class="main-container">
    <div class="info-panel">
        <div class="date-header">
            <div class="date-big" id="sideDay">--</div>
            <div class="date-full-box">
                <span class="week-day" id="sideWeek">æ˜ŸæœŸ-</span>
                <span class="date-full" id="sideFullDate">---- å¹´ -- æœˆ</span>
            </div>
        </div>
        <div class="info-content">
            <div class="info-card">
                <div class="card-title">å½“æ—¥å€¼ç­</div>
                <div class="duty-list">
                    <div class="duty-row"><span class="duty-label">å¸¦ç­é¢†å¯¼</span><span class="duty-name" id="sideLeader">-</span></div>
                    <div class="duty-row"><span class="duty-label">å¥³å€¼ç­å‘˜</span><span class="duty-name" id="sideFemale">-</span></div>
                    <div class="duty-row"><span class="duty-label">ç”·å€¼ç­å‘˜</span><span class="duty-name" id="sideMale">-</span></div>
                </div>
            </div>
            <div class="info-card">
                <div class="card-title">å½“æ—¥èœè°±</div>
                <div class="menu-text" id="sideMenu">æš‚æ— ä¿¡æ¯</div>
            </div>
            <div class="info-card" id="remarkCard" style="display:none">
                <div class="card-title">å¤‡æ³¨äº‹é¡¹</div>
                <div class="remark-text" id="sideRemark"></div>
            </div>
            <div class="info-card" id="noticeCard" style="display:none;">
                <div class="card-title" style="color:#c2410c">å…¬å‘Š</div>
                <div class="menu-text" id="sideNotice" style="color:#c2410c; font-size:13px; background:#fff7ed; padding:8px; border-radius:6px;"></div>
            </div>
        </div>
    </div>

    <div class="calendar-panel">
        <div class="cal-toolbar">
            <button class="icon-btn" onclick="app.goToday()" title="å›åˆ°ä»Šå¤©">ä»Š</button>
            <div class="month-selector">
                <button class="icon-btn" onclick="app.changeMonth(-1)" style="width:32px; height:32px;">â—€</button>
                <span id="calTitle" style="min-width:120px; text-align:center;">---- / --</span>
                <button class="icon-btn" onclick="app.changeMonth(1)" style="width:32px; height:32px;">â–¶</button>
            </div>
            <div style="width:36px"></div> 
        </div>
        
        <div class="cal-grid-wrapper">
            <div class="cal-head"><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div><div>æ—¥</div></div>
            <div class="cal-body" id="calGrid"></div>
        </div>

        <div class="func-bar">
            <button class="func-btn btn-query" onclick="app.openFeature('query')">å€¼ç­æŸ¥è¯¢</button>
            <button class="func-btn btn-predict" onclick="app.openFeature('predict')">å€¼ç­é¢„ä¼°</button>
            <button class="func-btn btn-month" onclick="app.openMonthView()">æ•´æœˆè§†å›¾</button>
        </div>
    </div>
</div>

<div id="featModal" class="modal-overlay">
    <div class="modal-card" id="featCard">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
            <b style="font-size:18px; color:var(--text-main);" id="modalTitle">åŠŸèƒ½</b>
            <span style="cursor:pointer; font-size:24px; color:#cbd5e1; line-height:1;" onclick="document.getElementById('featModal').style.display='none'">Ã—</span>
        </div>
        
        <div id="content_query" class="lab-content" style="display:none;">
            <div style="display:flex; gap:12px; margin-bottom:20px;">
                <input id="sInput" placeholder="è¾“å…¥å§“åæŸ¥æ‰¾" style="flex:1; padding:12px; border:1px solid #e2e8f0; border-radius:10px; outline:none; font-size:14px;" onkeydown="if(event.key==='Enter') app.search()">
                <button style="background:var(--primary); color:white; border:none; padding:0 24px; border-radius:10px; cursor:pointer; font-weight:600;" onclick="app.search()">æœç´¢</button>
            </div>
            <div id="icsContainer"></div>
            <div id="sResult" style="max-height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;"></div>
        </div>

        <div id="content_predict" class="lab-content" style="display:none;">
            <p style="font-size:13px; color:#c2410c; background:#fff7ed; padding:12px; border-radius:10px; margin-top:0; line-height:1.5;">âš ï¸ ä»…ä¾›å‚è€ƒï¼šåŸºäºå·²å‘å¸ƒå€¼ç­è¡¨æœ€åä¸€æ—¥äººå‘˜æ¨ç®—ã€‚</p>
            <div style="display:flex; gap:12px; margin:20px 0;">
                <input id="pInput" placeholder="è¾“å…¥å§“å" style="flex:1; padding:12px; border:1px solid #e2e8f0; border-radius:10px; outline:none;" onkeydown="if(event.key==='Enter') app.predict()">
                <button style="background:var(--primary); color:white; border:none; padding:0 24px; border-radius:10px; cursor:pointer; font-weight:600;" onclick="app.predict()">æ¨ç®—</button>
            </div>
            <div id="pResult"></div>
        </div>
        
        <div id="content_month" class="lab-content" style="display:none; height:100%; flex-direction:column;">
             <div class="month-head">
                 <div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div><div>æ—¥</div>
             </div>
             <div class="month-view-grid" id="monthViewGrid" style="overflow-y:auto;"></div>
        </div>

        <div id="content_wip" class="lab-content" style="display:none; text-align:center; padding:30px; color:#94a3b8;">
            åŠŸèƒ½æœªå¼€å¯
        </div>
    </div>
</div>

<div id="aboutModal" class="modal-overlay">
    <div class="modal-card" style="max-height: 80vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <b style="font-size:18px;">æ›´æ–°æ—¥å¿—</b>
            <span style="font-size:24px; cursor:pointer; color:#94a3b8;" onclick="document.getElementById('aboutModal').style.display='none'">Ã—</span>
        </div>
        <div id="versionTimeline" style="overflow-y:auto; flex:1;"></div>
    </div>
</div>

<script>
window.onerror = function(msg) { document.getElementById('loginMsg').innerText = "ç³»ç»ŸåŠ è½½é”™è¯¯: " + msg; };

window.app = {
    api: '/api',
    data: { schedules:{}, holidays:{}, labConfig:{}, versions:[] },
    y: new Date().getFullYear(), m: new Date().getMonth()+1,
    selectedDate: null, 
    currentSearchResults: [],

    async login() {
        const p = document.getElementById('loginPass').value;
        if(!p) return;
        document.getElementById('loginMsg').innerText = "éªŒè¯ä¸­...";
        try {
            const res = await fetch(this.api, { method:'POST', body:JSON.stringify({ action:'login', password:p }) });
            const json = await res.json();
            if(res.status === 200) {
                this.data = json.data || {};
                ['schedules','holidays'].forEach(k=>{if(!this.data[k])this.data[k]={}});
                if(!this.data.labConfig) this.data.labConfig = {switches:{query:true,menu:true,predict:true}, dailyMenus:{}};
                if(!this.data.labConfig.dailyMenus) this.data.labConfig.dailyMenus = {};
                if(!this.data.versions) this.data.versions = [];
                
                document.getElementById('loginOverlay').style.display = 'none';
                
                const now = new Date();
                this.selectedDate = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0');
                
                this.renderCal();
                this.updateSidePanel();
            } else { document.getElementById('loginMsg').innerText = "å¯†ç é”™è¯¯"; }
        } catch(e) { document.getElementById('loginMsg').innerText = "ç½‘ç»œå¼‚å¸¸"; }
    },

    renderCal() {
        document.getElementById('calTitle').innerText = this.y + ' å¹´ ' + this.m + ' æœˆ';
        const grid = document.getElementById('calGrid'); grid.innerHTML = '';
        
        const firstDay = new Date(this.y, this.m-1, 1);
        const daysInMonth = new Date(this.y, this.m, 0).getDate();
        const startEmpty = (firstDay.getDay() + 6) % 7; 

        const todayStr = new Date().toISOString().split('T')[0];
        const hList = this.data.holidays[String(this.y)] || [];

        for(let i=0; i<startEmpty; i++) grid.innerHTML += '<div style="background:transparent"></div>';

        for(let d=1; d<=daysInMonth; d++) {
            const ds = this.y+'-'+String(this.m).padStart(2,'0')+'-'+String(d).padStart(2,'0');
            const isH = hList.includes(ds);
            const isSelected = this.selectedDate === ds;
            
            let html = '<div class="date-num">'+d+'</div>';

            const div = document.createElement('div');
            div.className = 'cal-cell '+(isSelected?'selected':'')+' '+(isH?'holiday':'')+' '+(ds===todayStr?'today-cell':'');
            div.innerHTML = html;
            div.onclick = () => {
                this.selectedDate = ds;
                this.renderCal();
                this.updateSidePanel();
            };
            grid.appendChild(div);
        }
    },

    updateSidePanel() {
        if(!this.selectedDate) return;
        const [y, m, d] = this.selectedDate.split('-');
        const dateObj = new Date(this.y, parseInt(m)-1, parseInt(d));
        const weekDays = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
        const weekDay = weekDays[dateObj.getDay()];
        
        document.getElementById('sideDay').innerText = parseInt(d);
        document.getElementById('sideWeek').innerText = weekDay;
        document.getElementById('sideFullDate').innerText = y + ' å¹´ ' + parseInt(m) + ' æœˆ';

        const s = this.data.schedules[this.selectedDate] || {};
        document.getElementById('sideLeader').innerText = s.leader || '-';
        document.getElementById('sideFemale').innerText = s.female || '-';
        document.getElementById('sideMale').innerText = s.male || '-';

        const menus = this.data.labConfig.dailyMenus || {};
        const menuContent = menus[this.selectedDate] || "å½“æ—¥æš‚æ— èœè°±ä¿¡æ¯";
        document.getElementById('sideMenu').innerText = menuContent;

        const remEl = document.getElementById('remarkCard');
        if(s.remark) {
            remEl.style.display = 'block';
            document.getElementById('sideRemark').innerText = s.remark;
        } else {
            remEl.style.display = 'none';
        }

        const notEl = document.getElementById('noticeCard');
        if(this.data.notice) {
            notEl.style.display = 'block';
            document.getElementById('sideNotice').innerText = this.data.notice;
        } else {
            notEl.style.display = 'none';
        }
    },

    openMonthView() {
        const modal = document.getElementById('featModal');
        const card = document.getElementById('featCard');
        card.classList.add('full-screen');
        
        modal.style.display = 'flex';
        document.getElementById('modalTitle').innerText = this.y+'å¹´'+this.m+'æœˆ å…¨æ™¯è§†å›¾';
        
        document.querySelectorAll('.lab-content').forEach(el => el.style.display = 'none');
        const container = document.getElementById('content_month');
        container.style.display = 'flex';
        
        const grid = document.getElementById('monthViewGrid');
        grid.innerHTML = '';
        
        const firstDay = new Date(this.y, this.m-1, 1);
        const daysInMonth = new Date(this.y, this.m, 0).getDate();
        const startEmpty = (firstDay.getDay() + 6) % 7; 
        const hList = this.data.holidays[String(this.y)] || [];

        // æ— è®ºPCè¿˜æ˜¯ç§»åŠ¨ç«¯ï¼Œéƒ½æ¸²æŸ“ç©ºç™½æ ¼ä»¥ä¿æŒç½‘æ ¼å¯¹é½
        for(let i=0; i<startEmpty; i++) grid.innerHTML += '<div class="month-cell" style="background:#f8fafc;"></div>';

        for(let d=1; d<=daysInMonth; d++) {
            const ds = this.y+'-'+String(this.m).padStart(2,'0')+'-'+String(d).padStart(2,'0');
            const s = this.data.schedules[ds] || {leader:'', female:'', male:'', remark:''};
            const isH = hList.includes(ds);
            
            const cell = document.createElement('div');
            cell.className = 'month-cell '+(isH?'holiday':'');
            cell.innerHTML = 
                '<div class="m-date-row">' +
                    '<span>'+d+'æ—¥</span>' +
                    (isH?'<span style="color:red">ä¼‘</span>':'') +
                '</div>' +
                '<div class="m-name l">'+(s.leader||'-')+'</div>' +
                '<div class="m-name f">'+(s.female||'-')+'</div>' +
                '<div class="m-name m">'+(s.male||'-')+'</div>' +
                (s.remark ? '<div class="m-remark">'+s.remark+'</div>' : '');
            grid.appendChild(cell);
        }
    },

    openFeature(feat) {
        if (feat === 'predict') {
            const warningText = "ã€é¢„ä¼°çŸ¥æ™“ç¡®è®¤ã€‘\n\nè¯¥é¢„ä¼°åŸºäºå·²å‘å¸ƒå€¼ç­è¡¨æœ€åä¸€æ—¥äººå‘˜æ¨ç®—ï¼Œæœªæ¥å˜åŒ–æ— æ³•é¢„ä¼°ï¼Œç»“æœä»…ä¾›å‚è€ƒã€‚\n\nåŒæ„åˆ™å¯ä»¥ä½¿ç”¨ï¼Œä¸åŒæ„åˆ™æ— æ³•ä½¿ç”¨ã€‚";
            if (!confirm(warningText)) return;
        }

        const switches = this.data.labConfig.switches || {query:true, menu:true, predict:true};
        const modal = document.getElementById('featModal');
        const card = document.getElementById('featCard');
        card.classList.remove('full-screen');
        
        const titles = { query: 'å€¼ç­æŸ¥è¯¢', predict: 'å€¼ç­é¢„ä¼°' };
        
        modal.style.display = 'flex';
        document.getElementById('modalTitle').innerText = titles[feat];
        
        document.querySelectorAll('.lab-content').forEach(el => el.style.display = 'none');
        
        if(!switches[feat]) {
            document.getElementById('content_wip').style.display = 'block';
            return;
        }

        document.getElementById('content_'+feat).style.display = 'block';
        if(feat === 'query') setTimeout(()=>document.getElementById('sInput').focus(), 100);
    },

    // --- Version Info Functions ---
    openAbout() {
        document.getElementById('aboutModal').style.display = 'flex';
        this.renderAbout();
    },
    
    renderAbout() {
        const list = this.data.versions || [];
        let html = '';
        if(list.length === 0) {
            html = '<div style="text-align:center; color:#94a3b8; padding:20px;">æš‚æ— æ›´æ–°è®°å½•</div>';
        } else {
            list.forEach(v => {
                html += '<div style="margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed #eee;">' +
                    '<div style="display:flex; justify-content:space-between; margin-bottom:5px;">' +
                        '<span style="background:var(--primary); color:white; padding:2px 6px; border-radius:4px; font-size:12px; font-weight:bold;">'+v.ver+'</span>' +
                        '<span style="color:#94a3b8; font-size:12px;">'+v.date+'</span>' +
                    '</div>' +
                    '<div style="font-size:14px; color:var(--text-main); white-space:pre-wrap; line-height:1.5;">'+v.desc+'</div>' +
                '</div>';
            });
        }
        document.getElementById('versionTimeline').innerHTML = html;
    },

    search() {
        const v = document.getElementById('sInput').value.trim();
        const r = document.getElementById('sResult'), icsDiv = document.getElementById('icsContainer');
        r.innerHTML = ''; icsDiv.innerHTML = '';
        if(!v) return;
        this.currentSearchResults = [];
        const weeks = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
        let count = 0;
        Object.keys(this.data.schedules || {}).sort().reverse().forEach(k => {
            const s = this.data.schedules[k];
            if(s.leader?.includes(v) || s.female?.includes(v) || s.male?.includes(v)) {
                this.currentSearchResults.push({date: k, data: s});
                const w = weeks[new Date(k).getDay()];
                const y = k.split('-')[0];
                const isH = (this.data.holidays[y]||[]).includes(k);
                
                r.innerHTML += 
                '<div style="padding:15px; background:#f8fafc; border-radius:12px; border:1px solid #f1f5f9;">' +
                    '<div style="font-weight:700; color:var(--text-main); font-size:15px; margin-bottom:5px; display:flex; justify-content:space-between;">' +
                        '<span>'+k+' <span style="font-weight:400; color:#94a3b8; font-size:13px; margin-left:5px;">'+w+'</span></span>' +
                        (isH ? '<span style="color:var(--accent-red); background:#fef2f2; padding:2px 6px; border-radius:4px; font-size:12px;">å‡</span>' : '') +
                    '</div>' +
                    '<div style="font-size:14px; color:#475569;">'+s.leader+' / '+s.female+' / '+s.male+'</div>' +
                '</div>';
                count++;
            }
        });
        if(this.currentSearchResults.length > 0) icsDiv.innerHTML = '<button style="width:100%; padding:12px; background:#10b981; color:white; border:none; border-radius:10px; margin-bottom:15px; cursor:pointer; font-weight:600;" onclick="app.addToCalendar()">ğŸ“… å¯¼å‡ºæ—¥å†</button>';
        if(count===0) r.innerHTML = '<div style="text-align:center;padding:30px;color:#cbd5e1">æ— è®°å½•</div>';
    },

    addToCalendar() {
        const now = new Date();
        const todayStr = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0');
        const targetList = this.currentSearchResults.filter(item => item.date >= todayStr);
        if(!targetList.length) return alert('æ— æœªæ¥å€¼ç­å¯å¯¼å‡º');

        let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//DutySystem//CN\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n";
        targetList.forEach(item => {
            const [y,m,d] = item.date.split('-'); 
            const nextDDate = new Date(y, m-1, parseInt(d)+1);
            const nextDStr = nextDDate.getFullYear()+String(nextDDate.getMonth()+1).padStart(2,'0')+String(nextDDate.getDate()).padStart(2,'0');
            const s = item.data;
            ics += 'BEGIN:VEVENT\nDTSTART;VALUE=DATE:'+item.date.replace(/-/g,'')+'\nDTEND;VALUE=DATE:'+nextDStr+'\nSUMMARY:å€¼ç­: '+s.leader+' '+s.female+' '+s.male+'\nDESCRIPTION:'+(s.remark||'')+'\nBEGIN:VALARM\nTRIGGER:-PT15H\nACTION:DISPLAY\nDESCRIPTION:å€¼ç­æé†’\nEND:VALARM\nEND:VEVENT\n';
        });
        ics += "END:VCALENDAR";
        const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([ics], {type:'text/calendar'})); link.download = "å€¼ç­è¡¨.ics"; link.click();
    },

    predict() {
        const name = document.getElementById('pInput').value.trim();
        if(!name) return;
        const resDiv = document.getElementById('pResult'); resDiv.innerHTML = 'è®¡ç®—ä¸­...';
        
        let type = null, pIdx = -1;
        ['leader','female','male'].forEach(t => { const idx = this.data.personnel[t].findIndex(p=>p.name===name); if(idx !== -1) { type = t; pIdx = idx; } });
        if(!type) { resDiv.innerHTML = '<div style="color:red;text-align:center;margin-top:10px;">æœªæ‰¾åˆ°äººå‘˜</div>'; return; }

        const dates = Object.keys(this.data.schedules).sort();
        if(!dates.length) { resDiv.innerHTML = 'æš‚æ— æ•°æ®'; return; }
        const lastDateStr = dates[dates.length-1];
        const [ly, lm, ld] = lastDateStr.split('-').map(Number);
        const lastDate = new Date(ly, lm-1, ld);
        
        const getOriginalName = (n, r) => {
            if(!r) return n;
            const regex = /ã€(?:æ¢|å¤‡)ã€‘\s*([^â†’]+)\s*â†’\s*([^\s]+)/g;
            let m; while((m=regex.exec(r))!==null) { if(m[2]===n) return m[1].trim(); }
            return n;
        };

        if(type === 'leader') {
            let lastW=null, lastH=null;
            for(let i=dates.length-1; i>=0; i--) {
                const d = dates[i], s = this.data.schedules[d], y = d.split('-')[0], isH = (this.data.holidays[y]||[]).includes(d);
                const o = getOriginalName(s.leader, s.remark);
                if(isH && !lastH) lastH = o;
                if(!isH && !lastW) lastW = o;
                if(lastH && lastW) break;
            }
            this.showDualPrediction(resDiv, type, pIdx, lastW, lastH, lastDate);
        } else {
            const s = this.data.schedules[lastDateStr];
            const lastVal = getOriginalName(type==='female'?s.female:s.male, s.remark);
            this.showSinglePrediction(resDiv, type, pIdx, lastVal, lastDate);
        }
    },
    
    showSinglePrediction(div, type, targetIdx, lastVal, startDate) {
        const list = this.data.personnel[type], lastIdx = list.findIndex(p=>p.name===lastVal);
        const startIdx = lastIdx === -1 ? 0 : (lastIdx + 1) % list.length;
        const f = this.sim(startDate, 365, ()=>true, list, startIdx, targetIdx);
        div.innerHTML = '<div style="margin-top:15px; border-radius:10px; background:#f8fafc; padding:15px;"><div style="color:#64748b; font-size:13px; margin-bottom:5px;">æœªæ¥å€¼ç­ (ä¸åˆ†èŠ‚å‡æ—¥)</div><div style="color:var(--primary); font-weight:700; font-size:16px;">'+(f.date||f.err)+'</div></div>';
    },
    showDualPrediction(div, type, targetIdx, lastW, lastH, startDate) {
        const list = this.data.personnel.leader;
        const idxW = lastW ? (list.findIndex(p=>p.name===lastW)+1)%list.length : 0;
        const resW = this.sim(startDate, 180, (d, isH) => !isH, list, idxW, targetIdx);
        const idxH = lastH ? (list.findIndex(p=>p.name===lastH)+1)%list.length : 0;
        const resH = this.sim(startDate, 365, (d, isH) => isH, list, idxH, targetIdx);
        div.innerHTML = '<div style="display:flex; gap:12px; margin-top:15px;"><div style="flex:1; background:#f8fafc; padding:15px; border-radius:10px;"><div style="font-size:13px; color:#64748b; margin-bottom:5px;">å¹³æ—¥å¸¦ç­</div><div style="color:var(--primary); font-weight:700; font-size:16px;">'+(resW.date||resW.err)+'</div></div><div style="flex:1; background:#fff1f2; padding:15px; border-radius:10px;"><div style="font-size:13px; color:#be123c; margin-bottom:5px;">å‡æ—¥å¸¦ç­</div><div style="color:var(--accent-red); font-weight:700; font-size:16px;">'+(resH.date||resH.err)+'</div></div></div>';
    },
    sim(startDate, limit, cond, list, cIdx, tIdx) {
        let d=new Date(startDate); d.setDate(d.getDate()+1);
        let ptr=cIdx;
        for(let i=0;i<limit;i++){
            const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dn=String(d.getDate()).padStart(2,'0');
            const ds=y+'-'+m+'-'+dn, isH=(this.data.holidays[String(y)]||[]).includes(ds);
            if(cond(ds, isH)) {
                let p=list[ptr];
                while((p.skips||[]).some(s=>ds>=s.start&&ds<=s.end)){ ptr=(ptr+1)%list.length; p=list[ptr]; if(ptr===cIdx)return{err:'å…¨å‘˜æ‚¬åœ'}; }
                if(ptr===tIdx) return {date:ds};
                ptr=(ptr+1)%list.length;
            }
            d.setDate(d.getDate()+1);
        }
        return {err:'è¶…èŒƒå›´'};
    },

    changeMonth(d) { let m=this.m+d, y=this.y; if(m>12){m=1;y++}if(m<1){m=12;y--} this.y=y;this.m=m; this.renderCal(); },
    goToday() { this.y=new Date().getFullYear(); this.m=new Date().getMonth()+1; const now=new Date(); this.selectedDate=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0'); this.renderCal(); this.updateSidePanel(); }
};
window.onload=()=>app.login(); 
</script>
</body>
</html>
