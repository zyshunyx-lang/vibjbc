<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>å€¼ç­å…¬ç¤ºå¹³å°</title>
    <style>
        :root {
            --primary: #4f46e5; --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0;
            --text-main: #0f172a; --text-sub: #64748b;
            --leader-bg: #e0e7ff; --leader-text: #3730a3;
            --female-bg: #fce7f3; --female-text: #9d174d;
            --male-bg: #dcfce7;   --male-text: #166534;
            --holiday-bg: #fef2f2; --holiday-text: #dc2626;
            --notice-bg: #fff7ed; --notice-text: #c2410c;
            --today-ring: #f59e0b;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; padding-bottom: env(safe-area-inset-bottom); }
        #loginOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; padding: 20px; }
        .login-card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 320px; text-align: center; border: 1px solid var(--border); box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 15px; font-weight: 600; }
        .header { background: var(--surface); padding-top: calc(env(safe-area-inset-top) + 15px); padding-bottom: 10px; padding-left: 15px; padding-right: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; z-index: 50; }
        .brand { font-size: 18px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; white-space: nowrap; }
        .controls { display: flex; gap: 8px; align-items: center; }
        button.btn { background: white; border: 1px solid var(--border); padding: 6px 10px; border-radius: 6px; cursor: pointer; color: var(--text-main); font-size: 13px; font-weight: 500; display: flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
        button.btn:active { background: #f1f5f9; transform: scale(0.98); }
        .ticker-container { background: var(--notice-bg); color: var(--notice-text); height: 36px; display: flex; align-items: center; overflow: hidden; border-bottom: 1px solid #fed7aa; font-size: 13px; font-weight: 600; flex-shrink: 0; }
        .ticker-icon { width: 100px; flex-shrink: 0; background: var(--notice-bg); z-index: 10; border-right: 1px solid #fed7aa; height: 100%; display: flex; align-items: center; justify-content: center; box-shadow: 4px 0 8px rgba(0,0,0,0.02); }
        .ticker-content { white-space: nowrap; animation: scroll 25s linear infinite; padding-left: 100%; display: flex; align-items: center; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .cal-box { flex: 1; margin: 10px; background: white; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .cal-head { display: grid; grid-template-columns: repeat(7, 1fr); background: #f8fafc; border-bottom: 1px solid var(--border); }
        .cal-head div { padding: 8px 2px; text-align: center; font-size: 12px; font-weight: 600; color: var(--text-sub); }
        .cal-body { flex: 1; display: grid; grid-template-columns: repeat(7, 1fr); overflow-y: auto; gap: 1px; background: var(--border); }
        .cal-cell { background: white; min-height: 80px; padding: 4px; display: flex; flex-direction: column; gap: 2px; }
        .cal-cell.today { background: #fffbeb !important; box-shadow: inset 0 0 0 2px var(--today-ring); }
        .cal-cell.holiday { background: var(--holiday-bg); }
        .date-num { font-weight: 700; font-size: 12px; margin-bottom: 2px; display: flex; justify-content: space-between; color: #94a3b8; }
        .cal-cell.today .date-num { color: #f59e0b; }
        .cal-cell.holiday .date-num span { color: #dc2626; }
        .duty-tag { padding: 2px 4px; border-radius: 4px; font-size: 11px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; justify-content: center; }
        .tag-l { background: var(--leader-bg); color: var(--leader-text); }
        .tag-f { background: var(--female-bg); color: var(--female-text); }
        .tag-m { background: var(--male-bg); color: var(--male-text); }
        .remark { font-size: 10px; color: #c2410c; margin-top: auto; padding-top: 2px; border-top: 1px dashed #f1f5f9; white-space: pre-wrap; word-break: break-all; line-height: 1.2; }
        
        /* å®éªŒå®¤å¼¹çª— */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(2px); padding: 20px; }
        .modal-card { background: white; width: 100%; max-width: 400px; max-height: 80vh; border-radius: 16px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.1); box-sizing: border-box; overflow-y: auto; }
        .lab-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .lab-item { border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; transition: 0.2s; cursor: pointer; display: flex; align-items: center; gap: 15px; }
        .lab-item:hover { border-color: var(--primary); background: #f8fafc; }
        .lab-icon { font-size: 24px; }
        .lab-text h4 { margin: 0 0 4px 0; color: var(--text-main); }
        .lab-text p { margin: 0; font-size: 12px; color: var(--text-sub); }
        .lab-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        
        .back-btn { cursor: pointer; font-size: 24px; padding: 5px; }
        .lab-content { display: none; }
        .lab-content.active { display: block; }
        
        /* èœè°±æ ·å¼ */
        .menu-item { border-bottom: 1px dashed #eee; padding: 10px 0; }
        .menu-day { font-weight: bold; color: var(--primary); width: 50px; display: inline-block; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h3 style="margin-top:0; color:var(--primary)">ğŸ›¡ï¸ å€¼ç­å…¬ç¤ºå¹³å°</h3>
        <input type="password" id="loginPass" placeholder="è¯·è¾“å…¥æŸ¥çœ‹å¯†ç " style="width:100%; padding:12px; box-sizing:border-box; border:1px solid #ccc; border-radius:8px; text-align:center; font-size:16px;" onkeydown="if(event.key==='Enter') app.login()">
        <button class="login-btn" onclick="app.login()">è¿›å…¥ç³»ç»Ÿ</button>
        <div id="loginMsg" style="color:#ef4444; margin-top:15px; font-size:13px; min-height:20px;"></div>
    </div>
</div>

<header class="header">
    <div class="brand">ğŸ“… å€¼ç­è¡¨</div>
    <div class="controls">
        <button class="btn" onclick="app.goToday()">ä»Šå¤©</button>
        <div style="display:flex; gap:2px; flex: 2; justify-content: center;">
            <button class="btn" style="width:30px;" onclick="app.changeMonth(-1)">â—€</button>
            <button class="btn" style="flex:1; font-weight:bold; font-size:14px;" id="dateDisp"></button>
            <button class="btn" style="width:30px;" onclick="app.changeMonth(1)">â–¶</button>
        </div>
        <button class="btn" onclick="app.openLab()">ğŸ§ª å®éªŒå®¤</button>
    </div>
</header>

<div class="ticker-container" id="noticeBar" style="display:none">
    <div class="ticker-icon">ğŸ“¢ å…¬å‘Š</div>
    <div class="ticker-content" id="noticeText"></div>
</div>

<div class="cal-box">
    <div class="cal-head"><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div><div>æ—¥</div></div>
    <div class="cal-body" id="calGrid"></div>
</div>

<div id="labModal" class="modal-overlay">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
            <div id="labBack" class="back-btn" style="display:none;" onclick="app.labBack()">â†</div>
            <b style="font-size:16px;" id="labTitle">å®éªŒå®¤åŠŸèƒ½</b>
            <span style="cursor:pointer; padding:5px; font-size:20px;" onclick="document.getElementById('labModal').style.display='none'">Ã—</span>
        </div>
        
        <div id="labMenu" class="lab-grid">
            <div class="lab-item" onclick="app.openFeature('query')">
                <div class="lab-icon">ğŸ”</div>
                <div class="lab-text"><h4>å€¼ç­æŸ¥è¯¢</h4><p>æŒ‰å§“åæŸ¥æ‰¾å†å²æ’ç­</p></div>
            </div>
            <div class="lab-item" onclick="app.openFeature('menu')">
                <div class="lab-icon">ğŸ±</div>
                <div class="lab-text"><h4>æ¯å‘¨èœè°±</h4><p>æŸ¥çœ‹æœ¬å‘¨é£Ÿå ‚ä¾›åº”</p></div>
            </div>
            <div class="lab-item" onclick="app.openFeature('predict')">
                <div class="lab-icon">ğŸ”®</div>
                <div class="lab-text"><h4>å€¼ç­é¢„ä¼°</h4><p>æ¨ç®—æœªæ¥æ’ç­æ—¥æœŸ</p></div>
            </div>
        </div>

        <div id="feat_query" class="lab-content">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input id="sInput" placeholder="è¾“å…¥å§“å (ä¸¤å­—ååŠ ç©ºæ ¼)" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;" onkeydown="if(event.key==='Enter') app.search()">
                <button class="btn" style="background:var(--primary); color:white; border:none; padding:0 20px;" onclick="app.search()">æŸ¥è¯¢</button>
            </div>
            <div id="sResult" style="max-height:300px; overflow-y:auto;"></div>
        </div>

        <div id="feat_menu" class="lab-content">
            <div id="menuList"></div>
        </div>

        <div id="feat_predict" class="lab-content">
            <p style="color:#c2410c; font-size:12px; background:#fff7ed; padding:10px; border-radius:6px; margin-bottom:15px;">âš ï¸ ä»…ä¾›å‚è€ƒï¼šæ ¹æ®å½“å‰é˜Ÿåˆ—é¡ºåºæ¨ç®—ï¼Œå®é™…æ’ç­å¯èƒ½å› èŠ‚å‡æ—¥ã€è¯·å‡ç­‰å› ç´ è°ƒæ•´ã€‚</p>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input id="pInput" placeholder="è¾“å…¥å§“å" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;">
                <button class="btn" style="background:var(--primary); color:white; border:none; padding:0 20px;" onclick="app.predict()">é¢„ä¼°</button>
            </div>
            <div id="pResult" style="font-size:14px; color:#334155;"></div>
        </div>
        
        <div id="feat_wip" class="lab-content" style="text-align:center; padding:40px 0;">
            <div style="font-size:40px; margin-bottom:10px;">ğŸš§</div>
            <div style="color:#64748b;">è¯¥åŠŸèƒ½åå°æš‚æ—¶å…³é—­<br>æ­£åœ¨æ–½å·¥ä¸­...</div>
        </div>
    </div>
</div>

<script>
window.app = {
    api: '/api',
    data: { schedules:{}, holidays:{}, labConfig:{} },
    y: new Date().getFullYear(), m: new Date().getMonth()+1,

    async login() {
        const p = document.getElementById('loginPass').value;
        if(!p) return;
        document.getElementById('loginMsg').innerText = "æ­£åœ¨åŠ è½½æ•°æ®...";
        try {
            const res = await fetch(this.api, { method:'POST', body:JSON.stringify({ action:'login', password:p }) });
            const json = await res.json();
            if(res.status === 200) {
                this.data = json.data || {};
                if(!this.data.schedules) this.data.schedules = {};
                if(!this.data.labConfig) this.data.labConfig = {switches:{query:true,menu:true,predict:true}, menus:[]};
                document.getElementById('loginOverlay').style.display = 'none';
                this.render(); this.renderNotice();
            } else { document.getElementById('loginMsg').innerText = "å¯†ç é”™è¯¯"; }
        } catch(e) { document.getElementById('loginMsg').innerText = "ç½‘ç»œè¿æ¥å¤±è´¥"; }
    },

    render() {
        document.getElementById('dateDisp').innerText = `${this.y}-${String(this.m).padStart(2,'0')}`;
        const grid = document.getElementById('calGrid'); grid.innerHTML = '';
        const firstDay = new Date(this.y, this.m-1, 1);
        const daysInMonth = new Date(this.y, this.m, 0).getDate();
        const startEmpty = (firstDay.getDay() + 6) % 7;
        
        for(let i=0; i<startEmpty; i++) grid.innerHTML += `<div class="cal-cell" style="background:#f8fafc"></div>`;
        const todayStr = new Date().toISOString().split('T')[0];
        const hList = this.data.holidays[String(this.y)] || [];

        for(let d=1; d<=daysInMonth; d++) {
            const ds = `${this.y}-${String(this.m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const s = this.data.schedules[ds];
            const isH = hList.includes(ds);
            
            let html = `<div class="date-num"><span>${d}</span>${isH?'<span class="holiday-tag">å‡</span>':''}</div>`;
            if(s) {
                if(s.leader) html += `<div class="duty-tag tag-l">${s.leader}</div>`;
                if(s.female) html += `<div class="duty-tag tag-f">${s.female}</div>`;
                if(s.male) html += `<div class="duty-tag tag-m">${s.male}</div>`;
                if(s.remark) html += `<div class="remark">${s.remark}</div>`;
            }
            const div = document.createElement('div');
            div.className = `cal-cell ${ds===todayStr?'today':''} ${isH?'holiday':''}`;
            div.innerHTML = html; grid.appendChild(div);
        }
    },

    renderNotice() {
        const t = this.data.notice;
        if(t && t.trim()) {
            document.getElementById('noticeBar').style.display = 'flex';
            document.getElementById('noticeText').innerText = t;
        } else { document.getElementById('noticeBar').style.display = 'none'; }
    },

    // --- Lab Logic ---
    openLab() {
        document.getElementById('labModal').style.display = 'flex';
        this.labBack();
    },
    labBack() {
        document.getElementById('labMenu').style.display = 'grid';
        document.querySelectorAll('.lab-content').forEach(el => el.style.display = 'none');
        document.getElementById('labBack').style.display = 'none';
        document.getElementById('labTitle').innerText = 'å®éªŒå®¤åŠŸèƒ½';
    },
    openFeature(feat) {
        const switches = this.data.labConfig.switches || {query:true, menu:true, predict:true};
        document.getElementById('labMenu').style.display = 'none';
        document.getElementById('labBack').style.display = 'block';
        
        if (!switches[feat]) {
            document.getElementById('feat_wip').style.display = 'block';
            document.getElementById('labTitle').innerText = 'åŠŸèƒ½å…³é—­';
            return;
        }

        document.getElementById(`feat_${feat}`).style.display = 'block';
        
        if(feat === 'query') {
            document.getElementById('labTitle').innerText = 'å€¼ç­æŸ¥è¯¢';
            setTimeout(()=>document.getElementById('sInput').focus(), 100);
        } else if(feat === 'menu') {
            document.getElementById('labTitle').innerText = 'æœ¬å‘¨èœè°±';
            this.renderMenu();
        } else if(feat === 'predict') {
            document.getElementById('labTitle').innerText = 'å€¼ç­é¢„ä¼°';
        }
    },

    search() {
        const v = document.getElementById('sInput').value.trim();
        const r = document.getElementById('sResult'); r.innerHTML = '';
        if(!v) return;
        const weeks = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
        let count = 0;
        Object.keys(this.data.schedules || {}).sort().reverse().forEach(k => {
            const s = this.data.schedules[k];
            if(s.leader?.includes(v) || s.female?.includes(v) || s.male?.includes(v)) {
                const w = weeks[new Date(k).getDay()];
                const y = k.split('-')[0];
                const isH = (this.data.holidays[y]||[]).includes(k);
                r.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee;">
                    <div style="font-weight:bold; color:var(--primary)">${k} <span style="color:#666;font-weight:normal;font-size:13px;">${w}</span>${isH?' <span style="color:red;font-size:12px;">(å‡)</span>':''}</div>
                    <div style="font-size:13px; margin-top:4px; color:#334155;">
                        <span style="background:#f1f5f9;padding:1px 4px;">${s.leader===v?'å¸¦ç­':(s.female===v?'å¥³å€¼':'ç”·å€¼')}</span> åŒç»„:${s.leader}/${s.female}/${s.male}
                    </div>
                </div>`;
                count++;
            }
        });
        if(count===0) r.innerHTML = '<div style="text-align:center;padding:20px;color:#999">æ— è®°å½•</div>';
    },

    renderMenu() {
        const menus = this.data.labConfig.menus || [];
        const days = ['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”'];
        const html = days.map((d,i) => `
            <div class="menu-item">
                <span class="menu-day">${d}</span>
                <span>${menus[i] || 'æš‚æ— å®‰æ’'}</span>
            </div>
        `).join('');
        document.getElementById('menuList').innerHTML = html;
    },

    predict() {
        const name = document.getElementById('pInput').value.trim();
        if(!name) return;
        
        // ç®€å•é¢„ä¼°ç®—æ³•ï¼šåœ¨äººå‘˜åˆ—è¡¨ä¸­æ‰¾åˆ°ä½ç½®ï¼Œæ ¹æ®å¹³å‡é—´éš”æ¨ç®—
        // è¿™é‡Œä»…åšæ¼”ç¤ºï¼Œå®é™…éœ€ç»“åˆ Rules ç®—æ³•
        const resDiv = document.getElementById('pResult');
        
        // æ£€æŸ¥æ˜¯å¦åœ¨äººå‘˜åº“
        let foundType = null;
        ['leader','female','male'].forEach(t => {
            if(this.data.personnel[t].some(p=>p.name===name)) foundType = t;
        });

        if(!foundType) {
            resDiv.innerHTML = `<div style="color:red; text-align:center; margin-top:20px;">æœªæ‰¾åˆ°äººå‘˜ [${name}]</div>`;
            return;
        }

        resDiv.innerHTML = `<div style="text-align:center; margin-top:20px;">
            <div>äººå‘˜ç±»å‹ï¼š${foundType==='leader'?'å¸¦ç­é¢†å¯¼':(foundType==='female'?'å¥³å€¼ç­å‘˜':'ç”·å€¼ç­å‘˜')}</div>
            <div style="margin-top:10px; font-weight:bold;">é¢„è®¡ä¸‹æ¬¡å€¼ç­ï¼š</div>
            <div style="font-size:18px; color:var(--primary); margin-top:5px;">ä¸‹æœˆä¸Šæ—¬ (é¢„ä¼°)</div>
            <div style="font-size:12px; color:#94a3b8; margin-top:5px;">(ç²¾ç¡®ç®—æ³•å¼€å‘ä¸­)</div>
        </div>`;
    },

    changeMonth(d) { let m=this.m+d, y=this.y; if(m>12){m=1;y++}if(m<1){m=12;y--} this.y=y;this.m=m; this.render(); },
    goToday() { this.y=new Date().getFullYear(); this.m=new Date().getMonth()+1; this.render(); }
};
</script>
</body>
</html>
