<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€¼ç­å…¬ç¤ºå¹³å°</title>
    <style>
        :root {
            --primary: #4f46e5; --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0;
            --text-main: #0f172a; --text-sub: #64748b;
            --leader-bg: #e0e7ff; --leader-text: #3730a3;
            --female-bg: #fce7f3; --female-text: #9d174d;
            --male-bg: #dcfce7;   --male-text: #166534;
            --holiday-bg: #fef2f2; --holiday-text: #dc2626;
            --notice-bg: #fff7ed; --notice-text: #c2410c;
            --today-ring: #f59e0b;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* ç™»å½•å±‚ */
        #loginOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; }
        .login-card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 300px; text-align: center; border: 1px solid var(--border); }
        .login-btn { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; margin-top: 10px; }
        
        /* æ»šåŠ¨å…¬å‘Š */
        .ticker-container { background: var(--notice-bg); color: var(--notice-text); height: 36px; display: flex; align-items: center; overflow: hidden; border-bottom: 1px solid #fed7aa; font-size: 14px; font-weight: 500; }
        .ticker-icon { padding: 0 15px; background: var(--notice-bg); z-index: 10; font-weight: 800; box-shadow: 5px 0 10px rgba(255,247,237,1); }
        .ticker-content { white-space: nowrap; animation: scroll 20s linear infinite; padding-left: 100%; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* é¡¶éƒ¨æ  */
        .header { background: var(--surface); height: 60px; padding: 0 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 18px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        
        /* æ§åˆ¶æŒ‰é’® */
        .controls { display: flex; gap: 10px; }
        button.btn { background: white; border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; cursor: pointer; color: var(--text-sub); font-size: 14px; display: flex; align-items: center; gap: 5px; }
        button.btn:hover { background: #f1f5f9; color: var(--primary); }
        
        /* æ—¥å† */
        .cal-box { flex: 1; margin: 20px; background: white; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .cal-head { display: grid; grid-template-columns: repeat(7, 1fr); background: #f8fafc; border-bottom: 1px solid var(--border); }
        .cal-head div { padding: 12px; text-align: center; font-size: 13px; font-weight: 600; color: var(--text-sub); }
        .cal-body { flex: 1; display: grid; grid-template-columns: repeat(7, 1fr); overflow-y: auto; gap: 1px; background: var(--border); }
        .cal-cell { background: white; min-height: 100px; padding: 8px; display: flex; flex-direction: column; gap: 4px; }
        .cal-cell.today { background: #fffbeb; }
        .cal-cell.holiday { background: var(--holiday-bg); }
        .duty-tag { padding: 3px 6px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .tag-l { background: var(--leader-bg); color: var(--leader-text); }
        .tag-f { background: var(--female-bg); color: var(--female-text); }
        .tag-m { background: var(--male-bg); color: var(--male-text); }
        
        /* æœç´¢æ¡† */
        .search-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .search-card { background: white; width: 400px; max-height: 80vh; border-radius: 12px; display: flex; flex-direction: column; padding: 20px; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h3 style="margin-top:0; color:var(--primary)">ğŸ›¡ï¸ å€¼ç­å…¬ç¤ºå¹³å°</h3>
        <input type="password" id="loginPass" placeholder="è¯·è¾“å…¥æŸ¥çœ‹å¯†ç " style="width:100%; padding:10px; box-sizing:border-box; border:1px solid #ccc; border-radius:6px; text-align:center;">
        <button class="login-btn" onclick="app.login()">è¿›å…¥ç³»ç»Ÿ</button>
        <div id="loginMsg" style="color:red; margin-top:10px; font-size:13px;"></div>
    </div>
</div>

<header class="header">
    <div class="brand">ğŸ“… å€¼ç­å®‰æ’è¡¨</div>
    <div class="controls">
        <button class="btn" onclick="app.goToday()">å›åˆ°ä»Šå¤©</button>
        <div style="display:flex; align-items:center; gap:5px; background:#f1f5f9; padding:2px; border-radius:6px;">
            <button class="btn" style="border:none; background:transparent" onclick="app.changeMonth(-1)">â—€</button>
            <span id="dateDisp" style="font-weight:600; font-size:14px; width:80px; text-align:center;"></span>
            <button class="btn" style="border:none; background:transparent" onclick="app.changeMonth(1)">â–¶</button>
        </div>
        <button class="btn" onclick="document.getElementById('searchModal').style.display='flex'; setTimeout(()=>document.getElementById('sInput').focus(),100)">ğŸ” æœäºº</button>
    </div>
</header>

<div class="ticker-container" id="noticeBar" style="display:none">
    <div class="ticker-icon">ğŸ“¢ å…¬å‘Š</div>
    <div class="ticker-content" id="noticeText"></div>
</div>

<div class="cal-box">
    <div class="cal-head"><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div><div>æ—¥</div></div>
    <div class="cal-body" id="calGrid"></div>
</div>

<div id="searchModal" class="search-modal">
    <div class="search-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <span style="font-weight:bold">äººå‘˜æŸ¥è¯¢</span>
            <span style="cursor:pointer" onclick="document.getElementById('searchModal').style.display='none'">Ã—</span>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input id="sInput" placeholder="è¾“å…¥å§“å..." style="flex:1; padding:8px; border:1px solid #ccc; border-radius:6px;" onkeydown="if(event.key==='Enter') app.search()">
            <button class="btn" onclick="app.search()">æŸ¥è¯¢</button>
        </div>
        <div id="sResult" style="overflow-y:auto; flex:1;"></div>
    </div>
</div>

<script>
window.app = {
    api: '/.netlify/functions/api',
    data: { schedules:{}, holidays:{} },
    y: new Date().getFullYear(), m: new Date().getMonth()+1,

    async login() {
        const p = document.getElementById('loginPass').value;
        if(!p) return;
        document.getElementById('loginMsg').innerText = "æ­£åœ¨è·å–æ•°æ®...";
        try {
            const res = await fetch(this.api, { method:'POST', body:JSON.stringify({ action:'login', password:p }) });
            const json = await res.json();
            if(res.status === 200) {
                this.data = json.data || {};
                document.getElementById('loginOverlay').style.display = 'none';
                this.render();
                this.renderNotice();
            } else {
                document.getElementById('loginMsg').innerText = "å¯†ç é”™è¯¯";
            }
        } catch(e) { document.getElementById('loginMsg').innerText = "ç½‘ç»œé”™è¯¯"; }
    },

    render() {
        document.getElementById('dateDisp').innerText = `${this.y}-${String(this.m).padStart(2,'0')}`;
        const grid = document.getElementById('calGrid'); grid.innerHTML = '';
        const days = new Date(this.y, this.m, 0).getDate();
        const start = (new Date(this.y, this.m-1, 1).getDay() + 6) % 7;
        
        for(let i=0; i<start; i++) grid.innerHTML += `<div class="cal-cell" style="background:#f9fafb"></div>`;
        
        const today = new Date().toISOString().split('T')[0];
        const hList = this.data.holidays[this.y] || [];

        for(let d=1; d<=days; d++) {
            const ds = `${this.y}-${String(this.m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const s = this.data.schedules[ds];
            const isH = hList.includes(ds);
            
            let html = `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-weight:bold; color:${isH?'red':'#333'}">${d}</span>
                ${isH?'<span style="font-size:10px; color:red">ä¼‘</span>':''}
            </div>`;
            
            if(s) {
                if(s.leader) html += `<div class="duty-tag tag-l">${s.leader}</div>`;
                if(s.female) html += `<div class="duty-tag tag-f">${s.female}</div>`;
                if(s.male) html += `<div class="duty-tag tag-m">${s.male}</div>`;
                if(s.remark) html += `<div style="font-size:10px; color:#c2410c; margin-top:auto;">${s.remark}</div>`;
            }
            
            const div = document.createElement('div');
            div.className = `cal-cell ${ds===today?'today':''} ${isH?'holiday':''}`;
            div.innerHTML = html;
            grid.appendChild(div);
        }
    },

    renderNotice() {
        const t = this.data.notice;
        if(t) {
            document.getElementById('noticeBar').style.display = 'flex';
            document.getElementById('noticeText').innerText = t;
        }
    },

    search() {
        const v = document.getElementById('sInput').value.trim();
        const r = document.getElementById('sResult'); r.innerHTML = '';
        if(!v) return;
        Object.keys(this.data.schedules || {}).sort().reverse().forEach(k => {
            const s = this.data.schedules[k];
            if(s.leader===v || s.female===v || s.male===v) {
                r.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee">
                    <div style="color:var(--primary); font-weight:bold">${k}</div>
                    <div style="font-size:13px; color:#666">åŒç»„: ${s.leader} / ${s.female} / ${s.male}</div>
                </div>`;
            }
        });
        if(!r.innerHTML) r.innerHTML = '<div style="text-align:center; padding:20px; color:#999">æ— è®°å½•</div>';
    },

    changeMonth(d) {
        let nm = this.m + d; let ny = this.y;
        if(nm>12){nm=1;ny++} if(nm<1){nm=12;ny--}
        this.y=ny; this.m=nm; this.render();
    },
    goToday() { this.y=new Date().getFullYear(); this.m=new Date().getMonth()+1; this.render(); }
};
</script>
</body>
</html>
